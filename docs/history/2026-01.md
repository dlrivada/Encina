# January 2026 - Implementation History

This document captures the detailed implementation history for Encina during January 2026.

## Summary

January 2026 continues the v0.11.0 Testing Infrastructure milestone, building on December 2025's testing foundation.

| Category | Packages Updated | New Features | Tests Added |
|----------|-----------------|--------------|-------------|
| Testing Core | 3 | 6 phases complete | 57 |
| Testing WireMock | 1 | Refit + Webhooks | 147 |
| Testing TUnit | 1 | NativeAOT support | 56 |
| Testing Pact | 1 | CDC Testing | 118 |
| Testing FsCheck | 1 | Property-based testing | 75 |
| Dogfooding (#498) | 10+ | Test infrastructure refactoring | 428+ |
| Solution Filters | 16 | Complete test coverage per area | - |

---

## Week 1: January 1 (Testing Infrastructure)

### January 1 - Enhanced Testing Fixtures (Issue #444)

**Commits**: Phase 1 of Enhanced Testing Fixtures

**EncinaTestFixture Implementation**:

- Created `EncinaTestFixture` class with fluent builder pattern for test setup
- Added fake store configuration methods:
  - `WithMockedOutbox()` - Register FakeOutboxStore
  - `WithMockedInbox()` - Register FakeInboxStore
  - `WithMockedSaga()` - Register FakeSagaStore
  - `WithMockedScheduling()` - Register FakeScheduledMessageStore
  - `WithMockedDeadLetter()` - Register FakeDeadLetterStore
  - `WithAllMockedStores()` - Enable all fake stores at once
- Added handler registration:
  - `WithHandler<THandler>()` - Register request or notification handler
- Added service registration:
  - `WithService<TService>(instance)` - Register singleton instance
  - `WithService<TService, TImplementation>()` - Register with implementation type
- Added configuration:
  - `WithConfiguration(Action<EncinaConfiguration>)` - Custom Encina configuration
- Added test execution:
  - `SendAsync<TResponse>(IRequest<TResponse>)` - Send request and return context
  - `PublishAsync(INotification)` - Publish notification and return context
- Properties for store access: `Outbox`, `Inbox`, `SagaStore`, `ScheduledMessageStore`, `DeadLetterStore`
- `ClearStores()` for test isolation between tests
- Implements `IDisposable`, `IAsyncDisposable`, `IAsyncLifetime` for xUnit

**EncinaTestContext Implementation**:

- Created `EncinaTestContext<TResponse>` for chainable assertions after `SendAsync()`
- Result assertions:
  - `ShouldSucceed()` - Assert result is success (Right)
  - `ShouldFail()` - Assert result is error (Left)
  - `ShouldSucceedWith(Action<TResponse>)` - Assert success and verify value
  - `ShouldFailWith(Action<EncinaError>)` - Assert error and verify details
  - `ShouldSatisfy(Action<TResponse>)` - Custom verification
- Outbox assertions:
  - `OutboxShouldContain<TNotification>()` - Verify notification in outbox
  - `OutboxShouldBeEmpty()` - Verify no outbox messages
  - `OutboxShouldContainExactly(count)` - Verify exact message count
- Saga assertions:
  - `SagaShouldBeStarted<TSaga>()` - Verify saga was started
- Value extraction:
  - `GetSuccessValue()` - Get success value or throw
  - `GetErrorValue()` - Get error value or throw
- Properties:
  - `Result` - Access raw `Either<EncinaError, TResponse>`
  - `And` - Fluent chaining (returns `this`)
  - `IsSuccess`, `IsError` - Check result state
- Implicit conversion to `Either<EncinaError, TResponse>`

**Tests Created**:

- `EncinaTestFixtureTests.cs` - 17 unit tests for EncinaTestFixture
- `EncinaTestContextTests.cs` - 17 unit tests for EncinaTestContext
- All 179 tests passing

**Files Created/Modified**:

- `src/Encina.Testing/EncinaTestFixture.cs` (NEW - 427 lines)
- `src/Encina.Testing/EncinaTestContext.cs` (NEW - 341 lines)
- `src/Encina.Testing/Encina.Testing.csproj` (MODIFIED - added Encina.Testing.Fakes reference)
- `tests/Encina.Testing.Tests/EncinaTestFixtureTests.cs` (NEW - 285 lines)
- `tests/Encina.Testing.Tests/EncinaTestContextTests.cs` (NEW - 333 lines)

**Design Decisions**:

- `EncinaTestContext` constructor is internal - use `fixture.SendAsync()` to create
- Auto-build on first service access (no need to call `Build()` explicitly)
- Reference to `Encina.Testing.Fakes` for fake store implementations
- Fluent API returns `this` for method chaining

### January 1 (cont.) - Phase 3: Saga Time-Travel Testing (Issue #444)

**Time-Travel in EncinaTestFixture**:

- `WithFakeTimeProvider()` - Configure FakeTimeProvider with current time
- `WithFakeTimeProvider(DateTimeOffset)` - Configure FakeTimeProvider with specific start time
- `AdvanceTimeBy(TimeSpan)` - Advance fake time by duration
- `AdvanceTimeByMinutes(int)`, `AdvanceTimeByHours(int)`, `AdvanceTimeByDays(int)` - Convenience methods
- `SetTimeTo(DateTimeOffset)` - Set fake time to specific value
- `GetCurrentTime()` - Get current fake time
- `TimeProvider` property for direct FakeTimeProvider access

**Time-Travel in EncinaTestContext**:

- `ThenAdvanceTimeBy(TimeSpan)` - Chainable time advancement
- `ThenAdvanceTimeByMinutes(int)`, `ThenAdvanceTimeByHours(int)`, `ThenAdvanceTimeByDays(int)`
- `ThenSetTimeTo(DateTimeOffset)` - Set time in chainable context

**Saga State Assertions**:

- `SagaShouldHaveTimedOut<TSaga>()` - Assert saga timed out
- `SagaShouldHaveCompleted<TSaga>()` - Assert saga completed
- `SagaShouldBeCompensating<TSaga>()` - Assert saga is compensating
- `SagaShouldHaveFailed<TSaga>()` - Assert saga failed

**Tests Created**:

- 12 new tests for time-travel functionality in EncinaTestFixtureTests
- 8 new tests for time-travel context chaining in EncinaTestContextTests
- 5 new tests for saga state assertions

### January 1 (cont.) - Phase 5: Snapshot Testing Enhancements (Issue #444)

**New Snapshot Helpers in EncinaVerify**:

- `PrepareHandlerResult<TRequest, TResponse>()` - Complete handler result with request context
- `PrepareSagaStates(IEnumerable<ISagaState>)` - Multiple saga states sorted by ID
- `PrepareValidationError(EncinaError)` - Validation error with code detection
- `PrepareTestScenario<TResponse>()` - Combined result + outbox + sagas snapshot

**New Extension Methods**:

- `EncinaTestContextExtensions.ForVerify<TResponse>()` - Either → snapshot-ready object
- `EncinaTestContextExtensions.SuccessForVerify<TResponse>()` - Success value for verification
- `EncinaTestContextExtensions.ErrorForVerify<TResponse>()` - Error for verification

**New Snapshot Types**:

- `HandlerResultSnapshot<TRequest, TResponse>` - Handler result with request
- `ErrorSnapshot` - Error with message and code
- `ValidationErrorSnapshot` - Validation error with detection flag
- `TestScenarioSnapshot<TResponse>` - Complete test scenario

### January 1 (cont.) - Phase 6: Contract Testing Enhancements (Issue #444)

**New Architecture Rules in EncinaArchitectureRules**:

- `RequestsShouldFollowNamingConvention()` - Requests end with Command/Query
- `AggregatesShouldFollowPattern(namespace)` - Aggregates should be sealed
- `ValueObjectsShouldBeSealed()` - Value objects should be sealed
- `SagasShouldBeSealed()` - Sagas should be sealed
- `StoreImplementationsShouldBeSealed()` - Store implementations should be sealed
- `EventHandlersShouldBeSealed()` - Event handlers should be sealed

**New Builder Methods in EncinaArchitectureRulesBuilder**:

- `EnforceRequestNaming()` - Enforce request naming convention
- `EnforceSealedAggregates(namespace)` - Enforce sealed aggregates
- `EnforceSealedValueObjects()` - Enforce sealed value objects
- `EnforceSealedSagas()` - Enforce sealed sagas
- `EnforceSealedEventHandlers()` - Enforce sealed event handlers

**Updated ApplyAllStandardRules()**:

- Now includes `EnforceSealedEventHandlers()` (saga rules moved to opt-in)

**New ApplyAllSagaRules()**:

- Opt-in method for saga-specific rules
- Includes `EnforceSealedSagas()` and `EnforceSealedSagaData()`

**Tests**: All 202 tests passing

### January 1 (cont.) - WireMock.NET Integration Enhancement (Issue #164)

**EncinaRefitMockFixture<TApiClient> Implementation**:

- Generic xUnit fixture for testing Refit API clients with WireMock
- Auto-configured Refit client via `CreateClient()` method
- HTTP method stubs: `StubGet()`, `StubPost()`, `StubPut()`, `StubPatch()`, `StubDelete()`
- Generic stub: `Stub()` with method, path, request configuration, response
- Error simulation: `StubError()` with status code and optional error response
- Delay simulation: `StubDelay()` for timeout testing
- Request verification: `VerifyCallMade()`, `VerifyNoCallsMade()`
- Server management: `Reset()`, `ResetRequestHistory()`
- Implements `IAsyncLifetime` for xUnit integration

**WebhookTestingExtensions Implementation**:

- Extension methods for EncinaWireMockFixture for webhook testing
- `SetupWebhookEndpoint()` - Generic webhook endpoint (POST requests)
- `SetupOutboxWebhook()` - Outbox pattern webhook (JSON POST, default path `/webhooks/outbox`)
- `SetupWebhookFailure()` - Simulate webhook failures with status code and error message
- `SetupWebhookTimeout()` - Simulate webhook timeouts with configurable delay
- `VerifyWebhookReceived()` - Verify webhook was called with expected count
- `VerifyNoWebhooksReceived()` - Verify no webhooks were sent
- `GetReceivedWebhooks()` - Get all received webhook requests
- `GetReceivedWebhookBodies<T>()` - Deserialize webhook bodies to typed objects

**Test Files Created**:

- `EncinaRefitMockFixtureTests.cs` - 25 tests for Refit fixture functionality
- `WebhookTestingExtensionsTests.cs` - 27 tests for webhook extensions
- `FaultSimulationTests.cs` - 14 tests for fault simulation
- `SequenceTests.cs` - 10 tests for request sequencing
- `GuardClauseTests.cs` - 34 tests for argument validation

**Test Coverage**:

- 147 total tests in Encina.Testing.WireMock.Tests
- Unit tests: All fixture methods tested
- Fault simulation: EmptyResponse, MalformedResponse, Timeout, HTTP error codes
- Sequence tests: Request ordering, timestamp capture, workflow verification
- Guard clause tests: Null checks, empty string validation

**Justification for Omitted Test Types**:

- Property-based tests: Not applicable - WireMock.NET is already well-tested; invariants are trivial
- Contract tests: Not applicable - no public interfaces to implement, only concrete fixtures
- Load tests: Not applicable - performance depends on WireMock.NET, not our wrapper
- Benchmarks: Not applicable - same reason as load tests

**Files Created/Modified**:

- `src/Encina.Testing.WireMock/EncinaRefitMockFixture.cs` (NEW - 314 lines)
- `src/Encina.Testing.WireMock/WebhookTestingExtensions.cs` (NEW - 238 lines)
- `src/Encina.Testing.WireMock/Encina.Testing.WireMock.csproj` (MODIFIED - added Refit references)
- `tests/Encina.Testing.WireMock.Tests/EncinaRefitMockFixtureTests.cs` (NEW - 280 lines)
- `tests/Encina.Testing.WireMock.Tests/WebhookTestingExtensionsTests.cs` (NEW - 210 lines)
- `tests/Encina.Testing.WireMock.Tests/FaultSimulationTests.cs` (NEW - 140 lines)
- `tests/Encina.Testing.WireMock.Tests/SequenceTests.cs` (NEW - 180 lines)
- `tests/Encina.Testing.WireMock.Tests/GuardClauseTests.cs` (NEW - 250 lines)
- `tests/Encina.Testing.WireMock.Tests/ReceivedRequestTests.cs` (MODIFIED - fixed header type)
- `tests/Encina.Testing.WireMock.Tests/Encina.Testing.WireMock.Tests.csproj` (MODIFIED - added Refit)

**Design Decisions**:

- Used alias `WireMockRequestBuilder` to resolve ambiguity between Refit.IRequestBuilder and WireMock.RequestBuilders.IRequestBuilder
- WebhookTestingExtensions extend EncinaWireMockFixture (not generic) for simplicity
- Default JSON serialization with camelCase naming policy
- Webhook extensions use `ArgumentNullException.ThrowIfNull()` for null fixture validation

---

## Issue Progress (v0.11.0 - Testing Infrastructure)

| Issue | Title | Status |
|-------|-------|--------|
| #161 | Test Data Generation | ✅ Completed (Dec 2025) |
| #162 | Testcontainers Integration | ✅ Completed (Dec 2025) |
| #163 | Database Reset (Respawn) | ✅ Completed (Jan 2026) |
| #165 | Snapshot Testing (Verify) | ✅ Completed (Dec 2025) |
| #426 | Testing.Fakes | ✅ Completed (Dec 2025) |
| #427 | Testing.Respawn | ✅ Completed (Dec 2025) |
| #428 | Testing.WireMock (base) | ✅ Completed (Dec 2025) |
| #164 | WireMock Refit + Webhooks | ✅ Completed (Jan 2026) |
| #429 | Testing.Shouldly | ✅ Completed (Dec 2025) |
| #430 | Testing.Verify | ✅ Completed (Dec 2025) |
| #431 | Testing.Bogus | ✅ Completed (Dec 2025) |
| #432 | Testing.Architecture | ✅ Completed (Dec 2025) |
| #444 | Enhanced Testing Fixtures | ✅ All 6 Phases Completed |
| #495 | AggregateTestBase | ✅ Completed (Dec 2025) |
| #362 | Module Testing Utilities | ✅ Completed (Jan 2026) |
| #171 | Testing.TUnit | ✅ Completed (Jan 2026) |
| #435 | Testing.FsCheck | ✅ Completed (Jan 2026) |

---

## Completed Phases (Issue #444)

Issue #444 "Enhanced Testing Fixtures" - All 6 phases completed on January 1, 2026:

| Phase | Description | Status | Package |
|-------|-------------|--------|---------|
| Phase 1 | EncinaTestFixture fluent fixture | ✅ Completed | Encina.Testing |
| Phase 2 | Enhanced Either assertions in Shouldly | ✅ Already exists | Encina.Testing.Shouldly |
| Phase 3 | Saga time-travel testing | ✅ Completed | Encina.Testing |
| Phase 4 | Outbox/Inbox assertion helpers | ✅ Completed | Encina.Testing |
| Phase 5 | Snapshot testing enhancements | ✅ Completed | Encina.Testing.Verify |
| Phase 6 | Contract testing enhancements | ✅ Completed | Encina.Testing.Architecture |

---

## References

- [Issue #444 - Enhanced Testing Fixtures](https://github.com/dlrivada/Encina/issues/444)
- [v0.11.0 Testing Infrastructure Milestone](https://github.com/dlrivada/Encina/milestone/8)

---

## Issue #170: Improved Assertions with Shouldly

**Date**: January 1, 2026

**Summary**: Enhanced `Encina.Testing` and `Encina.Testing.Shouldly` with fluent chaining assertions (AndConstraint pattern), collection assertions, and streaming assertions for `IAsyncEnumerable<Either<TLeft, TRight>>`.

### Phase 1: AndConstraint Pattern

**New Classes** (`src/Encina.Testing/Assertions/`):

1. **`AndConstraint<T>`** - Fluent chaining for assertions (FluentAssertions-style):
   - `Value` property for accessing the asserted value
   - `And` property returning `this` for fluent chaining
   - `ShouldSatisfy(Action<T>)` for custom assertions
   - Implicit conversion to underlying `T` type

2. **`AndConstraintAsync<T>`** - Async variant for `Task<T>` results:
   - `Value` property returning `Task<T>`
   - `ShouldSatisfyAsync(Func<T, Task>)` for async assertions
   - `AsSync()` to materialize and get `AndConstraint<T>`

**EitherAssertions Enhancements**:

- `ShouldBeSuccessAnd()`, `ShouldBeRightAnd()` → `AndConstraint<TRight>`
- `ShouldBeErrorAnd()`, `ShouldBeLeftAnd()` → `AndConstraint<TLeft>`
- EncinaError `*And` variants: `ShouldBeErrorWithCodeAnd()`, `ShouldBeValidationErrorAnd()`, `ShouldBeAuthorizationErrorAnd()`, `ShouldBeNotFoundErrorAnd()`, `ShouldBeErrorContainingAnd()`
- New: `ShouldBeValidationErrorForProperty()` and `ShouldBeValidationErrorForPropertyAnd()` for property-specific validation errors
- Async `*And` variants for all methods

### Phase 2: Collection Assertions

**New Class**: `EitherCollectionAssertions` (`src/Encina.Testing/Assertions/`):

- **All/Error Assertions**:
  - `ShouldAllBeSuccess()`, `ShouldAllBeSuccessAnd()` - All results must be Right
  - `ShouldAllBeError()`, `ShouldAllBeErrorAnd()` - All results must be Left

- **Contains Assertions**:
  - `ShouldContainSuccess()`, `ShouldContainSuccessAnd()` - At least one Right
  - `ShouldContainError()`, `ShouldContainErrorAnd()` - At least one Left

- **Count Assertions**:
  - `ShouldHaveSuccessCount(n)`, `ShouldHaveSuccessCountAnd(n)`
  - `ShouldHaveErrorCount(n)`, `ShouldHaveErrorCountAnd(n)`

- **EncinaError-Specific**:
  - `ShouldContainValidationErrorFor(propertyName)` - Find validation error for property
  - `ShouldNotContainAuthorizationErrors()` - No auth errors in collection
  - `ShouldContainAuthorizationError()` - At least one auth error
  - `ShouldAllHaveErrorCode(code)` - All errors have same code

- **Helper Methods**:
  - `GetSuccesses()`, `GetErrors()` - Extract values/errors from collection

- **Async Variants**: `ShouldAllBeSuccessAsync()`, `ShouldAllBeErrorAsync()`, `ShouldContainSuccessAsync()`, `ShouldContainErrorAsync()`

### Phase 3: Streaming Assertions

**New Classes**:

1. **`StreamingAssertions`** (`src/Encina.Testing/Assertions/`) - xUnit-based:
   - `CollectAsync()` - Materialize `IAsyncEnumerable` to `List<T>`
   - All collection assertions with `Async` suffix for streams
   - `FirstShouldBeSuccessAsync()`, `FirstShouldBeErrorAsync()` - First item assertions
   - `ShouldBeEmptyAsync()`, `ShouldNotBeEmptyAsync()` - Stream emptiness
   - `ShouldHaveCountAsync(n)` - Total item count
   - EncinaError-specific streaming assertions

2. **`StreamingShouldlyExtensions`** (`src/Encina.Testing.Shouldly/`) - Shouldly-based:
   - Same API as `StreamingAssertions` but using `ShouldAssertException`
   - Consistent with existing `EitherCollectionShouldlyExtensions`

### Phase 4: Test Coverage

**New Test Files**:

- `tests/Encina.Testing.Tests/EitherAssertionsTests.cs` - 30+ new tests for AndConstraint
- `tests/Encina.Testing.Tests/EitherCollectionAssertionsTests.cs` - 25+ tests for collections
- `tests/Encina.Testing.Tests/StreamingAssertionsTests.cs` - 30+ tests for streaming

**Total**: 444 tests passing

### Test Types Justification

| Test Type | Status | Justification |
|-----------|--------|---------------|
| Unit Tests | ✅ 85+ tests | All assertion methods covered |
| Property-Based | ⏭️ Not applicable | Assertions are deterministic |
| Guard Clause | ⏭️ Not applicable | Null checks use `ArgumentNullException.ThrowIfNull` |
| Integration | ⏭️ Not applicable | Pure assertion methods, no external deps |
| Contract | ⏭️ Not applicable | Extension methods, not interfaces |
| Load/Benchmark | ⏭️ Not applicable | Assertions run at test-time |

### CodeRabbit Plan Execution

Following CodeRabbit's 4-phase plan:

1. ✅ Phase 1: AndConstraint pattern with `And` chaining
2. ✅ Phase 2: Collection assertions with EncinaError specifics
3. ✅ Phase 3: Streaming assertions for `IAsyncEnumerable`
4. ✅ Phase 4: Comprehensive unit tests

---

## Issue #362 - Module Testing Utilities

**Date**: 2026-01-02
**Milestone**: v0.11.0 - Testing Infrastructure
**Package**: Encina.Testing

### Overview

Module Testing Utilities provide comprehensive testing infrastructure for modular monolith applications. This implementation enables isolated module testing with dependency mocking, integration event assertions, and architecture verification.

### Components Implemented

#### ModuleTestFixture<TModule>

Fluent test fixture for isolated module testing:

```csharp
using var fixture = new ModuleTestFixture<OrdersModule>()
    .WithMockedModule<IInventoryModuleApi>(mock =>
        mock.Setup("ReserveStockAsync", (string id, int qty) =>
            Task.FromResult(Right<EncinaError, string>("reserved"))))
    .WithFakeModule<IPaymentModuleApi, FakePaymentModule>()
    .WithAllMockedStores()
    .WithFakeTimeProvider();

var result = await fixture.SendAsync(new PlaceOrderCommand(...));

result.ShouldSucceed();
fixture.IntegrationEvents.ShouldContain<OrderPlacedEvent>();
```

**Features**:

- `WithMockedModule<T>()` - Mock dependent modules via fluent API or instance
- `WithFakeModule<T, TFake>()` - Register fake implementations
- `WithAllMockedStores()` - Configure all messaging stores
- `WithFakeTimeProvider()` - Time-travel testing support
- `SendAsync()`, `PublishAsync()` - Execute requests capturing events
- `ClearStores()` - Reset state between tests

#### IntegrationEventCollector

Thread-safe collection for integration event assertions:

```csharp
fixture.IntegrationEvents.ShouldContain<OrderPlacedEvent>();
fixture.IntegrationEvents.ShouldContain<OrderPlacedEvent>(e => e.OrderId == expectedId);
fixture.IntegrationEvents.ShouldContainSingle<OrderConfirmedEvent>();
fixture.IntegrationEvents.ShouldBeEmpty();
fixture.IntegrationEvents.ShouldHaveCount(3);
```

#### MockModuleApi<T>

Simple mock builder using DispatchProxy:

```csharp
var mock = new MockModuleApi<IInventoryModuleApi>()
    .Setup("GetAvailableStock", (string id) =>
        Right<EncinaError, int>(42))
    .Setup("ReserveStockAsync", (string id, int qty) =>
        Task.FromResult(Right<EncinaError, string>("reserved")))
    .SetupProperty("ModuleName", "Inventory");

var api = mock.Build();
```

#### ModuleArchitectureAnalyzer

Module dependency analysis with circular dependency detection:

```csharp
var result = await ModuleArchitectureAnalyzer
    .AnalyzeAssemblyContaining<OrdersModule, PaymentsModule>();

result.ShouldHaveNoCircularDependencies();
result.ShouldContainModule("Orders");
result.ShouldHaveDependency("Orders", "Payments");
result.ShouldNotHaveDependency("Payments", "Orders");
```

**Algorithm**: Uses DFS (Depth-First Search) for cycle detection in the module dependency graph.

#### ModuleArchitectureRules

Pre-built ArchUnitNET rules:

```csharp
ModuleArchitectureRules.ModulesShouldBeSealed()
    .Check(architecture);

ModuleArchitectureRules.IntegrationEventsShouldBeSealed()
    .Check(architecture);

ModuleArchitectureRules.DomainShouldNotDependOnInfrastructure(
    "MyApp.Orders.Domain",
    "MyApp.Orders.Infrastructure")
    .Check(architecture);
```

### Files Created

| File | Purpose |
|------|---------|
| `src/Encina.Testing/Modules/ModuleTestFixture.cs` | Main test fixture |
| `src/Encina.Testing/Modules/ModuleTestContext.cs` | Fluent assertion context |
| `src/Encina.Testing/Modules/IntegrationEventCollector.cs` | Event capture & assertions |
| `src/Encina.Testing/Modules/MockModuleApi.cs` | DispatchProxy-based mocking |
| `src/Encina.Testing/Modules/ModuleArchitectureRules.cs` | ArchUnitNET rules |
| `src/Encina.Testing/Modules/ModuleArchitectureAnalyzer.cs` | Dependency analysis |
| `tests/Encina.Testing.Tests/Modules/ModuleTestFixtureTests.cs` | Fixture tests |
| `tests/Encina.Testing.Tests/Modules/IntegrationEventCollectorTests.cs` | Collector tests |
| `tests/Encina.Testing.Tests/Modules/MockModuleApiTests.cs` | Mock builder tests |
| `tests/Encina.Testing.Tests/Modules/ModuleArchitectureAnalyzerTests.cs` | Analyzer tests |

### Dependencies Added

- `TngTech.ArchUnitNET.xUnit` - Architecture testing rules
- `Shouldly` - Fluent assertions

### Test Coverage

| Test Type | Status | Tests | Justification |
|-----------|--------|-------|---------------|
| Unit Tests | ✅ | 87 | Core functionality, all public APIs |
| Property-Based | ⏭️ | N/A | Test utilities don't have invariants |
| Guard Clause | ✅ | Included | ArgumentNullException checks |
| Integration | ⏭️ | N/A | In-memory test infrastructure |
| Contract | ⏭️ | N/A | Internal implementation |
| Load/Benchmark | ⏭️ | N/A | Test-time only, not runtime |

### Technical Notes

1. **DispatchProxy Requirement**: The `MockProxy<T>` class cannot be sealed because `DispatchProxy.Create` generates a derived type dynamically.

2. **ConcurrentBag Order**: `IntegrationEventCollector` uses `ConcurrentBag` which doesn't guarantee insertion order. Tests verify event presence, not order.

3. **Circular Dependency Detection**: Uses standard DFS algorithm with visited/recursion-stack tracking. O(V+E) complexity where V=modules, E=dependencies.

4. **InternalsVisibleTo**: Added to allow tests access to `internal Add()` method on `IntegrationEventCollector`.

---

## Issue #172 - Mutation Testing Helper Attributes

**Date**: 2026-01-02
**Milestone**: v0.11.0 - Testing Infrastructure
**Package**: Encina.Testing

### Overview

Added helper attributes to the `Encina.Testing.Mutations` namespace for documenting and tracking mutation testing insights directly in test code. These attributes follow the existing Stryker.NET integration and enhance the mutation testing workflow.

### Components Implemented

#### NeedsMutationCoverageAttribute

Marks tests identified as mutation-weak during Stryker analysis:

```csharp
[Fact]
[NeedsMutationCoverage("Boundary condition not verified", MutantId = "280", Line = 45)]
public void Calculate_BoundaryValue_ShouldReturnExpectedResult()
{
    // Test needs stronger assertions
}
```

**Properties**:

- `Reason` (required) - Description of mutation coverage gap
- `MutantId` (optional) - Stryker mutant ID from report
- `SourceFile` (optional) - Path to source file with surviving mutant
- `Line` (optional) - Line number where mutation was applied

#### MutationKillerAttribute

Documents tests explicitly written to kill specific mutation types:

```csharp
[Fact]
[MutationKiller("EqualityMutation", Description = "Verifies >= is not mutated to >")]
public void IsAdult_ExactlyEighteen_ShouldReturnTrue()
{
    // Boundary test that kills equality mutation
}
```

**Properties**:

- `MutationType` (required) - Type of mutation killed
- `Description` (optional) - Detailed description
- `SourceFile` (optional) - Path to source file
- `TargetMethod` (optional) - Method name
- `Line` (optional) - Line number

### Files Created

| File | Purpose |
|------|---------|
| `src/Encina.Testing/Mutations/NeedsMutationCoverageAttribute.cs` | Attribute for mutation-weak tests |
| `src/Encina.Testing/Mutations/MutationKillerAttribute.cs` | Attribute for mutation killer tests |
| `tests/Encina.Testing.Tests/Mutations/MutationAttributesTests.cs` | Unit tests (24 tests) |
| `tests/Encina.Testing.Tests/Mutations/MutationAttributesGuardClauseTests.cs` | Guard clause tests (23 tests) |

### Documentation Updated

- `docs/en/guides/MUTATION_TESTING.md` - Added "Test Quality Patterns" section with usage examples and best practices

### Test Coverage

| Test Type | Status | Tests | Justification |
|-----------|--------|-------|---------------|
| Unit Tests | ✅ | 24 | Core functionality, all public APIs |
| Guard Clause | ✅ | 23 | Null/empty/whitespace validation |
| Property-Based | ⏭️ | N/A | Attributes are simple data holders |
| Integration | ⏭️ | N/A | Compile-time metadata only |
| Contract | ⏭️ | N/A | No interfaces to implement |
| Load/Benchmark | ⏭️ | N/A | Test-time only, not runtime |

### Design Decisions

1. **AllowMultiple=true**: Both attributes allow multiple instances per test method to document multiple mutation issues or kills.

2. **Inherited=false**: Attributes are not inherited to derived test classes, ensuring explicit documentation.

3. **Sealed classes**: Both attribute classes are sealed following Encina conventions.

4. **Validation**: Both constructors validate that required parameters are not null, empty, or whitespace using `ArgumentException.ThrowIfNullOrWhiteSpace`.

### Bug Fixes (Existing Code)

During implementation, addressed pre-existing issues in `Encina.Testing`:

1. **MockModuleApi.cs**: Fixed duplicate XML documentation and corrected `<see cref>` syntax error
2. **IntegrationEventCollector.cs**: Changed return type from `IReadOnlyList<string>` to `ReadOnlyCollection<string>` to fix CA1859
3. **ModuleArchitectureAnalyzerTests.cs**: Fixed ambiguous constructor call by using named parameter

---

## Issue #497 - ModuleArchitectureAnalyzerTests False Positive Dependency Fix

**Date**: 2026-01-02
**Milestone**: v0.11.0 - Testing Infrastructure
**Package**: Encina.Testing.Tests

### Overview

Fixed failing test `ShouldNotHaveDependency_NoDependency_Passes` in `ModuleArchitectureAnalyzerTests` which was reporting false positive module dependencies.

### Root Cause Analysis

The `ModuleArchitectureAnalyzer` uses namespace prefixes to detect dependencies between modules. The test modules (`OrdersModule`, `PaymentsModule`, `ShippingModule`) were all declared with `file` scope in the same namespace `Encina.Testing.Tests.Modules`, causing the analyzer to detect false dependencies between them.

The dependency detection algorithm in `CheckDependency()`:

1. Gets all types in source module's namespace
2. Checks if any type references types in target module's namespace
3. Since all test modules shared the same namespace, type references were incorrectly flagged as cross-module dependencies

### Solution

Moved test modules to distinct namespaces to simulate real modular architecture:

```csharp
// Before: All in same namespace
namespace Encina.Testing.Tests.Modules;
file sealed class OrdersModule : IModule { ... }
file sealed class PaymentsModule : IModule { ... }
file sealed class ShippingModule : IModule { ... }

// After: Separate namespaces
namespace Encina.Testing.Tests.Modules.TestModules.Orders
{
    internal sealed class OrdersModule : IModule { ... }
}
namespace Encina.Testing.Tests.Modules.TestModules.Payments
{
    internal sealed class PaymentsModule : IModule { ... }
}
namespace Encina.Testing.Tests.Modules.TestModules.Shipping
{
    internal sealed class ShippingModule : IModule { ... }
}
```

### Additional Fix

The test `Result_DiscoversModulesInAssembly` was also adjusted:

- **Before**: Verified exact module count match (expected exactly 3 modules)
- **After**: Verified module containment (expected modules exist among discovered modules)
- **Reason**: Assembly may contain additional test modules from other test files (e.g., `TestModule` from `ModuleTestFixtureTests.cs`)

### Files Modified

| File | Changes |
|------|---------|
| `tests/Encina.Testing.Tests/Modules/ModuleArchitectureAnalyzerTests.cs` | Moved test modules to distinct namespaces; adjusted discovery test |

### Test Results

| Test | Before | After |
|------|--------|-------|
| `ShouldNotHaveDependency_NoDependency_Passes` | ❌ Failing | ✅ Passing |
| `Result_DiscoversModulesInAssembly` | ❌ Failing | ✅ Passing |
| All ModuleArchitectureAnalyzerTests (14 total) | 12 passing | 14 passing |

### Design Insight

This fix reinforces the importance of proper namespace organization when using `ModuleArchitectureAnalyzer`:

- Each module should have its own distinct namespace prefix
- The analyzer uses namespace prefixes as module boundaries
- Test modules should mirror production module structure for accurate analysis

---

## Issue #173 - CI/CD Workflow Templates

**Date**: 2026-01-03
**Milestone**: v0.11.0 - Testing Infrastructure
**Location**: `.github/workflows/templates/`

### Overview

Created reusable GitHub Actions workflow templates to standardize CI/CD across projects using Encina. These templates provide best practices for .NET 10 testing, coverage, and package publishing.

### Components Implemented

#### encina-test.yml - Basic Test Workflow

Reusable workflow for unit testing with code coverage:

```yaml
jobs:
  test:
    uses: dlrivada/Encina/.github/workflows/templates/encina-test.yml@main
    with:
      solution: 'MyApp.slnx'
      coverage-threshold: '80'
```

**Features**:

- Cross-platform support (Windows, Linux, macOS)
- Configurable .NET SDK version (default: 10.0.x)
- NuGet package caching for faster builds
- Test filter expressions for selective testing
- Coverage threshold enforcement
- ReportGenerator integration for HTML reports
- Artifact upload for coverage and test results

**Inputs**:

- `solution` - Solution file path (default: `*.slnx`)
- `configuration` - Build configuration (default: `Release`)
- `dotnet-version` - SDK version (default: `10.0.x`)
- `runs-on` - Runner OS (default: `ubuntu-latest`)
- `coverage-threshold` - Minimum coverage % (default: `0`)
- `run-integration-tests` - Include integration tests (default: `false`)
- `test-filter` - Test filter expression
- `exclude-patterns` - Comma-separated exclude patterns (default: `LoadTests`)
- `upload-coverage` - Upload coverage artifact (default: `true`)
- `timeout-minutes` - Job timeout (default: `30`)

#### encina-matrix.yml - Matrix Testing Workflow

Matrix testing across multiple OS and database providers:

```yaml
jobs:
  matrix:
    uses: dlrivada/Encina/.github/workflows/templates/encina-matrix.yml@main
    with:
      test-os: '["ubuntu-latest", "windows-latest"]'
      test-databases: '["postgresql", "sqlserver", "sqlite"]'
```

**Features**:

- Multiple OS testing in parallel
- Docker service containers for databases:
  - PostgreSQL (postgres:16)
  - SQL Server (mssql/server:2022-latest)
  - MySQL (mysql:8)
  - Redis (redis:7-alpine)
  - MongoDB (mongo:7)
  - SQLite (in-memory)
- Automatic connection string environment variables
- Summary job aggregating all matrix results
- Smart exclusions (e.g., SQL Server not on macOS)

**Inputs**:

- `test-os` - JSON array of OS runners
- `test-databases` - JSON array of database providers
- `fail-fast` - Cancel all jobs on failure (default: `false`)
- `max-parallel` - Maximum parallel jobs (default: `4`)
- `test-filter` - Test filter expression
- `timeout-minutes` - Job timeout (default: `45`)

#### encina-full-ci.yml - Complete CI Pipeline

Comprehensive CI pipeline with all stages:

```yaml
jobs:
  ci:
    uses: dlrivada/Encina/.github/workflows/templates/encina-full-ci.yml@main
    with:
      coverage-threshold: '80'
      run-integration-tests: true
      run-mutation-tests: true
    secrets:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
```

**Pipeline Stages**:

1. **Build & Analyze**
   - Restore dependencies
   - Check code formatting (`dotnet format --verify-no-changes`)
   - Build with warnings as errors
   - Calculate version from tag or commit

2. **Unit Tests**
   - Run all unit tests with coverage
   - Generate coverage report
   - Enforce coverage threshold
   - Upload artifacts

3. **Integration Tests** (optional)
   - Docker service containers (PostgreSQL, SQL Server, Redis)
   - Run `*IntegrationTests*` projects
   - Connection strings via environment variables

4. **Architecture Tests** (optional)
   - Run `*ArchitectureTests*` projects
   - ArchUnitNET rule validation

5. **Mutation Tests** (optional)
   - Stryker.NET mutation testing
   - Mutation score threshold enforcement
   - HTML and JSON reports

6. **Pack NuGet**
   - Create NuGet packages
   - Version from build stage

7. **Publish NuGet** (on tag)
   - Push to configured NuGet source
   - Skip duplicates

8. **Summary**
   - Aggregate all job results
   - Status table with checkmarks

**Secrets**:

- `NUGET_API_KEY` - API key for NuGet publishing

### Documentation

Created comprehensive documentation at `docs/ci-cd-templates.md`:

- Quick start examples for each template
- Complete input/secret reference
- Supported databases with Docker images
- Pipeline stage diagrams
- Best practices and troubleshooting
- Integration with Encina.Testing packages

### Test Coverage

Created `tests/Encina.Workflows.Tests/` project:

| Test Type | Status | Tests | Justification |
|-----------|--------|-------|---------------|
| Unit Tests | ✅ | 49 | YAML validation, structure verification |
| Property-Based | ⏭️ | N/A | Static YAML files, no invariants |
| Guard Clause | ⏭️ | N/A | No runtime code, only YAML |
| Integration | ⏭️ | N/A | Would require GitHub Actions execution |
| Contract | ⏭️ | N/A | No interfaces, only workflow definitions |
| Load/Benchmark | ⏭️ | N/A | CI pipelines not performance-critical |

**Test Categories**:

- Template existence and validity
- YAML syntax validation
- Required sections (name, permissions, jobs)
- Reusable workflow structure (workflow_call)
- Expected inputs for each template
- Job structure (runs-on, steps)
- Required actions (checkout, setup-dotnet, cache)
- Template-specific features (services, secrets, multiple jobs)
- Documentation presence

### Files Created

| File | Purpose |
|------|---------|
| `.github/workflows/templates/encina-test.yml` | Basic test workflow |
| `.github/workflows/templates/encina-matrix.yml` | Matrix testing workflow |
| `.github/workflows/templates/encina-full-ci.yml` | Complete CI pipeline |
| `docs/ci-cd-templates.md` | Comprehensive documentation |
| `tests/Encina.Workflows.Tests/Encina.Workflows.Tests.csproj` | Test project |
| `tests/Encina.Workflows.Tests/WorkflowTemplateTests.cs` | 49 validation tests |

### Dependencies Added

- `YamlDotNet` (16.3.0) - YAML parsing for tests

### Design Decisions

1. **Reusable Workflows**: All templates use `workflow_call` trigger to be invoked from other repositories.

2. **Sensible Defaults**: Templates work out-of-the-box with minimal configuration but allow extensive customization.

3. **Cross-Platform**: All templates support Windows, Linux, and macOS runners where applicable.

4. **Version-Agnostic**: Default to `10.0.x` for .NET SDK but allow override.

5. **Service Container Exclusions**: Matrix template automatically excludes impossible combinations (e.g., SQL Server on macOS).

6. **Coverage Tools**: Use ReportGenerator for consistent HTML/JSON coverage reports.

7. **Parallel Execution**: Matrix jobs run in parallel with configurable max-parallel.

8. **Artifact Retention**: Use GitHub's default retention; build outputs kept 1 day.

---

## Week 1: January 3 (Testing Infrastructure - TUnit Support)

### January 3 - TUnit Framework Support (Issue #171)

#### New Package: Encina.Testing.TUnit

TUnit framework support for modern, source-generated testing with NativeAOT compatibility.

**Files Created**:

- `src/Encina.Testing.TUnit/Encina.Testing.TUnit.csproj` - Package definition with TUnit dependency
- `src/Encina.Testing.TUnit/EncinaTUnitFixture.cs` - TUnit-compatible test fixture
- `src/Encina.Testing.TUnit/TUnitEitherAssertions.cs` - Async-first Either assertions
- `src/Encina.Testing.TUnit/TUnitEitherCollectionAssertions.cs` - Collection assertions
- `src/Encina.Testing.TUnit/PublicAPI.Shipped.txt` - Empty (no shipped APIs yet)
- `src/Encina.Testing.TUnit/PublicAPI.Unshipped.txt` - All public APIs
- `tests/Encina.Testing.TUnit.Tests/Encina.Testing.TUnit.Tests.csproj` - Test project
- `tests/Encina.Testing.TUnit.Tests/EncinaTUnitFixtureTests.cs` - Fixture tests
- `tests/Encina.Testing.TUnit.Tests/TUnitEitherAssertionsTests.cs` - Assertion tests
- `tests/Encina.Testing.TUnit.Tests/TUnitEitherCollectionAssertionsTests.cs` - Collection tests

**EncinaTUnitFixture Implementation**:

- Implements TUnit's `IAsyncInitializer` for async test initialization
- Implements `IAsyncDisposable` for proper cleanup with `GC.SuppressFinalize`
- Fluent builder pattern:
  - `WithConfiguration(Action<EncinaConfiguration>)` - Custom Encina configuration
  - `WithServices(Action<IServiceCollection>)` - Register custom services
  - `WithHandlersFromAssemblyContaining<T>()` - Scan assembly for handlers
- Service resolution:
  - `CreateScope()` - Create service scope
  - `GetService<T>()`, `GetRequiredService<T>()` - Resolve services
- Properties: `Encina`, `ServiceProvider`

**TUnitEitherAssertions Implementation**:

- Async-first assertions following TUnit's `Assert.That().IsTrue().Because()` pattern
- Success assertions:
  - `ShouldBeSuccessAsync()` - Assert Right and return value
  - `ShouldBeSuccessAsync(expected)` - Assert with expected value
  - `ShouldBeSuccessAsync(Func<TRight, Task>)` - Assert with async validator
  - `AndReturnAsync()` - Alias for fluent chaining
- Error assertions:
  - `ShouldBeErrorAsync()` - Assert Left and return error
  - `ShouldBeErrorAsync(Func<TLeft, Task>)` - Assert with async validator
- EncinaError-specific assertions:
  - `ShouldBeErrorWithCodeAsync(code)` - Assert specific error code
  - `ShouldBeErrorContainingAsync(text)` - Assert message contains text
  - `ShouldBeValidationErrorAsync()` - Assert code starts with "encina.validation"
  - `ShouldBeAuthorizationErrorAsync()` - Assert code starts with "encina.authorization"
  - `ShouldBeNotFoundErrorAsync()` - Assert code starts with "encina.notfound"
  - `ShouldBeConflictErrorAsync()` - Assert code starts with "encina.conflict"
  - `ShouldBeInternalErrorAsync()` - Assert code starts with "encina.internal"
- Task extensions: All assertions work with `Task<Either<>>`

**TUnitEitherCollectionAssertions Implementation**:

- `ShouldAllBeSuccessAsync()` - Assert all items are Right, return values
- `ShouldAllBeErrorAsync()` - Assert all items are Left, return errors
- `ShouldContainSuccessAsync()` - Assert at least one Right
- `ShouldContainErrorAsync()` - Assert at least one Left
- `ShouldHaveSuccessCountAsync(count)` - Assert exact success count
- `ShouldHaveErrorCountAsync(count)` - Assert exact error count
- Helper methods: `GetSuccesses()`, `GetErrors()`

**NativeAOT Compatibility**:

- Package marked with `<IsAotCompatible>true</IsAotCompatible>`
- No reflection-based patterns in package code
- Zero IL warnings from Encina.Testing.TUnit code
- Compatible with TUnit's source-generated test discovery

**Tests Created**:

- `EncinaTUnitFixtureTests.cs` - 15 tests for fixture lifecycle
- `TUnitEitherAssertionsTests.cs` - 21 tests for Either assertions
- `TUnitEitherCollectionAssertionsTests.cs` - 20 tests for collection assertions
- Total: 56 tests, all passing

**Dependencies Added**:

- TUnit v1.8.1 added to `Directory.Packages.props`
- Package added to `Encina.slnx` solution file

**Design Decisions**:

1. Use TUnit's `IAsyncInitializer` instead of xUnit's `IAsyncLifetime` for lifecycle
2. Async-first assertions matching TUnit's async assertion model
3. `GC.SuppressFinalize` in `DisposeAsync()` per CA1816
4. Use `EncinaErrors.Create()` for error creation (not factory methods)
5. `TestingPlatformDotnetTestSupport=true` for .NET 10 test execution

---

## Week 1: January 3 (Testing Infrastructure - FsCheck Property-Based Testing)

### January 3 - FsCheck Property-Based Testing (Issue #435)

#### New Package: Encina.Testing.FsCheck

FsCheck property-based testing extensions for Encina framework, compatible with FsCheck 3.x.

**Files Created**:

- `src/Encina.Testing.FsCheck/Encina.Testing.FsCheck.csproj` - Package definition with FsCheck 3.3.2 and FsCheck.Xunit dependencies
- `src/Encina.Testing.FsCheck/EncinaArbitraries.cs` - Pre-built arbitraries for Encina types
- `src/Encina.Testing.FsCheck/EncinaProperties.cs` - Common property validators for invariants
- `src/Encina.Testing.FsCheck/GenExtensions.cs` - Generator extension methods
- `src/Encina.Testing.FsCheck/PropertyTestBase.cs` - Base class and attributes for xUnit integration
- `src/Encina.Testing.FsCheck/EncinaArbitraryProvider.cs` - FsCheck arbitrary provider
- `src/Encina.Testing.FsCheck/ArbitraryMessages.cs` - Concrete message implementations for testing
- `src/Encina.Testing.FsCheck/PublicAPI.Shipped.txt` - Empty (no shipped APIs yet)
- `src/Encina.Testing.FsCheck/PublicAPI.Unshipped.txt` - All public APIs
- `src/Encina.Testing.FsCheck/README.md` - Comprehensive documentation
- `tests/Encina.Testing.FsCheck.Tests/Encina.Testing.FsCheck.Tests.csproj` - Test project
- `tests/Encina.Testing.FsCheck.Tests/EncinaArbitrariesTests.cs` - Arbitrary tests
- `tests/Encina.Testing.FsCheck.Tests/EncinaPropertiesTests.cs` - Property tests
- `tests/Encina.Testing.FsCheck.Tests/GenExtensionsTests.cs` - Generator tests
- `tests/Encina.Testing.FsCheck.Tests/PropertyTestBaseTests.cs` - Base class tests

**EncinaArbitraries Implementation**:

- Core types: `EncinaError()`, `EncinaErrorWithException()`, `RequestContext()`
- Either types: `EitherOf<T>()`, `SuccessEither<T>()`, `FailureEither<T>()`
- Messaging types: `OutboxMessage()`, `PendingOutboxMessage()`, `FailedOutboxMessage()`
- `InboxMessage()`, `SagaState()`, `ScheduledMessage()`, `RecurringScheduledMessage()`
- Uses FsCheck 3.x `Gen.SelectMany` and `Gen.Select` static methods (not LINQ query syntax)
- Uses `ArbMap.Default.GeneratorFor<T>()` for default arbitraries

**EncinaProperties Implementation**:

- Either properties: `EitherIsExclusive()`, `MapPreservesRightState()`, `MapPreservesLeftError()`, `BindToFailureProducesLeft()`
- Error properties: `ErrorHasNonEmptyMessage()`, `ErrorFromStringPreservesMessage()`
- Context properties: `ContextHasCorrelationId()`, `WithMetadataIsImmutable()`, `WithUserIdCreatesNewContext()`
- Outbox: `OutboxProcessedStateIsConsistent()`, `OutboxDeadLetterIsConsistent()`, `OutboxHasRequiredFields()`
- Inbox: `InboxProcessedStateIsConsistent()`, `InboxHasRequiredFields()`
- Saga: `SagaStatusIsValid()`, `SagaHasRequiredFields()`, `SagaCompletedStateIsConsistent()`, `SagaCurrentStepIsNonNegative()`
- Scheduled: `ScheduledHasValidTiming()`, `RecurringHasCronExpression()`, `ScheduledHasRequiredFields()`
- Handler: `HandlerIsDeterministic()`, `AsyncHandlerIsDeterministic()`

**GenExtensions Implementation**:

- Either generators: `ToEither()`, `ToSuccess()`, `ToFailure<T>()`
- Nullable generators: `OrNull()`, `OrNullValue()`
- String generators: `NonEmptyString()`, `AlphaNumericString()`, `EmailAddress()`
- Data generators: `JsonObject()`, `UtcDateTime()`, `PastUtcDateTime()`, `FutureUtcDateTime()`
- Other: `CronExpression()`, `PositiveDecimal()`, `ListOf()`, `NonEmptyListOf()`

**xUnit Integration**:

- `PropertyTestBase` - Base class that auto-registers Encina arbitraries
- `EncinaArbitraryProvider` - Arbitrary provider for FsCheck type registration
- `[EncinaProperty]` - Standard property with 100 tests
- `[QuickProperty]` - Fast feedback with 20 tests
- `[ThoroughProperty]` - Comprehensive with 1000 tests
- `PropertyTestConfig` - Configuration constants

**Concrete Message Types**:

- `ArbitraryOutboxMessage` - Implements `IOutboxMessage`
- `ArbitraryInboxMessage` - Implements `IInboxMessage`
- `ArbitrarySagaState` - Implements `ISagaState`
- `ArbitraryScheduledMessage` - Implements `IScheduledMessage`

**FsCheck 3.x API Compatibility**:

- Uses `FsCheck.Fluent` namespace for C# API
- Uses `Gen.Select()` and `Gen.SelectMany()` static methods instead of LINQ query syntax
- Uses `Prop.ForAll()` to create properties (no `.ToProperty()` on bool)
- Uses `ArbMap.Default.GeneratorFor<T>()` instead of deprecated `Arb.Generate<T>()`
- Uses `Gen.Sample(gen, size, count)` parameter order

**Tests Created**:

- `EncinaArbitrariesTests.cs` - 22 tests for arbitrary generation
- `EncinaPropertiesTests.cs` - 22 tests for property validators
- `GenExtensionsTests.cs` - 18 tests for generator extensions
- `PropertyTestBaseTests.cs` - 13 tests for base class and attributes
- Total: 75 tests, all passing

**Dependencies Added**:

- FsCheck v3.3.2 added to `Directory.Packages.props`
- FsCheck.Xunit v3.3.2 added to `Directory.Packages.props`
- Package added to `Encina.slnx` solution file

**Design Decisions**:

1. Use FsCheck 3.x API exclusively (no backward compatibility with 2.x)
2. Static `Gen.Select`/`Gen.SelectMany` instead of LINQ query syntax for FsCheck 3.x
3. Properties handle whitespace-only `NonEmptyString` inputs gracefully
4. `EncinaArbitraryProvider` made `public` for use in test attributes
5. Concrete message types in separate file for clarity
6. README updated with FsCheck 3.x examples

**Test Types Justification**:

- Unit Tests: ✅ 75 tests covering all public APIs
- Property-Based Tests: ⏭️ Meta - package provides property testing, not tested with property testing
- Guard Clause Tests: ⏭️ Not applicable - uses standard `ArgumentNullException.ThrowIfNull`
- Integration Tests: ⏭️ Not applicable - pure in-memory generators
- Contract Tests: ⏭️ Not applicable - no interfaces to implement
- Load Tests: ⏭️ Not applicable - test utilities, not runtime code
- Benchmarks: ⏭️ Not applicable - test utilities, not runtime code

---

## Week 1: January 4 (Testing Infrastructure - PactNet CDC Testing)

### January 4 - Encina.Testing.Pact (Issue #436)

#### New Package: Encina.Testing.Pact

PactNet integration for Consumer-Driven Contract Testing (CDC) with Encina framework.

**Files Created**:

- `src/Encina.Testing.Pact/Encina.Testing.Pact.csproj` - Package definition with PactNet 5.0.1 dependency
- `src/Encina.Testing.Pact/EncinaPactConsumerBuilder.cs` - Fluent builder for consumer-side Pact expectations
- `src/Encina.Testing.Pact/EncinaPactProviderVerifier.cs` - Provider verification against Pact contracts
- `src/Encina.Testing.Pact/EncinaPactFixture.cs` - xUnit test fixture for simplified test setup
- `src/Encina.Testing.Pact/PactExtensions.cs` - Extension methods for working with Pact
- `src/Encina.Testing.Pact/XunitOutputAdapter.cs` - Adapter bridging xUnit ITestOutputHelper to PactNet IOutput
- `src/Encina.Testing.Pact/PublicAPI.Shipped.txt` - Empty (no shipped APIs yet)
- `src/Encina.Testing.Pact/PublicAPI.Unshipped.txt` - All public APIs (80 entries)
- `src/Encina.Testing.Pact/README.md` - Comprehensive documentation with usage examples
- `tests/Encina.Testing.Pact.Tests/Encina.Testing.Pact.Tests.csproj` - Test project
- `tests/Encina.Testing.Pact.Tests/TestTypes.cs` - Test types (commands, queries, notifications)
- `tests/Encina.Testing.Pact.Tests/EncinaPactConsumerBuilderTests.cs` - Consumer builder tests
- `tests/Encina.Testing.Pact.Tests/EncinaPactProviderVerifierTests.cs` - Provider verifier tests
- `tests/Encina.Testing.Pact.Tests/EncinaPactFixtureTests.cs` - Fixture tests
- `tests/Encina.Testing.Pact.Tests/PactExtensionsTests.cs` - Extension method tests
- `tests/Encina.Testing.Pact.Tests/GuardClauseTests.cs` - Guard clause tests for all public methods

**EncinaPactConsumerBuilder Implementation**:

- `WithCommandExpectation<TCommand, TResponse>()` - Define command request/response contracts
- `WithQueryExpectation<TQuery, TResponse>()` - Define query request/response contracts
- `WithNotificationExpectation<TNotification>()` - Define notification contracts
- `WithCommandFailureExpectation<TCommand, TResponse>()` - Define expected error responses for commands
- `WithQueryFailureExpectation<TQuery, TResponse>()` - Define expected error responses for queries
- `BuildAsync()` - Build the Pact and write to configured directory
- `GetMockServerUri()` - Get mock server URI for testing
- Automatic HTTP status code mapping from Encina error codes

**EncinaPactProviderVerifier Implementation**:

- `WithProviderName()` - Set the provider name for verification
- `WithProviderState(stateName, Action)` - Register synchronous provider state setup
- `WithProviderState(stateName, Func<Task>)` - Register async provider state setup
- `WithProviderState(stateName, Func<IDictionary<string,object>, Task>)` - State setup with parameters
- `VerifyAsync(pactFilePath)` - Verify a local Pact JSON file
- `VerifyFromBrokerAsync(brokerUrl, providerName)` - Verify from Pact Broker

**EncinaPactFixture Implementation**:

- Implements `IAsyncLifetime` and `IDisposable` for xUnit lifecycle management
- `CreateConsumer(consumerName, providerName)` - Create a consumer builder
- `CreateVerifier(providerName)` - Create a provider verifier
- `VerifyAsync(consumer, Action<Uri>)` - Verify with sync test action
- `VerifyAsync(consumer, Func<Uri, Task>)` - Verify with async test action
- `VerifyProviderAsync(providerName)` - Verify all Pact files for a provider
- `WithEncina(encina, serviceProvider)` - Configure with Encina instance
- `WithServices(configureServices)` - Configure with DI services

**PactExtensions Implementation**:

- `CreatePactHttpClient(Uri)` - Create HTTP client for mock server
- `SendCommandAsync<TCommand, TResponse>()` - Send command to mock server
- `SendQueryAsync<TQuery, TResponse>()` - Send query to mock server
- `PublishNotificationAsync<TNotification>()` - Publish notification to mock server
- `ReadAsEitherAsync<TResponse>()` - Deserialize response as Either result
- `ToPactResponse<TResponse>()` - Convert Either to Pact-compatible response

**Response Types**:

- `PactSuccessResponse<T>` - Success response wrapper with `IsSuccess` and `Data`
- `PactErrorResponse` - Error response with `IsSuccess`, `ErrorCode`, `ErrorMessage`
- `PactVerificationResult` - Verification result with `Success`, `Errors`, `InteractionResults`
- `InteractionVerificationResult` - Individual interaction result with `Description`, `Success`, `ErrorMessage`

**Error Code Mapping** (Automatic HTTP status code mapping):

- `encina.validation.*` → 400 Bad Request
- `encina.authorization.*` → 403 Forbidden
- `encina.authentication.*` → 401 Unauthorized
- `encina.notfound.*` → 404 Not Found
- `encina.conflict.*` → 409 Conflict
- `encina.timeout.*` → 408 Request Timeout
- `encina.ratelimit.*` → 429 Too Many Requests
- Other errors → 500 Internal Server Error

**Tests Created**:

- `EncinaPactConsumerBuilderTests.cs` - 17 unit tests
- `EncinaPactProviderVerifierTests.cs` - 24 unit tests
- `EncinaPactFixtureTests.cs` - 23 unit tests
- `PactExtensionsTests.cs` - 14 unit tests
- `GuardClauseTests.cs` - 40 guard clause tests
- Total: 118 tests, all passing

**Dependencies Added**:

- PactNet v5.0.1 added to `Directory.Packages.props`
- Package added to `Encina.slnx` solution file

**Design Decisions**:

1. Use PactNet 5.0.1 (latest stable) with V4 specification support
2. Custom `XunitOutputAdapter` instead of `PactNet.Output.Xunit` package (not needed in 5.x)
3. Fluent builder pattern for consumer expectations
4. Automatic error code to HTTP status code mapping
5. Support for both sync and async provider state handlers
6. RS0026 suppressed for constructors - Pre-1.0, no backward compatibility needed
7. Generic constraints (e.g., `where TCommand : ICommand<TResponse>`) for type safety

**Test Types Justification**:

- Unit Tests: ✅ 118 tests covering all public APIs
- Guard Clause Tests: ✅ 40 tests in `GuardClauseTests.cs`
- Property-Based Tests: ⏭️ Not applicable - CDC testing is contract-based, not property-based
- Integration Tests: ⏭️ Not implemented - would require real HTTP servers and Pact Broker
- Contract Tests: ⏭️ Meta - package provides contract testing, not tested with contracts
- Load Tests: ⏭️ Not applicable - test utilities, not runtime code
- Benchmarks: ⏭️ Not applicable - test utilities, not runtime code

---

## Week 1: January 5-6 (Dogfooding Initiative)

### January 5 - Dogfooding Initiative Setup (Issues #498-502)

#### Epic: Dogfooding Testing Infrastructure (#498)

Created comprehensive testing refactoring plan to use Encina.Testing infrastructure across all test projects.

**Child Issues Created**:

- #499 - Dogfood Phase 1: Core package tests (Encina) - **CLOSED**
- #500 - Dogfood Phase 2: DomainModeling package tests - **CLOSED**
- #501 - Dogfood Phase 3: Messaging package tests - **CLOSED**
- #502 - Dogfood Phase 4: Database provider tests (ADO, Dapper, EF Core)
- #503-#508 - Additional phases (Caching, Transports, Web, Resilience, Validation, Serverless)
- #509 - Investigation: Aspire Testing vs Testcontainers

**Goals**:

- 100% of tests use `Encina.Testing.*` packages
- 0 direct references to xUnit/NSubstitute/Testcontainers outside Testing packages
- Coverage ≥85% lines in all packages
- Tests serve as documentation and usage examples

### January 5-6 - Dogfood Phase 4: Database Provider Tests (#502)

#### Test Infrastructure Improvements

**FsCheck-Bogus Bridge** (Issue #502):

- Created `BogusArbitrary<T>` class bridging Bogus Faker with FsCheck generators
- Added `MessageDataGenerators` with pre-built generators for messaging entities:
  - `OutboxMessageDataGen()` - Generates OutboxMessageData instances
  - `InboxMessageDataGen()` - Generates InboxMessageData instances
  - `SagaStateDataGen()` - Generates SagaStateData instances
  - `ScheduledMessageDataGen()` - Generates ScheduledMessageData instances
- Each generator produces realistic test data using Bogus (not random garbage)

**TimeProvider Support for Dapper Stores**:

- Added `TimeProvider` injection to all Dapper store implementations
- Enables deterministic time control in tests using `FakeTimeProvider`
- Fixes SQLite datetime format incompatibility (ISO 8601 vs datetime('now'))

**Test Fixes Applied**:

| Provider | Test Type | Issue | Fix |
|----------|-----------|-------|-----|
| ADO.Sqlite | GuardTests | Missing using statement | Added `using Encina.Messaging;` |
| ADO.Sqlite | ContractTests | Wrong tag assertion | Removed incorrect "sqlite" tag expectation |
| ADO.* | GuardTests | Parameter name mismatch | Changed "next" to "nextStep" |
| Dapper.SqlServer | GuardTests | Parameter name mismatch | Changed "next" to "nextStep" |
| Dapper.Sqlite | GuardTests | Parameter name mismatch | Changed "next" to "nextStep" |
| EF Core | ContractTests | Invalid regex pattern | Changed `ShouldMatch("*Type*")` to `ShouldContain("Type")` |
| EF Core | PropertyTests | Missing tags | Added `DefaultTags` to `EntityFrameworkCoreHealthCheck` |
| EF Core | IntegrationTests | Nullable reference | Added null-forgiving operators |
| EF Core | IntegrationTests | Wrong method call | Changed `Count` to `Count()` |
| EF Core | IntegrationTests | Status enum mapping | Added `HasConversion<string>()` for SagaStatus |

**Test Results After Fixes**:

| Provider | Tests | PropertyTests | ContractTests | GuardTests | IntegrationTests | Total |
|----------|-------|---------------|---------------|------------|------------------|-------|
| ADO.Sqlite | 5 ✅ | 93 ✅ | 52 ✅ | 19 ✅ | 40 ✅ | 209 |
| EF Core | 61 ✅ | 53 ✅ | 43 ✅ | 25 ✅ | 37 ✅ | 219 |

### January 6 - Solution Filter Reorganization

Updated all solution filters (`.slnf` files) to include all corresponding test projects.

**Solution Filters Updated**:

| File | Changes |
|------|---------|
| `Encina.Core.slnf` | Added DomainModeling and all its tests |
| `Encina.Messaging.slnf` | Added TestInfrastructure |
| `Encina.EventSourcing.slnf` | Added TestInfrastructure, Marten.IntegrationTests |
| `Encina.Observability.slnf` | Added Messaging, TestInfrastructure |
| `Encina.Validation.slnf` | Added GuardClauses.Tests, reorganized |
| `Encina.Web.slnf` | Added SignalR, gRPC and tests |
| `Encina.Scheduling.slnf` | Reorganized TestInfrastructure |
| `Encina.Testing.slnf` | Added FsCheck, Verify, Testcontainers, Architecture, Aspire (32 projects) |
| `Encina.Database.slnf` | Full expansion - all 85 database provider test projects |
| `Encina.Caching.slnf` | Added TestInfrastructure, Redis.Tests |
| `Encina.Resilience.slnf` | Added TestInfrastructure |

**New Solution Filters Created**:

| File | Purpose |
|------|---------|
| `Encina.Transports.slnf` | RabbitMQ, Kafka, AzureServiceBus, AmazonSQS, NATS, MQTT |
| `Encina.Serverless.slnf` | AwsLambda, AzureFunctions |
| `Encina.DistributedLock.slnf` | DistributedLock, Redis, SqlServer |
| `Encina.Cli.slnf` | CLI tool |
| `Encina.Workflows.slnf` | Workflows |

**Files Modified**:

- `src/Encina.EntityFrameworkCore/Health/EntityFrameworkCoreHealthCheck.cs` - Added DefaultTags
- `tests/Encina.EntityFrameworkCore.IntegrationTests/TestEFDbContext.cs` - Added SagaStatus string conversion
- `tests/Encina.TestInfrastructure/Schemas/SqlServerSchema.cs` - Fixed schema definitions
- `tests/Encina.TestInfrastructure/PropertyTests/MessageDataGenerators.cs` - New FsCheck-Bogus bridge
- Multiple `*GuardTests.cs` files - Fixed parameter name assertions
- Multiple `*ContractTests.cs` files - Fixed regex assertions
- All `.slnf` files - Updated with complete test project lists

---

Last Updated: 2026-01-06
