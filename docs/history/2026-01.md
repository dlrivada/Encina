# January 2026 - Implementation History

This document captures the detailed implementation history for Encina during January 2026.

## Summary

January 2026 continues the v0.11.0 Testing Infrastructure milestone, building on December 2025's testing foundation.

| Category | Packages Updated | New Features | Tests Added |
|----------|-----------------|--------------|-------------|
| Testing Core | 3 | 6 phases complete | 57 |
| Testing WireMock | 1 | Refit + Webhooks | 147 |

---

## Week 1: January 1 (Testing Infrastructure)

### January 1 - Enhanced Testing Fixtures (Issue #444)

**Commits**: Phase 1 of Enhanced Testing Fixtures

**EncinaTestFixture Implementation**:
- Created `EncinaTestFixture` class with fluent builder pattern for test setup
- Added fake store configuration methods:
  - `WithMockedOutbox()` - Register FakeOutboxStore
  - `WithMockedInbox()` - Register FakeInboxStore
  - `WithMockedSaga()` - Register FakeSagaStore
  - `WithMockedScheduling()` - Register FakeScheduledMessageStore
  - `WithMockedDeadLetter()` - Register FakeDeadLetterStore
  - `WithAllMockedStores()` - Enable all fake stores at once
- Added handler registration:
  - `WithHandler<THandler>()` - Register request or notification handler
- Added service registration:
  - `WithService<TService>(instance)` - Register singleton instance
  - `WithService<TService, TImplementation>()` - Register with implementation type
- Added configuration:
  - `WithConfiguration(Action<EncinaConfiguration>)` - Custom Encina configuration
- Added test execution:
  - `SendAsync<TResponse>(IRequest<TResponse>)` - Send request and return context
  - `PublishAsync(INotification)` - Publish notification and return context
- Properties for store access: `Outbox`, `Inbox`, `SagaStore`, `ScheduledMessageStore`, `DeadLetterStore`
- `ClearStores()` for test isolation between tests
- Implements `IDisposable`, `IAsyncDisposable`, `IAsyncLifetime` for xUnit

**EncinaTestContext Implementation**:
- Created `EncinaTestContext<TResponse>` for chainable assertions after `SendAsync()`
- Result assertions:
  - `ShouldSucceed()` - Assert result is success (Right)
  - `ShouldFail()` - Assert result is error (Left)
  - `ShouldSucceedWith(Action<TResponse>)` - Assert success and verify value
  - `ShouldFailWith(Action<EncinaError>)` - Assert error and verify details
  - `ShouldSatisfy(Action<TResponse>)` - Custom verification
- Outbox assertions:
  - `OutboxShouldContain<TNotification>()` - Verify notification in outbox
  - `OutboxShouldBeEmpty()` - Verify no outbox messages
  - `OutboxShouldContainExactly(count)` - Verify exact message count
- Saga assertions:
  - `SagaShouldBeStarted<TSaga>()` - Verify saga was started
- Value extraction:
  - `GetSuccessValue()` - Get success value or throw
  - `GetErrorValue()` - Get error value or throw
- Properties:
  - `Result` - Access raw `Either<EncinaError, TResponse>`
  - `And` - Fluent chaining (returns `this`)
  - `IsSuccess`, `IsError` - Check result state
- Implicit conversion to `Either<EncinaError, TResponse>`

**Tests Created**:
- `EncinaTestFixtureTests.cs` - 17 unit tests for EncinaTestFixture
- `EncinaTestContextTests.cs` - 17 unit tests for EncinaTestContext
- All 179 tests passing

**Files Created/Modified**:
- `src/Encina.Testing/EncinaTestFixture.cs` (NEW - 427 lines)
- `src/Encina.Testing/EncinaTestContext.cs` (NEW - 341 lines)
- `src/Encina.Testing/Encina.Testing.csproj` (MODIFIED - added Encina.Testing.Fakes reference)
- `tests/Encina.Testing.Tests/EncinaTestFixtureTests.cs` (NEW - 285 lines)
- `tests/Encina.Testing.Tests/EncinaTestContextTests.cs` (NEW - 333 lines)

**Design Decisions**:
- `EncinaTestContext` constructor is internal - use `fixture.SendAsync()` to create
- Auto-build on first service access (no need to call `Build()` explicitly)
- Reference to `Encina.Testing.Fakes` for fake store implementations
- Fluent API returns `this` for method chaining

### January 1 (cont.) - Phase 3: Saga Time-Travel Testing (Issue #444)

**Time-Travel in EncinaTestFixture**:
- `WithFakeTimeProvider()` - Configure FakeTimeProvider with current time
- `WithFakeTimeProvider(DateTimeOffset)` - Configure FakeTimeProvider with specific start time
- `AdvanceTimeBy(TimeSpan)` - Advance fake time by duration
- `AdvanceTimeByMinutes(int)`, `AdvanceTimeByHours(int)`, `AdvanceTimeByDays(int)` - Convenience methods
- `SetTimeTo(DateTimeOffset)` - Set fake time to specific value
- `GetCurrentTime()` - Get current fake time
- `TimeProvider` property for direct FakeTimeProvider access

**Time-Travel in EncinaTestContext**:
- `ThenAdvanceTimeBy(TimeSpan)` - Chainable time advancement
- `ThenAdvanceTimeByMinutes(int)`, `ThenAdvanceTimeByHours(int)`, `ThenAdvanceTimeByDays(int)`
- `ThenSetTimeTo(DateTimeOffset)` - Set time in chainable context

**Saga State Assertions**:
- `SagaShouldHaveTimedOut<TSaga>()` - Assert saga timed out
- `SagaShouldHaveCompleted<TSaga>()` - Assert saga completed
- `SagaShouldBeCompensating<TSaga>()` - Assert saga is compensating
- `SagaShouldHaveFailed<TSaga>()` - Assert saga failed

**Tests Created**:
- 12 new tests for time-travel functionality in EncinaTestFixtureTests
- 8 new tests for time-travel context chaining in EncinaTestContextTests
- 5 new tests for saga state assertions

### January 1 (cont.) - Phase 5: Snapshot Testing Enhancements (Issue #444)

**New Snapshot Helpers in EncinaVerify**:
- `PrepareHandlerResult<TRequest, TResponse>()` - Complete handler result with request context
- `PrepareSagaStates(IEnumerable<ISagaState>)` - Multiple saga states sorted by ID
- `PrepareValidationError(EncinaError)` - Validation error with code detection
- `PrepareTestScenario<TResponse>()` - Combined result + outbox + sagas snapshot

**New Extension Methods**:
- `EncinaTestContextExtensions.ForVerify<TResponse>()` - Either → snapshot-ready object
- `EncinaTestContextExtensions.SuccessForVerify<TResponse>()` - Success value for verification
- `EncinaTestContextExtensions.ErrorForVerify<TResponse>()` - Error for verification

**New Snapshot Types**:
- `HandlerResultSnapshot<TRequest, TResponse>` - Handler result with request
- `ErrorSnapshot` - Error with message and code
- `ValidationErrorSnapshot` - Validation error with detection flag
- `TestScenarioSnapshot<TResponse>` - Complete test scenario

### January 1 (cont.) - Phase 6: Contract Testing Enhancements (Issue #444)

**New Architecture Rules in EncinaArchitectureRules**:
- `RequestsShouldFollowNamingConvention()` - Requests end with Command/Query
- `AggregatesShouldFollowPattern(namespace)` - Aggregates should be sealed
- `ValueObjectsShouldBeSealed()` - Value objects should be sealed
- `SagasShouldBeSealed()` - Sagas should be sealed
- `StoreImplementationsShouldBeSealed()` - Store implementations should be sealed
- `EventHandlersShouldBeSealed()` - Event handlers should be sealed

**New Builder Methods in EncinaArchitectureRulesBuilder**:
- `EnforceRequestNaming()` - Enforce request naming convention
- `EnforceSealedAggregates(namespace)` - Enforce sealed aggregates
- `EnforceSealedValueObjects()` - Enforce sealed value objects
- `EnforceSealedSagas()` - Enforce sealed sagas
- `EnforceSealedEventHandlers()` - Enforce sealed event handlers

**Updated ApplyAllStandardRules()**:
- Now includes `EnforceSealedEventHandlers()` (saga rules moved to opt-in)

**New ApplyAllSagaRules()**:
- Opt-in method for saga-specific rules
- Includes `EnforceSealedSagas()` and `EnforceSealedSagaData()`

**Tests**: All 202 tests passing

### January 1 (cont.) - WireMock.NET Integration Enhancement (Issue #164)

**EncinaRefitMockFixture<TApiClient> Implementation**:
- Generic xUnit fixture for testing Refit API clients with WireMock
- Auto-configured Refit client via `CreateClient()` method
- HTTP method stubs: `StubGet()`, `StubPost()`, `StubPut()`, `StubPatch()`, `StubDelete()`
- Generic stub: `Stub()` with method, path, request configuration, response
- Error simulation: `StubError()` with status code and optional error response
- Delay simulation: `StubDelay()` for timeout testing
- Request verification: `VerifyCallMade()`, `VerifyNoCallsMade()`
- Server management: `Reset()`, `ResetRequestHistory()`
- Implements `IAsyncLifetime` for xUnit integration

**WebhookTestingExtensions Implementation**:
- Extension methods for EncinaWireMockFixture for webhook testing
- `SetupWebhookEndpoint()` - Generic webhook endpoint (POST requests)
- `SetupOutboxWebhook()` - Outbox pattern webhook (JSON POST, default path `/webhooks/outbox`)
- `SetupWebhookFailure()` - Simulate webhook failures with status code and error message
- `SetupWebhookTimeout()` - Simulate webhook timeouts with configurable delay
- `VerifyWebhookReceived()` - Verify webhook was called with expected count
- `VerifyNoWebhooksReceived()` - Verify no webhooks were sent
- `GetReceivedWebhooks()` - Get all received webhook requests
- `GetReceivedWebhookBodies<T>()` - Deserialize webhook bodies to typed objects

**Test Files Created**:
- `EncinaRefitMockFixtureTests.cs` - 25 tests for Refit fixture functionality
- `WebhookTestingExtensionsTests.cs` - 27 tests for webhook extensions
- `FaultSimulationTests.cs` - 14 tests for fault simulation
- `SequenceTests.cs` - 10 tests for request sequencing
- `GuardClauseTests.cs` - 34 tests for argument validation

**Test Coverage**:
- 147 total tests in Encina.Testing.WireMock.Tests
- Unit tests: All fixture methods tested
- Fault simulation: EmptyResponse, MalformedResponse, Timeout, HTTP error codes
- Sequence tests: Request ordering, timestamp capture, workflow verification
- Guard clause tests: Null checks, empty string validation

**Justification for Omitted Test Types**:
- Property-based tests: Not applicable - WireMock.NET is already well-tested; invariants are trivial
- Contract tests: Not applicable - no public interfaces to implement, only concrete fixtures
- Load tests: Not applicable - performance depends on WireMock.NET, not our wrapper
- Benchmarks: Not applicable - same reason as load tests

**Files Created/Modified**:
- `src/Encina.Testing.WireMock/EncinaRefitMockFixture.cs` (NEW - 314 lines)
- `src/Encina.Testing.WireMock/WebhookTestingExtensions.cs` (NEW - 238 lines)
- `src/Encina.Testing.WireMock/Encina.Testing.WireMock.csproj` (MODIFIED - added Refit references)
- `tests/Encina.Testing.WireMock.Tests/EncinaRefitMockFixtureTests.cs` (NEW - 280 lines)
- `tests/Encina.Testing.WireMock.Tests/WebhookTestingExtensionsTests.cs` (NEW - 210 lines)
- `tests/Encina.Testing.WireMock.Tests/FaultSimulationTests.cs` (NEW - 140 lines)
- `tests/Encina.Testing.WireMock.Tests/SequenceTests.cs` (NEW - 180 lines)
- `tests/Encina.Testing.WireMock.Tests/GuardClauseTests.cs` (NEW - 250 lines)
- `tests/Encina.Testing.WireMock.Tests/ReceivedRequestTests.cs` (MODIFIED - fixed header type)
- `tests/Encina.Testing.WireMock.Tests/Encina.Testing.WireMock.Tests.csproj` (MODIFIED - added Refit)

**Design Decisions**:
- Used alias `WireMockRequestBuilder` to resolve ambiguity between Refit.IRequestBuilder and WireMock.RequestBuilders.IRequestBuilder
- WebhookTestingExtensions extend EncinaWireMockFixture (not generic) for simplicity
- Default JSON serialization with camelCase naming policy
- Webhook extensions use `ArgumentNullException.ThrowIfNull()` for null fixture validation

---

## Issue Progress (v0.11.0 - Testing Infrastructure)

| Issue | Title | Status |
|-------|-------|--------|
| #161 | Test Data Generation | ✅ Completed (Dec 2025) |
| #162 | Testcontainers Integration | ✅ Completed (Dec 2025) |
| #163 | Database Reset (Respawn) | ✅ Completed (Jan 2026) |
| #165 | Snapshot Testing (Verify) | ✅ Completed (Dec 2025) |
| #426 | Testing.Fakes | ✅ Completed (Dec 2025) |
| #427 | Testing.Respawn | ✅ Completed (Dec 2025) |
| #428 | Testing.WireMock (base) | ✅ Completed (Dec 2025) |
| #164 | WireMock Refit + Webhooks | ✅ Completed (Jan 2026) |
| #429 | Testing.Shouldly | ✅ Completed (Dec 2025) |
| #430 | Testing.Verify | ✅ Completed (Dec 2025) |
| #431 | Testing.Bogus | ✅ Completed (Dec 2025) |
| #432 | Testing.Architecture | ✅ Completed (Dec 2025) |
| #444 | Enhanced Testing Fixtures | ✅ All 6 Phases Completed |
| #495 | AggregateTestBase | ✅ Completed (Dec 2025) |
| #362 | Module Testing Utilities | ✅ Completed (Jan 2026) |

---

## Completed Phases (Issue #444)

Issue #444 "Enhanced Testing Fixtures" - All 6 phases completed on January 1, 2026:

| Phase | Description | Status | Package |
|-------|-------------|--------|---------|
| Phase 1 | EncinaTestFixture fluent fixture | ✅ Completed | Encina.Testing |
| Phase 2 | Enhanced Either assertions in Shouldly | ✅ Already exists | Encina.Testing.Shouldly |
| Phase 3 | Saga time-travel testing | ✅ Completed | Encina.Testing |
| Phase 4 | Outbox/Inbox assertion helpers | ✅ Completed | Encina.Testing |
| Phase 5 | Snapshot testing enhancements | ✅ Completed | Encina.Testing.Verify |
| Phase 6 | Contract testing enhancements | ✅ Completed | Encina.Testing.Architecture |

---

## References

- [Issue #444 - Enhanced Testing Fixtures](https://github.com/dlrivada/Encina/issues/444)
- [v0.11.0 Testing Infrastructure Milestone](https://github.com/dlrivada/Encina/milestone/8)

---

## Issue #170: Improved Assertions with Shouldly

**Date**: January 1, 2026

**Summary**: Enhanced `Encina.Testing` and `Encina.Testing.Shouldly` with fluent chaining assertions (AndConstraint pattern), collection assertions, and streaming assertions for `IAsyncEnumerable<Either<TLeft, TRight>>`.

### Phase 1: AndConstraint Pattern

**New Classes** (`src/Encina.Testing/Assertions/`):

1. **`AndConstraint<T>`** - Fluent chaining for assertions (FluentAssertions-style):
   - `Value` property for accessing the asserted value
   - `And` property returning `this` for fluent chaining
   - `ShouldSatisfy(Action<T>)` for custom assertions
   - Implicit conversion to underlying `T` type

2. **`AndConstraintAsync<T>`** - Async variant for `Task<T>` results:
   - `Value` property returning `Task<T>`
   - `ShouldSatisfyAsync(Func<T, Task>)` for async assertions
   - `AsSync()` to materialize and get `AndConstraint<T>`

**EitherAssertions Enhancements**:
- `ShouldBeSuccessAnd()`, `ShouldBeRightAnd()` → `AndConstraint<TRight>`
- `ShouldBeErrorAnd()`, `ShouldBeLeftAnd()` → `AndConstraint<TLeft>`
- EncinaError `*And` variants: `ShouldBeErrorWithCodeAnd()`, `ShouldBeValidationErrorAnd()`, `ShouldBeAuthorizationErrorAnd()`, `ShouldBeNotFoundErrorAnd()`, `ShouldBeErrorContainingAnd()`
- New: `ShouldBeValidationErrorForProperty()` and `ShouldBeValidationErrorForPropertyAnd()` for property-specific validation errors
- Async `*And` variants for all methods

### Phase 2: Collection Assertions

**New Class**: `EitherCollectionAssertions` (`src/Encina.Testing/Assertions/`):

- **All/Error Assertions**:
  - `ShouldAllBeSuccess()`, `ShouldAllBeSuccessAnd()` - All results must be Right
  - `ShouldAllBeError()`, `ShouldAllBeErrorAnd()` - All results must be Left

- **Contains Assertions**:
  - `ShouldContainSuccess()`, `ShouldContainSuccessAnd()` - At least one Right
  - `ShouldContainError()`, `ShouldContainErrorAnd()` - At least one Left

- **Count Assertions**:
  - `ShouldHaveSuccessCount(n)`, `ShouldHaveSuccessCountAnd(n)`
  - `ShouldHaveErrorCount(n)`, `ShouldHaveErrorCountAnd(n)`

- **EncinaError-Specific**:
  - `ShouldContainValidationErrorFor(propertyName)` - Find validation error for property
  - `ShouldNotContainAuthorizationErrors()` - No auth errors in collection
  - `ShouldContainAuthorizationError()` - At least one auth error
  - `ShouldAllHaveErrorCode(code)` - All errors have same code

- **Helper Methods**:
  - `GetSuccesses()`, `GetErrors()` - Extract values/errors from collection

- **Async Variants**: `ShouldAllBeSuccessAsync()`, `ShouldAllBeErrorAsync()`, `ShouldContainSuccessAsync()`, `ShouldContainErrorAsync()`

### Phase 3: Streaming Assertions

**New Classes**:

1. **`StreamingAssertions`** (`src/Encina.Testing/Assertions/`) - xUnit-based:
   - `CollectAsync()` - Materialize `IAsyncEnumerable` to `List<T>`
   - All collection assertions with `Async` suffix for streams
   - `FirstShouldBeSuccessAsync()`, `FirstShouldBeErrorAsync()` - First item assertions
   - `ShouldBeEmptyAsync()`, `ShouldNotBeEmptyAsync()` - Stream emptiness
   - `ShouldHaveCountAsync(n)` - Total item count
   - EncinaError-specific streaming assertions

2. **`StreamingShouldlyExtensions`** (`src/Encina.Testing.Shouldly/`) - Shouldly-based:
   - Same API as `StreamingAssertions` but using `ShouldAssertException`
   - Consistent with existing `EitherCollectionShouldlyExtensions`

### Phase 4: Test Coverage

**New Test Files**:
- `tests/Encina.Testing.Tests/EitherAssertionsTests.cs` - 30+ new tests for AndConstraint
- `tests/Encina.Testing.Tests/EitherCollectionAssertionsTests.cs` - 25+ tests for collections
- `tests/Encina.Testing.Tests/StreamingAssertionsTests.cs` - 30+ tests for streaming

**Total**: 444 tests passing

### Test Types Justification

| Test Type | Status | Justification |
|-----------|--------|---------------|
| Unit Tests | ✅ 85+ tests | All assertion methods covered |
| Property-Based | ⏭️ Not applicable | Assertions are deterministic |
| Guard Clause | ⏭️ Not applicable | Null checks use `ArgumentNullException.ThrowIfNull` |
| Integration | ⏭️ Not applicable | Pure assertion methods, no external deps |
| Contract | ⏭️ Not applicable | Extension methods, not interfaces |
| Load/Benchmark | ⏭️ Not applicable | Assertions run at test-time |

### CodeRabbit Plan Execution

Following CodeRabbit's 4-phase plan:
1. ✅ Phase 1: AndConstraint pattern with `And` chaining
2. ✅ Phase 2: Collection assertions with EncinaError specifics
3. ✅ Phase 3: Streaming assertions for `IAsyncEnumerable`
4. ✅ Phase 4: Comprehensive unit tests

---

## Issue #362 - Module Testing Utilities

**Date**: 2026-01-02
**Milestone**: v0.11.0 - Testing Infrastructure
**Package**: Encina.Testing

### Overview

Module Testing Utilities provide comprehensive testing infrastructure for modular monolith applications. This implementation enables isolated module testing with dependency mocking, integration event assertions, and architecture verification.

### Components Implemented

#### ModuleTestFixture<TModule>
Fluent test fixture for isolated module testing:

```csharp
using var fixture = new ModuleTestFixture<OrdersModule>()
    .WithMockedModule<IInventoryModuleApi>(mock =>
        mock.Setup("ReserveStockAsync", (string id, int qty) =>
            Task.FromResult(Right<EncinaError, string>("reserved"))))
    .WithFakeModule<IPaymentModuleApi, FakePaymentModule>()
    .WithAllMockedStores()
    .WithFakeTimeProvider();

var result = await fixture.SendAsync(new PlaceOrderCommand(...));

result.ShouldSucceed();
fixture.IntegrationEvents.ShouldContain<OrderPlacedEvent>();
```

**Features**:
- `WithMockedModule<T>()` - Mock dependent modules via fluent API or instance
- `WithFakeModule<T, TFake>()` - Register fake implementations
- `WithAllMockedStores()` - Configure all messaging stores
- `WithFakeTimeProvider()` - Time-travel testing support
- `SendAsync()`, `PublishAsync()` - Execute requests capturing events
- `ClearStores()` - Reset state between tests

#### IntegrationEventCollector
Thread-safe collection for integration event assertions:

```csharp
fixture.IntegrationEvents.ShouldContain<OrderPlacedEvent>();
fixture.IntegrationEvents.ShouldContain<OrderPlacedEvent>(e => e.OrderId == expectedId);
fixture.IntegrationEvents.ShouldContainSingle<OrderConfirmedEvent>();
fixture.IntegrationEvents.ShouldBeEmpty();
fixture.IntegrationEvents.ShouldHaveCount(3);
```

#### MockModuleApi<T>
Simple mock builder using DispatchProxy:

```csharp
var mock = new MockModuleApi<IInventoryModuleApi>()
    .Setup("GetAvailableStock", (string id) =>
        Right<EncinaError, int>(42))
    .Setup("ReserveStockAsync", (string id, int qty) =>
        Task.FromResult(Right<EncinaError, string>("reserved")))
    .SetupProperty("ModuleName", "Inventory");

var api = mock.Build();
```

#### ModuleArchitectureAnalyzer
Module dependency analysis with circular dependency detection:

```csharp
var result = ModuleArchitectureAnalyzer
    .AnalyzeAssemblyContaining<OrdersModule, PaymentsModule>()
    .Result;

result.ShouldHaveNoCircularDependencies();
result.ShouldContainModule("Orders");
result.ShouldHaveDependency("Orders", "Payments");
result.ShouldNotHaveDependency("Payments", "Orders");
```

**Algorithm**: Uses DFS (Depth-First Search) for cycle detection in the module dependency graph.

#### ModuleArchitectureRules
Pre-built ArchUnitNET rules:

```csharp
ModuleArchitectureRules.ModulesShouldBeSealed()
    .Check(architecture);

ModuleArchitectureRules.IntegrationEventsShouldBeSealed()
    .Check(architecture);

ModuleArchitectureRules.DomainShouldNotDependOnInfrastructure(
    "MyApp.Orders.Domain",
    "MyApp.Orders.Infrastructure")
    .Check(architecture);
```

### Files Created

| File | Purpose |
|------|---------|
| `src/Encina.Testing/Modules/ModuleTestFixture.cs` | Main test fixture |
| `src/Encina.Testing/Modules/ModuleTestContext.cs` | Fluent assertion context |
| `src/Encina.Testing/Modules/IntegrationEventCollector.cs` | Event capture & assertions |
| `src/Encina.Testing/Modules/MockModuleApi.cs` | DispatchProxy-based mocking |
| `src/Encina.Testing/Modules/ModuleArchitectureRules.cs` | ArchUnitNET rules |
| `src/Encina.Testing/Modules/ModuleArchitectureAnalyzer.cs` | Dependency analysis |
| `tests/Encina.Testing.Tests/Modules/ModuleTestFixtureTests.cs` | Fixture tests |
| `tests/Encina.Testing.Tests/Modules/IntegrationEventCollectorTests.cs` | Collector tests |
| `tests/Encina.Testing.Tests/Modules/MockModuleApiTests.cs` | Mock builder tests |
| `tests/Encina.Testing.Tests/Modules/ModuleArchitectureAnalyzerTests.cs` | Analyzer tests |

### Dependencies Added

- `TngTech.ArchUnitNET.xUnit` - Architecture testing rules
- `Shouldly` - Fluent assertions

### Test Coverage

| Test Type | Status | Tests | Justification |
|-----------|--------|-------|---------------|
| Unit Tests | ✅ | 87 | Core functionality, all public APIs |
| Property-Based | ⏭️ | N/A | Test utilities don't have invariants |
| Guard Clause | ✅ | Included | ArgumentNullException checks |
| Integration | ⏭️ | N/A | In-memory test infrastructure |
| Contract | ⏭️ | N/A | Internal implementation |
| Load/Benchmark | ⏭️ | N/A | Test-time only, not runtime |

### Technical Notes

1. **DispatchProxy Requirement**: The `MockProxy<T>` class cannot be sealed because `DispatchProxy.Create` generates a derived type dynamically.

2. **ConcurrentBag Order**: `IntegrationEventCollector` uses `ConcurrentBag` which doesn't guarantee insertion order. Tests verify event presence, not order.

3. **Circular Dependency Detection**: Uses standard DFS algorithm with visited/recursion-stack tracking. O(V+E) complexity where V=modules, E=dependencies.

4. **InternalsVisibleTo**: Added to allow tests access to `internal Add()` method on `IntegrationEventCollector`.

---

## Issue #172 - Mutation Testing Helper Attributes

**Date**: 2026-01-02
**Milestone**: v0.11.0 - Testing Infrastructure
**Package**: Encina.Testing

### Overview

Added helper attributes to the `Encina.Testing.Mutations` namespace for documenting and tracking mutation testing insights directly in test code. These attributes follow the existing Stryker.NET integration and enhance the mutation testing workflow.

### Components Implemented

#### NeedsMutationCoverageAttribute

Marks tests identified as mutation-weak during Stryker analysis:

```csharp
[Fact]
[NeedsMutationCoverage("Boundary condition not verified", MutantId = "280", Line = 45)]
public void Calculate_BoundaryValue_ShouldReturnExpectedResult()
{
    // Test needs stronger assertions
}
```

**Properties**:
- `Reason` (required) - Description of mutation coverage gap
- `MutantId` (optional) - Stryker mutant ID from report
- `SourceFile` (optional) - Path to source file with surviving mutant
- `Line` (optional) - Line number where mutation was applied

#### MutationKillerAttribute

Documents tests explicitly written to kill specific mutation types:

```csharp
[Fact]
[MutationKiller("EqualityMutation", Description = "Verifies >= is not mutated to >")]
public void IsAdult_ExactlyEighteen_ShouldReturnTrue()
{
    // Boundary test that kills equality mutation
}
```

**Properties**:
- `MutationType` (required) - Type of mutation killed
- `Description` (optional) - Detailed description
- `SourceFile` (optional) - Path to source file
- `TargetMethod` (optional) - Method name
- `Line` (optional) - Line number

### Files Created

| File | Purpose |
|------|---------|
| `src/Encina.Testing/Mutations/NeedsMutationCoverageAttribute.cs` | Attribute for mutation-weak tests |
| `src/Encina.Testing/Mutations/MutationKillerAttribute.cs` | Attribute for mutation killer tests |
| `tests/Encina.Testing.Tests/Mutations/MutationAttributesTests.cs` | Unit tests (24 tests) |
| `tests/Encina.Testing.Tests/Mutations/MutationAttributesGuardClauseTests.cs` | Guard clause tests (23 tests) |

### Documentation Updated

- `docs/en/guides/MUTATION_TESTING.md` - Added "Test Quality Patterns" section with usage examples and best practices

### Test Coverage

| Test Type | Status | Tests | Justification |
|-----------|--------|-------|---------------|
| Unit Tests | ✅ | 24 | Core functionality, all public APIs |
| Guard Clause | ✅ | 23 | Null/empty/whitespace validation |
| Property-Based | ⏭️ | N/A | Attributes are simple data holders |
| Integration | ⏭️ | N/A | Compile-time metadata only |
| Contract | ⏭️ | N/A | No interfaces to implement |
| Load/Benchmark | ⏭️ | N/A | Test-time only, not runtime |

### Design Decisions

1. **AllowMultiple=true**: Both attributes allow multiple instances per test method to document multiple mutation issues or kills.

2. **Inherited=false**: Attributes are not inherited to derived test classes, ensuring explicit documentation.

3. **Sealed classes**: Both attribute classes are sealed following Encina conventions.

4. **Validation**: Both constructors validate that required parameters are not null, empty, or whitespace using `ArgumentException.ThrowIfNullOrWhiteSpace`.

### Bug Fixes (Existing Code)

During implementation, fixed pre-existing issues in `Encina.Testing`:

1. **MockModuleApi.cs**: Fixed duplicate XML documentation and corrected `<see cref>` syntax error
2. **IntegrationEventCollector.cs**: Changed return type from `IReadOnlyList<string>` to `ReadOnlyCollection<string>` to fix CA1859
3. **ModuleArchitectureAnalyzerTests.cs**: Fixed ambiguous constructor call by using named parameter

---

## Issue #497 - ModuleArchitectureAnalyzerTests False Positive Dependency Fix

**Date**: 2026-01-02
**Milestone**: v0.11.0 - Testing Infrastructure
**Package**: Encina.Testing.Tests

### Overview

Fixed failing test `ShouldNotHaveDependency_NoDependency_Passes` in `ModuleArchitectureAnalyzerTests` which was reporting false positive module dependencies.

### Root Cause Analysis

The `ModuleArchitectureAnalyzer` uses namespace prefixes to detect dependencies between modules. The test modules (`OrdersModule`, `PaymentsModule`, `ShippingModule`) were all declared with `file` scope in the same namespace `Encina.Testing.Tests.Modules`, causing the analyzer to detect false dependencies between them.

The dependency detection algorithm in `CheckDependency()`:
1. Gets all types in source module's namespace
2. Checks if any type references types in target module's namespace
3. Since all test modules shared the same namespace, type references were incorrectly flagged as cross-module dependencies

### Solution

Moved test modules to distinct namespaces to simulate real modular architecture:

```csharp
// Before: All in same namespace
namespace Encina.Testing.Tests.Modules;
file sealed class OrdersModule : IModule { ... }
file sealed class PaymentsModule : IModule { ... }
file sealed class ShippingModule : IModule { ... }

// After: Separate namespaces
namespace Encina.Testing.Tests.Modules.TestModules.Orders
{
    internal sealed class OrdersModule : IModule { ... }
}
namespace Encina.Testing.Tests.Modules.TestModules.Payments
{
    internal sealed class PaymentsModule : IModule { ... }
}
namespace Encina.Testing.Tests.Modules.TestModules.Shipping
{
    internal sealed class ShippingModule : IModule { ... }
}
```

### Additional Fix

The test `Result_DiscoversModulesInAssembly` was also adjusted:
- **Before**: Verified exact module count match (expected exactly 3 modules)
- **After**: Verified module containment (expected modules exist among discovered modules)
- **Reason**: Assembly may contain additional test modules from other test files (e.g., `TestModule` from `ModuleTestFixtureTests.cs`)

### Files Modified

| File | Changes |
|------|---------|
| `tests/Encina.Testing.Tests/Modules/ModuleArchitectureAnalyzerTests.cs` | Moved test modules to distinct namespaces; adjusted discovery test |

### Test Results

| Test | Before | After |
|------|--------|-------|
| `ShouldNotHaveDependency_NoDependency_Passes` | ❌ Failing | ✅ Passing |
| `Result_DiscoversModulesInAssembly` | ❌ Failing | ✅ Passing |
| All ModuleArchitectureAnalyzerTests (14 total) | 12 passing | 14 passing |

### Design Insight

This fix reinforces the importance of proper namespace organization when using `ModuleArchitectureAnalyzer`:
- Each module should have its own distinct namespace prefix
- The analyzer uses namespace prefixes as module boundaries
- Test modules should mirror production module structure for accurate analysis

---

Last Updated: 2026-01-02
