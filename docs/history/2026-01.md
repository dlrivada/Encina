# January 2026 - Implementation History

This document captures the detailed implementation history for Encina during January 2026.

> **Historical Note**: File paths referenced in this document reflect the project structure at the time of each entry. Later in January 2026, tests were consolidated from ~210 individual projects into 7 consolidated projects under `tests/`, and solution filters (`.slnf`) were deprecated. See the test consolidation plan in `docs/plans/test-consolidation-plan.md` for details.

## Milestone Completed: v0.11.0 - Testing Infrastructure

> **Completed**: January 19, 2026
>
> The v0.11.0 Testing Infrastructure milestone has been completed with all 34 issues closed.

### Key Achievements

- **34 issues closed** in milestone v0.11.0
- **92.3% code coverage** achieved (exceeds 85% target)
- **0 SonarCloud issues** (all resolved or excluded with justification)
- **6,500+ tests** across all packages
- **10 new testing packages** delivered

### Quality Metrics at Milestone Completion

| Metric | Before | After | Target |
|--------|--------|-------|--------|
| Test Count | 3,800+ | 6,500+ | 5,000+ ✅ |
| Line Coverage | 67% | 92.3% | ≥85% ✅ |
| SonarCloud Issues | Multiple | 0 | 0 ✅ |
| Build Warnings | 0 | 0 | 0 ✅ |

### New Packages Delivered

1. `Encina.Testing.Fakes` - Test doubles for IEncina
2. `Encina.Testing.Respawn` - Database reset
3. `Encina.Testing.WireMock` - HTTP API mocking + Refit + Webhooks
4. `Encina.Testing.Shouldly` - Open-source assertions
5. `Encina.Testing.Verify` - Snapshot testing
6. `Encina.Testing.Bogus` - Test data generation
7. `Encina.Testing.Architecture` - Architectural rules
8. `Encina.Testing.FsCheck` - Property-based testing
9. `Encina.Testing.TUnit` - NativeAOT-compatible testing
10. `Encina.Testing.Pact` - Consumer-Driven Contract Testing

---

## Summary

January 2026 continues the v0.11.0 Testing Infrastructure milestone, building on December 2025's testing foundation.

| Category | Packages Updated | New Features | Tests Added |
|----------|-----------------|--------------|-------------|
| Testing Core | 3 | 6 phases complete | 57 |
| Testing WireMock | 1 | Refit + Webhooks | 147 |
| Testing TUnit | 1 | NativeAOT support | 56 |
| Testing Pact | 1 | CDC Testing | 118 |
| Testing FsCheck | 1 | Property-based testing | 75 |
| Dogfooding (#498) | 10+ | Test infrastructure refactoring | 498+ |
| Solution Filters | 16 | Complete test coverage per area | - |
| Validation Tests | 3 | Phase 9: Property-based tests | 70 |
| Serverless/Scheduling | 6 | Phase 10: FakeLogger + EitherAssertions | 305 |
| Bulk Operations (#284) | 6 | High-performance bulk ops (up to ~459x faster) | 76 |

---

## Week 4: January 22 (Database & Repository)

### January 22 - Bulk Operations (#284)

**Issue**: [#284 - Bulk Operations](https://github.com/dlrivada/Encina/issues/284)

Implemented high-performance bulk database operations across all data access providers, achieving **up to ~459x faster** performance compared to standard loop operations.

**Phase 1-3: Core Implementation** (completed in previous sessions):

- `IBulkOperations<TEntity>` interface in `Encina.DomainModeling`
- `BulkConfig` immutable record with sensible defaults
- `RepositoryErrors` bulk error factory methods with error codes
- Provider implementations:
  - `BulkOperationsEF` (EF Core) using SqlBulkCopy + TVP
  - `BulkOperationsDapper` (Dapper) using SqlBulkCopy + TVP
  - `BulkOperationsADO` (ADO.NET) using SqlBulkCopy + TVP
  - `BulkOperationsMongoDB` (MongoDB) using native BulkWrite

**Phase 4: Testing and Benchmarks**:

Files Created:

- `tests/Encina.UnitTests/DomainModeling/BulkOperations/BulkConfigTests.cs` (30 tests)
- `tests/Encina.UnitTests/DomainModeling/BulkOperations/RepositoryErrorsBulkTests.cs` (35 tests)
- `tests/Encina.IntegrationTests/Infrastructure/EntityFrameworkCore/BulkOperations/BulkOperationsEFIntegrationTests.cs` (11 tests)
- `tests/Encina.IntegrationTests/Infrastructure/Dapper/SqlServer/BulkOperations/BulkOperationsPerformanceTests.cs`
- `tests/Encina.IntegrationTests/Infrastructure/ADO/SqlServer/BulkOperations/BulkOperationsADOPerformanceTests.cs`
- `tests/Encina.IntegrationTests/Infrastructure/MongoDB/BulkOperations/BulkOperationsMongoDBPerformanceTests.cs`
- `tests/Encina.BenchmarkTests/Encina.Benchmarks/BulkOperations/BulkInsertBenchmarks.cs`

Test Results:

- 65 unit tests for BulkConfig and RepositoryErrors
- 11 integration tests for EF Core bulk operations
- Performance tests for all providers
- Total: 76+ tests passing

**Phase 5: Documentation Updates**:

Files Created/Updated:

- `src/Encina.DomainModeling/README.md` (NEW - complete documentation)
- `src/Encina.EntityFrameworkCore/README.md` (added Bulk Operations section)
- `src/Encina.ADO.SqlServer/README.md` (added Bulk Operations section)
- `src/Encina.Dapper.SqlServer/README.md` (enhanced Bulk Operations section)
- `src/Encina.MongoDB/README.md` (NEW - complete documentation with bulk ops)
- `CHANGELOG.md` (added Bulk Operations entry)
- `docs/history/2026-01.md` (this file)

**Performance Metrics** (measured with Testcontainers, 1,000 entities):

| Provider | Database | Insert | Update | Delete |
|----------|----------|--------|--------|--------|
| **Dapper** | SQL Server 2022 | **30x** faster | **125x** faster | **370x** faster |
| **EF Core** | SQL Server 2022 | **112x** faster | **178x** faster | **200x** faster |
| **ADO.NET** | SQL Server 2022 | **104x** faster | **187x** faster | **459x** faster |
| **MongoDB** | MongoDB 7 | **130x** faster | **16x** faster | **21x** faster |

**Key Design Decisions**:

1. **Separate interface from IFunctionalRepository**: Bulk operations are opt-in and don't pollute the repository interface
2. **Immutable BulkConfig**: Uses C# record with `with` expressions for customization
3. **Railway Oriented Programming**: All methods return `Either<EncinaError, T>`
4. **Provider-specific optimizations**: Each provider uses native bulk mechanisms (SqlBulkCopy, MERGE, BulkWrite)
5. **Graceful degradation**: Non-SQL Server providers return descriptive Left errors

---

### January 29 - Domain Entity Base Classes (#292)

**Issue**: [#292 - Domain Entity Base Classes (Entity<TId>, AggregateRoot<TId>)](https://github.com/dlrivada/Encina/issues/292)

Enhanced domain modeling capabilities with comprehensive domain event support and optimistic concurrency control for aggregate roots.

**Phase 1: Entity Hierarchy Enhancement**:

Files Modified:

- `src/Encina.DomainModeling/Entity.cs` - Added `DomainEvents` collection, `AddDomainEvent`, `RemoveDomainEvent`, `ClearDomainEvents`
- `src/Encina.DomainModeling/AggregateRoot.cs` - Added `RaiseDomainEvent` alias, inherits `IConcurrencyAware`
- `src/Encina.DomainModeling/IConcurrencyAware.cs` - Interface with `RowVersion` property
- `src/Encina.DomainModeling/AuditableAggregateRoot.cs` - Inherits from `AggregateRoot<TId>`, implements `IAuditable`
- `src/Encina.DomainModeling/SoftDeletableAggregateRoot.cs` - Inherits from `AuditableAggregateRoot<TId>`, implements `ISoftDeletable`

**Entity Hierarchy**:

| Class | Inherits From | Features |
|-------|---------------|----------|
| `Entity<TId>` | - | Identity, equality, domain events |
| `AggregateRoot<TId>` | `Entity<TId>` | Domain events + `IConcurrencyAware` (RowVersion) |
| `AuditableAggregateRoot<TId>` | `AggregateRoot<TId>` | + `IAuditable` (CreatedAt/By, ModifiedAt/By) |
| `SoftDeletableAggregateRoot<TId>` | `AuditableAggregateRoot<TId>` | + `ISoftDeletable` (IsDeleted, DeletedAt/By) |

**Phase 2: Domain Event Interfaces**:

Files Created:

- `src/Encina.DomainModeling/IDomainEvent.cs` - Base interface with `EventId`, `OccurredAtUtc`

**Phase 3: Non-EF Core Provider Support**:

Files Created:

- `src/Encina.DomainModeling/IDomainEventCollector.cs` - Interface for manual aggregate tracking
- `src/Encina.DomainModeling/DomainEventCollector.cs` - Default implementation (scoped lifetime)
- `src/Encina.DomainModeling/DomainEventDispatchHelper.cs` - Dispatch events via `IPublisher`
- `src/Encina.DomainModeling/DomainEventDispatchErrors.cs` - Structured error factory for dispatch failures

Key Design Decisions:

1. **Composition over inheritance for errors**: `EncinaError` is sealed, so `DomainEventDispatchErrors.CreateAggregateError()` uses factory pattern
2. **Scoped lifetime**: `DomainEventCollector` is scoped to ensure per-request isolation
3. **Railway Oriented Programming**: `DomainEventDispatchHelper.DispatchCollectedEventsAsync()` returns `Either<EncinaError, Unit>`

**Phase 4: EF Core Integration**:

Files Created/Modified:

- `src/Encina.EntityFrameworkCore/DomainEvents/DomainEventDispatcherInterceptor.cs` - SaveChanges interceptor
- `src/Encina.EntityFrameworkCore/DomainEvents/DomainEventDispatcherOptions.cs` - Configuration options
- `src/Encina.EntityFrameworkCore/DomainEvents/DomainEventDispatchException.cs` - Exception with dispatch result
- `src/Encina.EntityFrameworkCore/DomainEvents/DomainEventDispatchResult.cs` - Result record
- `src/Encina.EntityFrameworkCore/Extensions/DbContextOptionsBuilderExtensions.cs` - `UseDomainEventDispatcher()`
- `src/Encina.EntityFrameworkCore/ServiceCollectionExtensions.cs` - `AddDomainEventDispatcher()`
- `src/Encina.EntityFrameworkCore/Extensions/EntityTypeBuilderExtensions.cs` - Configuration helpers

Entity Configuration Helpers:

- `ConfigureConcurrencyToken()` - Sets up `RowVersion` as EF Core concurrency token
- `ConfigureAuditProperties()` - Configures `IAuditable` properties
- `ConfigureSoftDelete()` - Configures `ISoftDeletable` with global query filter
- `ConfigureAggregateRoot()` - Combines all configuration for aggregate roots

**Phase 5: Testing**:

Test Files Created:

- `tests/Encina.UnitTests/DomainModeling/EntityDomainEventsTests.cs` (18 tests)
- `tests/Encina.UnitTests/DomainModeling/AggregateRootConcurrencyTests.cs` (15 tests)
- `tests/Encina.UnitTests/DomainModeling/DomainEventCollectorTests.cs` (45 tests)
- `tests/Encina.UnitTests/EntityFrameworkCore/DomainEvents/DomainEventDispatcherInterceptorTests.cs` (19 tests)
- `tests/Encina.ContractTests/DomainModeling/AggregateRootContractTests.cs` (20 tests)

Test Results:

- 97 unit tests for domain events and concurrency
- 20 contract tests for aggregate root variants
- All tests passing, 0 warnings

**Phase 6: Documentation**:

Files Updated:

- `src/Encina.DomainModeling/README.md` - Added domain events and concurrency sections
- `src/Encina.EntityFrameworkCore/README.md` - Added Domain Event Dispatcher and Entity Configuration Helpers sections
- `CHANGELOG.md` - Added Issue #292 entry
- `docs/history/2026-01.md` (this file)

---

### January 29 - PostgreSQL EF Core Integration Tests Fix (#570)

**Issue**: [#570 - EF Core PostgreSQL integration tests fail due to table name case-sensitivity](https://github.com/dlrivada/Encina/issues/570)

Fixed PostgreSQL integration tests that were failing with "relation does not exist" errors due to PostgreSQL's case-sensitivity with quoted table names.

**Root Cause Analysis**:

PostgreSQL and MySQL schema files were missing `CreateTestRepositorySchemaAsync` methods, and SQL Server used an inconsistent table name (`TestEntities` instead of `TestRepositoryEntities`). When EF Core tests ran, the `TestEFDbContext` configured tables with PascalCase names via `ToTable()` calls, but the schema files didn't create the corresponding tables for PostgreSQL and MySQL.

**Phase 1: Add Missing Schema Methods**:

Files Modified:

- `tests/Encina.TestInfrastructure/Schemas/PostgreSqlSchema.cs`:
  - Added `CreateTestRepositorySchemaAsync(NpgsqlConnection connection)` with quoted identifiers (`"TestRepositoryEntities"`)
  - Updated `DropAllSchemasAsync` to include `DROP TABLE IF EXISTS "TestRepositoryEntities" CASCADE`
  - Updated `ClearAllDataAsync` to include `DELETE FROM "TestRepositoryEntities"`

- `tests/Encina.TestInfrastructure/Schemas/MySqlSchema.cs`:
  - Added `CreateTestRepositorySchemaAsync(MySqlConnection connection)` with backtick quoting (`` `TestRepositoryEntities` ``)
  - Updated `DropAllSchemasAsync` to include `` DROP TABLE IF EXISTS `TestRepositoryEntities` ``
  - Updated `ClearAllDataAsync` to include `` DELETE FROM `TestRepositoryEntities` ``

- `tests/Encina.TestInfrastructure/Schemas/SqlServerSchema.cs`:
  - Renamed table from `TestEntities` to `TestRepositoryEntities` in all statements
  - Updated index name from `IX_TestEntities_IsActive` to `IX_TestRepositoryEntities_IsActive`

**Phase 2: Update Fixtures**:

Files Modified:

- `tests/Encina.TestInfrastructure/Fixtures/PostgreSqlFixture.cs`:
  - Added call to `PostgreSqlSchema.CreateTestRepositorySchemaAsync(npgsqlConnection)` in `CreateSchemaAsync`

- `tests/Encina.TestInfrastructure/Fixtures/MySqlFixture.cs`:
  - Added call to `MySqlSchema.CreateTestRepositorySchemaAsync(mysqlConnection)` in `CreateSchemaAsync`

**Phase 3: Enable Tests**:

Files Modified:

- `tests/Encina.IntegrationTests/Infrastructure/EntityFrameworkCore/PostgreSQL/UnitOfWork/UnitOfWorkEFPostgreSqlTests.cs`:
  - Removed `Skip` attribute from all 5 test methods
  - Removed remarks about case-sensitivity issues

**Schema Consistency Verification**:

All 4 providers now use consistent table name `TestRepositoryEntities`:

| Provider | Table Name | Quoting Style | Index Name |
|----------|------------|---------------|------------|
| SQLite | `TestRepositoryEntities` | None | `IX_TestRepositoryEntities_IsActive` |
| SQL Server | `TestRepositoryEntities` | None | `IX_TestRepositoryEntities_IsActive` |
| PostgreSQL | `"TestRepositoryEntities"` | Double quotes | `"IX_TestRepositoryEntities_IsActive"` |
| MySQL | `` `TestRepositoryEntities` `` | Backticks | `` `IX_TestRepositoryEntities_IsActive` `` |

---

### January 22 - Generic Repository Pattern (#279)

**Issue**: [#279 - Generic Repository Pattern](https://github.com/dlrivada/Encina/issues/279)

Implemented the Generic Repository Pattern (`IFunctionalRepository<TEntity, TId>`) across all 8 remaining database providers, completing the repository infrastructure.

**Providers Implemented**:

| Provider | Package | Components |
|----------|---------|------------|
| ADO.SQLite | `Encina.ADO.Sqlite` | `FunctionalRepositoryADO`, `EntityMappingBuilder`, `SpecificationSqlBuilder` |
| ADO.PostgreSQL | `Encina.ADO.PostgreSQL` | `FunctionalRepositoryADO`, `EntityMappingBuilder`, `SpecificationSqlBuilder` |
| ADO.MySQL | `Encina.ADO.MySQL` | `FunctionalRepositoryADO`, `EntityMappingBuilder`, `SpecificationSqlBuilder` |
| ADO.Oracle | `Encina.ADO.Oracle` | `FunctionalRepositoryADO`, `EntityMappingBuilder`, `SpecificationSqlBuilder` |
| Dapper.SQLite | `Encina.Dapper.Sqlite` | `FunctionalRepositoryDapper`, `EntityMappingBuilder`, `SpecificationSqlBuilder` |
| Dapper.PostgreSQL | `Encina.Dapper.PostgreSQL` | `FunctionalRepositoryDapper`, `EntityMappingBuilder`, `SpecificationSqlBuilder` |
| Dapper.MySQL | `Encina.Dapper.MySQL` | `FunctionalRepositoryDapper`, `EntityMappingBuilder`, `SpecificationSqlBuilder` |
| Dapper.Oracle | `Encina.Dapper.Oracle` | `FunctionalRepositoryDapper`, `EntityMappingBuilder`, `SpecificationSqlBuilder` |

**Database-Specific SQL Dialects**:

| Database | Identifier Quoting | Pagination | Parameters | Boolean | GUID |
|----------|-------------------|------------|------------|---------|------|
| SQLite | `"column"` | LIMIT/OFFSET | `@p0` | INTEGER (0/1) | TEXT |
| PostgreSQL | `"column"` | LIMIT/OFFSET | `@p0` | native bool | native UUID |
| MySQL | `` `column` `` | LIMIT/OFFSET | `@p0` | TINYINT(1) | CHAR(36) |
| Oracle | `"COLUMN"` | OFFSET/FETCH | `:p0` | NUMBER(1) | VARCHAR2(36) |

**Files Created**:

ADO Providers:

- `src/Encina.ADO.Sqlite/Repository/EntityMappingBuilder.cs`
- `src/Encina.ADO.Sqlite/Repository/SpecificationSqlBuilder.cs`
- `src/Encina.ADO.Sqlite/Repository/FunctionalRepositoryADO.cs`
- (Same structure for PostgreSQL, MySQL, Oracle)

Dapper Providers:

- `src/Encina.Dapper.Sqlite/Repository/EntityMappingBuilder.cs`
- `src/Encina.Dapper.Sqlite/Repository/SpecificationSqlBuilder.cs`
- `src/Encina.Dapper.Sqlite/Repository/FunctionalRepositoryDapper.cs`
- (Same structure for PostgreSQL, MySQL, Oracle)

**Test Files Created**:

- `tests/Encina.UnitTests/ADO/Sqlite/Repository/*.cs` (3 files, ~50 tests)
- `tests/Encina.UnitTests/ADO/PostgreSQL/Repository/*.cs` (3 files, ~50 tests)
- `tests/Encina.UnitTests/ADO/MySQL/Repository/*.cs` (3 files, ~94 tests)
- `tests/Encina.UnitTests/ADO/Oracle/Repository/*.cs` (3 files, ~94 tests)
- `tests/Encina.UnitTests/Dapper/Sqlite/Repository/*.cs` (3 files, ~83 tests)
- `tests/Encina.UnitTests/Dapper/PostgreSQL/Repository/*.cs` (3 files, ~73 tests)
- `tests/Encina.UnitTests/Dapper/MySQL/Repository/*.cs` (3 files, ~73 tests)
- `tests/Encina.UnitTests/Dapper/Oracle/Repository/*.cs` (3 files, ~84 tests)

**Test Results**:

- 1,153 unit tests for Repository pattern across all providers
- 0 warnings, 0 errors
- All PublicAPI.Unshipped.txt files updated

**Key Design Decisions**:

1. **Fluent Entity Mapping**: `EntityMappingBuilder` provides compile-time type safety for property mappings
2. **SQL Injection Prevention**: `SqlIdentifierValidator` validates all table/column names
3. **Expression-to-SQL Translation**: `SpecificationSqlBuilder` converts LINQ expressions to parameterized SQL
4. **Database Dialect Abstraction**: Each provider uses database-specific SQL syntax (quoting, pagination, parameters)
5. **Railway Oriented Programming**: All repository methods return `Either<EncinaError, T>`

---

## Week 1: January 1 (Testing Infrastructure)

### January 1 - Enhanced Testing Fixtures (Issue #444)

**Commits**: Phase 1 of Enhanced Testing Fixtures

**EncinaTestFixture Implementation**:

- Created `EncinaTestFixture` class with fluent builder pattern for test setup
- Added fake store configuration methods:
  - `WithMockedOutbox()` - Register FakeOutboxStore
  - `WithMockedInbox()` - Register FakeInboxStore
  - `WithMockedSaga()` - Register FakeSagaStore
  - `WithMockedScheduling()` - Register FakeScheduledMessageStore
  - `WithMockedDeadLetter()` - Register FakeDeadLetterStore
  - `WithAllMockedStores()` - Enable all fake stores at once
- Added handler registration:
  - `WithHandler<THandler>()` - Register request or notification handler
- Added service registration:
  - `WithService<TService>(instance)` - Register singleton instance
  - `WithService<TService, TImplementation>()` - Register with implementation type
- Added configuration:
  - `WithConfiguration(Action<EncinaConfiguration>)` - Custom Encina configuration
- Added test execution:
  - `SendAsync<TResponse>(IRequest<TResponse>)` - Send request and return context
  - `PublishAsync(INotification)` - Publish notification and return context
- Properties for store access: `Outbox`, `Inbox`, `SagaStore`, `ScheduledMessageStore`, `DeadLetterStore`
- `ClearStores()` for test isolation between tests
- Implements `IDisposable`, `IAsyncDisposable`, `IAsyncLifetime` for xUnit

**EncinaTestContext Implementation**:

- Created `EncinaTestContext<TResponse>` for chainable assertions after `SendAsync()`
- Result assertions:
  - `ShouldSucceed()` - Assert result is success (Right)
  - `ShouldFail()` - Assert result is error (Left)
  - `ShouldSucceedWith(Action<TResponse>)` - Assert success and verify value
  - `ShouldFailWith(Action<EncinaError>)` - Assert error and verify details
  - `ShouldSatisfy(Action<TResponse>)` - Custom verification
- Outbox assertions:
  - `OutboxShouldContain<TNotification>()` - Verify notification in outbox
  - `OutboxShouldBeEmpty()` - Verify no outbox messages
  - `OutboxShouldContainExactly(count)` - Verify exact message count
- Saga assertions:
  - `SagaShouldBeStarted<TSaga>()` - Verify saga was started
- Value extraction:
  - `GetSuccessValue()` - Get success value or throw
  - `GetErrorValue()` - Get error value or throw
- Properties:
  - `Result` - Access raw `Either<EncinaError, TResponse>`
  - `And` - Fluent chaining (returns `this`)
  - `IsSuccess`, `IsError` - Check result state
- Implicit conversion to `Either<EncinaError, TResponse>`

**Tests Created**:

- `EncinaTestFixtureTests.cs` - 17 unit tests for EncinaTestFixture
- `EncinaTestContextTests.cs` - 17 unit tests for EncinaTestContext
- All 179 tests passing

**Files Created/Modified**:

- `src/Encina.Testing/EncinaTestFixture.cs` (NEW - 427 lines)
- `src/Encina.Testing/EncinaTestContext.cs` (NEW - 341 lines)
- `src/Encina.Testing/Encina.Testing.csproj` (MODIFIED - added Encina.Testing.Fakes reference)
- `tests/Encina.Testing.Tests/EncinaTestFixtureTests.cs` (NEW - 285 lines)
- `tests/Encina.Testing.Tests/EncinaTestContextTests.cs` (NEW - 333 lines)

**Design Decisions**:

- `EncinaTestContext` constructor is internal - use `fixture.SendAsync()` to create
- Auto-build on first service access (no need to call `Build()` explicitly)
- Reference to `Encina.Testing.Fakes` for fake store implementations
- Fluent API returns `this` for method chaining

### January 1 (cont.) - Phase 3: Saga Time-Travel Testing (Issue #444)

**Time-Travel in EncinaTestFixture**:

- `WithFakeTimeProvider()` - Configure FakeTimeProvider with current time
- `WithFakeTimeProvider(DateTimeOffset)` - Configure FakeTimeProvider with specific start time
- `AdvanceTimeBy(TimeSpan)` - Advance fake time by duration
- `AdvanceTimeByMinutes(int)`, `AdvanceTimeByHours(int)`, `AdvanceTimeByDays(int)` - Convenience methods
- `SetTimeTo(DateTimeOffset)` - Set fake time to specific value
- `GetCurrentTime()` - Get current fake time
- `TimeProvider` property for direct FakeTimeProvider access

**Time-Travel in EncinaTestContext**:

- `ThenAdvanceTimeBy(TimeSpan)` - Chainable time advancement
- `ThenAdvanceTimeByMinutes(int)`, `ThenAdvanceTimeByHours(int)`, `ThenAdvanceTimeByDays(int)`
- `ThenSetTimeTo(DateTimeOffset)` - Set time in chainable context

**Saga State Assertions**:

- `SagaShouldHaveTimedOut<TSaga>()` - Assert saga timed out
- `SagaShouldHaveCompleted<TSaga>()` - Assert saga completed
- `SagaShouldBeCompensating<TSaga>()` - Assert saga is compensating
- `SagaShouldHaveFailed<TSaga>()` - Assert saga failed

**Tests Created**:

- 12 new tests for time-travel functionality in EncinaTestFixtureTests
- 8 new tests for time-travel context chaining in EncinaTestContextTests
- 5 new tests for saga state assertions

### January 1 (cont.) - Phase 5: Snapshot Testing Enhancements (Issue #444)

**New Snapshot Helpers in EncinaVerify**:

- `PrepareHandlerResult<TRequest, TResponse>()` - Complete handler result with request context
- `PrepareSagaStates(IEnumerable<ISagaState>)` - Multiple saga states sorted by ID
- `PrepareValidationError(EncinaError)` - Validation error with code detection
- `PrepareTestScenario<TResponse>()` - Combined result + outbox + sagas snapshot

**New Extension Methods**:

- `EncinaTestContextExtensions.ForVerify<TResponse>()` - Either → snapshot-ready object
- `EncinaTestContextExtensions.SuccessForVerify<TResponse>()` - Success value for verification
- `EncinaTestContextExtensions.ErrorForVerify<TResponse>()` - Error for verification

**New Snapshot Types**:

- `HandlerResultSnapshot<TRequest, TResponse>` - Handler result with request
- `ErrorSnapshot` - Error with message and code
- `ValidationErrorSnapshot` - Validation error with detection flag
- `TestScenarioSnapshot<TResponse>` - Complete test scenario

### January 1 (cont.) - Phase 6: Contract Testing Enhancements (Issue #444)

**New Architecture Rules in EncinaArchitectureRules**:

- `RequestsShouldFollowNamingConvention()` - Requests end with Command/Query
- `AggregatesShouldFollowPattern(namespace)` - Aggregates should be sealed
- `ValueObjectsShouldBeSealed()` - Value objects should be sealed
- `SagasShouldBeSealed()` - Sagas should be sealed
- `StoreImplementationsShouldBeSealed()` - Store implementations should be sealed
- `EventHandlersShouldBeSealed()` - Event handlers should be sealed

**New Builder Methods in EncinaArchitectureRulesBuilder**:

- `EnforceRequestNaming()` - Enforce request naming convention
- `EnforceSealedAggregates(namespace)` - Enforce sealed aggregates
- `EnforceSealedValueObjects()` - Enforce sealed value objects
- `EnforceSealedSagas()` - Enforce sealed sagas
- `EnforceSealedEventHandlers()` - Enforce sealed event handlers

**Updated ApplyAllStandardRules()**:

- Now includes `EnforceSealedEventHandlers()` (saga rules moved to opt-in)

**New ApplyAllSagaRules()**:

- Opt-in method for saga-specific rules
- Includes `EnforceSealedSagas()` and `EnforceSealedSagaData()`

**Tests**: All 202 tests passing

### January 1 (cont.) - WireMock.NET Integration Enhancement (Issue #164)

**EncinaRefitMockFixture<TApiClient> Implementation**:

- Generic xUnit fixture for testing Refit API clients with WireMock
- Auto-configured Refit client via `CreateClient()` method
- HTTP method stubs: `StubGet()`, `StubPost()`, `StubPut()`, `StubPatch()`, `StubDelete()`
- Generic stub: `Stub()` with method, path, request configuration, response
- Error simulation: `StubError()` with status code and optional error response
- Delay simulation: `StubDelay()` for timeout testing
- Request verification: `VerifyCallMade()`, `VerifyNoCallsMade()`
- Server management: `Reset()`, `ResetRequestHistory()`
- Implements `IAsyncLifetime` for xUnit integration

**WebhookTestingExtensions Implementation**:

- Extension methods for EncinaWireMockFixture for webhook testing
- `SetupWebhookEndpoint()` - Generic webhook endpoint (POST requests)
- `SetupOutboxWebhook()` - Outbox pattern webhook (JSON POST, default path `/webhooks/outbox`)
- `SetupWebhookFailure()` - Simulate webhook failures with status code and error message
- `SetupWebhookTimeout()` - Simulate webhook timeouts with configurable delay
- `VerifyWebhookReceived()` - Verify webhook was called with expected count
- `VerifyNoWebhooksReceived()` - Verify no webhooks were sent
- `GetReceivedWebhooks()` - Get all received webhook requests
- `GetReceivedWebhookBodies<T>()` - Deserialize webhook bodies to typed objects

**Test Files Created**:

- `EncinaRefitMockFixtureTests.cs` - 25 tests for Refit fixture functionality
- `WebhookTestingExtensionsTests.cs` - 27 tests for webhook extensions
- `FaultSimulationTests.cs` - 14 tests for fault simulation
- `SequenceTests.cs` - 10 tests for request sequencing
- `GuardClauseTests.cs` - 34 tests for argument validation

**Test Coverage**:

- 147 total tests in Encina.Testing.WireMock.Tests
- Unit tests: All fixture methods tested
- Fault simulation: EmptyResponse, MalformedResponse, Timeout, HTTP error codes
- Sequence tests: Request ordering, timestamp capture, workflow verification
- Guard clause tests: Null checks, empty string validation

**Justification for Omitted Test Types**:

- Property-based tests: Not applicable - WireMock.NET is already well-tested; invariants are trivial
- Contract tests: Not applicable - no public interfaces to implement, only concrete fixtures
- Load tests: Not applicable - performance depends on WireMock.NET, not our wrapper
- Benchmarks: Not applicable - same reason as load tests

**Files Created/Modified**:

- `src/Encina.Testing.WireMock/EncinaRefitMockFixture.cs` (NEW - 314 lines)
- `src/Encina.Testing.WireMock/WebhookTestingExtensions.cs` (NEW - 238 lines)
- `src/Encina.Testing.WireMock/Encina.Testing.WireMock.csproj` (MODIFIED - added Refit references)
- `tests/Encina.Testing.WireMock.Tests/EncinaRefitMockFixtureTests.cs` (NEW - 280 lines)
- `tests/Encina.Testing.WireMock.Tests/WebhookTestingExtensionsTests.cs` (NEW - 210 lines)
- `tests/Encina.Testing.WireMock.Tests/FaultSimulationTests.cs` (NEW - 140 lines)
- `tests/Encina.Testing.WireMock.Tests/SequenceTests.cs` (NEW - 180 lines)
- `tests/Encina.Testing.WireMock.Tests/GuardClauseTests.cs` (NEW - 250 lines)
- `tests/Encina.Testing.WireMock.Tests/ReceivedRequestTests.cs` (MODIFIED - fixed header type)
- `tests/Encina.Testing.WireMock.Tests/Encina.Testing.WireMock.Tests.csproj` (MODIFIED - added Refit)

**Design Decisions**:

- Used alias `WireMockRequestBuilder` to resolve ambiguity between Refit.IRequestBuilder and WireMock.RequestBuilders.IRequestBuilder
- WebhookTestingExtensions extend EncinaWireMockFixture (not generic) for simplicity
- Default JSON serialization with camelCase naming policy
- Webhook extensions use `ArgumentNullException.ThrowIfNull()` for null fixture validation

---

## Issue Progress (v0.11.0 - Testing Infrastructure)

| Issue | Title | Status |
|-------|-------|--------|
| #161 | Test Data Generation | ✅ Completed (Dec 2025) |
| #162 | Testcontainers Integration | ✅ Completed (Dec 2025) |
| #163 | Database Reset (Respawn) | ✅ Completed (Jan 2026) |
| #165 | Snapshot Testing (Verify) | ✅ Completed (Dec 2025) |
| #426 | Testing.Fakes | ✅ Completed (Dec 2025) |
| #427 | Testing.Respawn | ✅ Completed (Dec 2025) |
| #428 | Testing.WireMock (base) | ✅ Completed (Dec 2025) |
| #164 | WireMock Refit + Webhooks | ✅ Completed (Jan 2026) |
| #429 | Testing.Shouldly | ✅ Completed (Dec 2025) |
| #430 | Testing.Verify | ✅ Completed (Dec 2025) |
| #431 | Testing.Bogus | ✅ Completed (Dec 2025) |
| #432 | Testing.Architecture | ✅ Completed (Dec 2025) |
| #444 | Enhanced Testing Fixtures | ✅ All 6 Phases Completed |
| #495 | AggregateTestBase | ✅ Completed (Dec 2025) |
| #362 | Module Testing Utilities | ✅ Completed (Jan 2026) |
| #171 | Testing.TUnit | ✅ Completed (Jan 2026) |
| #435 | Testing.FsCheck | ✅ Completed (Jan 2026) |

---

## Completed Phases (Issue #444)

Issue #444 "Enhanced Testing Fixtures" - All 6 phases completed on January 1, 2026:

| Phase | Description | Status | Package |
|-------|-------------|--------|---------|
| Phase 1 | EncinaTestFixture fluent fixture | ✅ Completed | Encina.Testing |
| Phase 2 | Enhanced Either assertions in Shouldly | ✅ Already exists | Encina.Testing.Shouldly |
| Phase 3 | Saga time-travel testing | ✅ Completed | Encina.Testing |
| Phase 4 | Outbox/Inbox assertion helpers | ✅ Completed | Encina.Testing |
| Phase 5 | Snapshot testing enhancements | ✅ Completed | Encina.Testing.Verify |
| Phase 6 | Contract testing enhancements | ✅ Completed | Encina.Testing.Architecture |

---

## References

- [Issue #444 - Enhanced Testing Fixtures](https://github.com/dlrivada/Encina/issues/444)
- [v0.11.0 Testing Infrastructure Milestone](https://github.com/dlrivada/Encina/milestone/8)

---

## Issue #170: Improved Assertions with Shouldly

**Date**: January 1, 2026

**Summary**: Enhanced `Encina.Testing` and `Encina.Testing.Shouldly` with fluent chaining assertions (AndConstraint pattern), collection assertions, and streaming assertions for `IAsyncEnumerable<Either<TLeft, TRight>>`.

### Phase 1: AndConstraint Pattern

**New Classes** (`src/Encina.Testing/Assertions/`):

1. **`AndConstraint<T>`** - Fluent chaining for assertions (FluentAssertions-style):
   - `Value` property for accessing the asserted value
   - `And` property returning `this` for fluent chaining
   - `ShouldSatisfy(Action<T>)` for custom assertions
   - Implicit conversion to underlying `T` type

2. **`AndConstraintAsync<T>`** - Async variant for `Task<T>` results:
   - `Value` property returning `Task<T>`
   - `ShouldSatisfyAsync(Func<T, Task>)` for async assertions
   - `AsSync()` to materialize and get `AndConstraint<T>`

**EitherAssertions Enhancements**:

- `ShouldBeSuccessAnd()`, `ShouldBeRightAnd()` → `AndConstraint<TRight>`
- `ShouldBeErrorAnd()`, `ShouldBeLeftAnd()` → `AndConstraint<TLeft>`
- EncinaError `*And` variants: `ShouldBeErrorWithCodeAnd()`, `ShouldBeValidationErrorAnd()`, `ShouldBeAuthorizationErrorAnd()`, `ShouldBeNotFoundErrorAnd()`, `ShouldBeErrorContainingAnd()`
- New: `ShouldBeValidationErrorForProperty()` and `ShouldBeValidationErrorForPropertyAnd()` for property-specific validation errors
- Async `*And` variants for all methods

### Phase 2: Collection Assertions

**New Class**: `EitherCollectionAssertions` (`src/Encina.Testing/Assertions/`):

- **All/Error Assertions**:
  - `ShouldAllBeSuccess()`, `ShouldAllBeSuccessAnd()` - All results must be Right
  - `ShouldAllBeError()`, `ShouldAllBeErrorAnd()` - All results must be Left

- **Contains Assertions**:
  - `ShouldContainSuccess()`, `ShouldContainSuccessAnd()` - At least one Right
  - `ShouldContainError()`, `ShouldContainErrorAnd()` - At least one Left

- **Count Assertions**:
  - `ShouldHaveSuccessCount(n)`, `ShouldHaveSuccessCountAnd(n)`
  - `ShouldHaveErrorCount(n)`, `ShouldHaveErrorCountAnd(n)`

- **EncinaError-Specific**:
  - `ShouldContainValidationErrorFor(propertyName)` - Find validation error for property
  - `ShouldNotContainAuthorizationErrors()` - No auth errors in collection
  - `ShouldContainAuthorizationError()` - At least one auth error
  - `ShouldAllHaveErrorCode(code)` - All errors have same code

- **Helper Methods**:
  - `GetSuccesses()`, `GetErrors()` - Extract values/errors from collection

- **Async Variants**: `ShouldAllBeSuccessAsync()`, `ShouldAllBeErrorAsync()`, `ShouldContainSuccessAsync()`, `ShouldContainErrorAsync()`

### Phase 3: Streaming Assertions

**New Classes**:

1. **`StreamingAssertions`** (`src/Encina.Testing/Assertions/`) - xUnit-based:
   - `CollectAsync()` - Materialize `IAsyncEnumerable` to `List<T>`
   - All collection assertions with `Async` suffix for streams
   - `FirstShouldBeSuccessAsync()`, `FirstShouldBeErrorAsync()` - First item assertions
   - `ShouldBeEmptyAsync()`, `ShouldNotBeEmptyAsync()` - Stream emptiness
   - `ShouldHaveCountAsync(n)` - Total item count
   - EncinaError-specific streaming assertions

2. **`StreamingShouldlyExtensions`** (`src/Encina.Testing.Shouldly/`) - Shouldly-based:
   - Same API as `StreamingAssertions` but using `ShouldAssertException`
   - Consistent with existing `EitherCollectionShouldlyExtensions`

### Phase 4: Test Coverage

**New Test Files**:

- `tests/Encina.Testing.Tests/EitherAssertionsTests.cs` - 30+ new tests for AndConstraint
- `tests/Encina.Testing.Tests/EitherCollectionAssertionsTests.cs` - 25+ tests for collections
- `tests/Encina.Testing.Tests/StreamingAssertionsTests.cs` - 30+ tests for streaming

**Total**: 444 tests passing

### Test Types Justification

| Test Type | Status | Justification |
|-----------|--------|---------------|
| Unit Tests | ✅ 85+ tests | All assertion methods covered |
| Property-Based | ⏭️ Not applicable | Assertions are deterministic |
| Guard Clause | ⏭️ Not applicable | Null checks use `ArgumentNullException.ThrowIfNull` |
| Integration | ⏭️ Not applicable | Pure assertion methods, no external deps |
| Contract | ⏭️ Not applicable | Extension methods, not interfaces |
| Load/Benchmark | ⏭️ Not applicable | Assertions run at test-time |

### CodeRabbit Plan Execution

Following CodeRabbit's 4-phase plan:

1. ✅ Phase 1: AndConstraint pattern with `And` chaining
2. ✅ Phase 2: Collection assertions with EncinaError specifics
3. ✅ Phase 3: Streaming assertions for `IAsyncEnumerable`
4. ✅ Phase 4: Comprehensive unit tests

---

## Issue #362 - Module Testing Utilities

**Date**: 2026-01-02
**Milestone**: v0.11.0 - Testing Infrastructure
**Package**: Encina.Testing

### Overview

Module Testing Utilities provide comprehensive testing infrastructure for modular monolith applications. This implementation enables isolated module testing with dependency mocking, integration event assertions, and architecture verification.

### Components Implemented

#### ModuleTestFixture<TModule>

Fluent test fixture for isolated module testing:

```csharp
using var fixture = new ModuleTestFixture<OrdersModule>()
    .WithMockedModule<IInventoryModuleApi>(mock =>
        mock.Setup("ReserveStockAsync", (string id, int qty) =>
            Task.FromResult(Right<EncinaError, string>("reserved"))))
    .WithFakeModule<IPaymentModuleApi, FakePaymentModule>()
    .WithAllMockedStores()
    .WithFakeTimeProvider();

var result = await fixture.SendAsync(new PlaceOrderCommand(...));

result.ShouldSucceed();
fixture.IntegrationEvents.ShouldContain<OrderPlacedEvent>();
```

**Features**:

- `WithMockedModule<T>()` - Mock dependent modules via fluent API or instance
- `WithFakeModule<T, TFake>()` - Register fake implementations
- `WithAllMockedStores()` - Configure all messaging stores
- `WithFakeTimeProvider()` - Time-travel testing support
- `SendAsync()`, `PublishAsync()` - Execute requests capturing events
- `ClearStores()` - Reset state between tests

#### IntegrationEventCollector

Thread-safe collection for integration event assertions:

```csharp
fixture.IntegrationEvents.ShouldContain<OrderPlacedEvent>();
fixture.IntegrationEvents.ShouldContain<OrderPlacedEvent>(e => e.OrderId == expectedId);
fixture.IntegrationEvents.ShouldContainSingle<OrderConfirmedEvent>();
fixture.IntegrationEvents.ShouldBeEmpty();
fixture.IntegrationEvents.ShouldHaveCount(3);
```

#### MockModuleApi<T>

Simple mock builder using DispatchProxy:

```csharp
var mock = new MockModuleApi<IInventoryModuleApi>()
    .Setup("GetAvailableStock", (string id) =>
        Right<EncinaError, int>(42))
    .Setup("ReserveStockAsync", (string id, int qty) =>
        Task.FromResult(Right<EncinaError, string>("reserved")))
    .SetupProperty("ModuleName", "Inventory");

var api = mock.Build();
```

#### ModuleArchitectureAnalyzer

Module dependency analysis with circular dependency detection:

```csharp
var result = await ModuleArchitectureAnalyzer
    .AnalyzeAssemblyContaining<OrdersModule, PaymentsModule>();

result.ShouldHaveNoCircularDependencies();
result.ShouldContainModule("Orders");
result.ShouldHaveDependency("Orders", "Payments");
result.ShouldNotHaveDependency("Payments", "Orders");
```

**Algorithm**: Uses DFS (Depth-First Search) for cycle detection in the module dependency graph.

#### ModuleArchitectureRules

Pre-built ArchUnitNET rules:

```csharp
ModuleArchitectureRules.ModulesShouldBeSealed()
    .Check(architecture);

ModuleArchitectureRules.IntegrationEventsShouldBeSealed()
    .Check(architecture);

ModuleArchitectureRules.DomainShouldNotDependOnInfrastructure(
    "MyApp.Orders.Domain",
    "MyApp.Orders.Infrastructure")
    .Check(architecture);
```

### Files Created

| File | Purpose |
|------|---------|
| `src/Encina.Testing/Modules/ModuleTestFixture.cs` | Main test fixture |
| `src/Encina.Testing/Modules/ModuleTestContext.cs` | Fluent assertion context |
| `src/Encina.Testing/Modules/IntegrationEventCollector.cs` | Event capture & assertions |
| `src/Encina.Testing/Modules/MockModuleApi.cs` | DispatchProxy-based mocking |
| `src/Encina.Testing/Modules/ModuleArchitectureRules.cs` | ArchUnitNET rules |
| `src/Encina.Testing/Modules/ModuleArchitectureAnalyzer.cs` | Dependency analysis |
| `tests/Encina.Testing.Tests/Modules/ModuleTestFixtureTests.cs` | Fixture tests |
| `tests/Encina.Testing.Tests/Modules/IntegrationEventCollectorTests.cs` | Collector tests |
| `tests/Encina.Testing.Tests/Modules/MockModuleApiTests.cs` | Mock builder tests |
| `tests/Encina.Testing.Tests/Modules/ModuleArchitectureAnalyzerTests.cs` | Analyzer tests |

### Dependencies Added

- `TngTech.ArchUnitNET.xUnit` - Architecture testing rules
- `Shouldly` - Fluent assertions

### Test Coverage

| Test Type | Status | Tests | Justification |
|-----------|--------|-------|---------------|
| Unit Tests | ✅ | 87 | Core functionality, all public APIs |
| Property-Based | ⏭️ | N/A | Test utilities don't have invariants |
| Guard Clause | ✅ | Included | ArgumentNullException checks |
| Integration | ⏭️ | N/A | In-memory test infrastructure |
| Contract | ⏭️ | N/A | Internal implementation |
| Load/Benchmark | ⏭️ | N/A | Test-time only, not runtime |

### Technical Notes

1. **DispatchProxy Requirement**: The `MockProxy<T>` class cannot be sealed because `DispatchProxy.Create` generates a derived type dynamically.

2. **ConcurrentBag Order**: `IntegrationEventCollector` uses `ConcurrentBag` which doesn't guarantee insertion order. Tests verify event presence, not order.

3. **Circular Dependency Detection**: Uses standard DFS algorithm with visited/recursion-stack tracking. O(V+E) complexity where V=modules, E=dependencies.

4. **InternalsVisibleTo**: Added to allow tests access to `internal Add()` method on `IntegrationEventCollector`.

---

## Issue #172 - Mutation Testing Helper Attributes

**Date**: 2026-01-02
**Milestone**: v0.11.0 - Testing Infrastructure
**Package**: Encina.Testing

### Overview

Added helper attributes to the `Encina.Testing.Mutations` namespace for documenting and tracking mutation testing insights directly in test code. These attributes follow the existing Stryker.NET integration and enhance the mutation testing workflow.

### Components Implemented

#### NeedsMutationCoverageAttribute

Marks tests identified as mutation-weak during Stryker analysis:

```csharp
[Fact]
[NeedsMutationCoverage("Boundary condition not verified", MutantId = "280", Line = 45)]
public void Calculate_BoundaryValue_ShouldReturnExpectedResult()
{
    // Test needs stronger assertions
}
```

**Properties**:

- `Reason` (required) - Description of mutation coverage gap
- `MutantId` (optional) - Stryker mutant ID from report
- `SourceFile` (optional) - Path to source file with surviving mutant
- `Line` (optional) - Line number where mutation was applied

#### MutationKillerAttribute

Documents tests explicitly written to kill specific mutation types:

```csharp
[Fact]
[MutationKiller("EqualityMutation", Description = "Verifies >= is not mutated to >")]
public void IsAdult_ExactlyEighteen_ShouldReturnTrue()
{
    // Boundary test that kills equality mutation
}
```

**Properties**:

- `MutationType` (required) - Type of mutation killed
- `Description` (optional) - Detailed description
- `SourceFile` (optional) - Path to source file
- `TargetMethod` (optional) - Method name
- `Line` (optional) - Line number

### Files Created

| File | Purpose |
|------|---------|
| `src/Encina.Testing/Mutations/NeedsMutationCoverageAttribute.cs` | Attribute for mutation-weak tests |
| `src/Encina.Testing/Mutations/MutationKillerAttribute.cs` | Attribute for mutation killer tests |
| `tests/Encina.Testing.Tests/Mutations/MutationAttributesTests.cs` | Unit tests (24 tests) |
| `tests/Encina.Testing.Tests/Mutations/MutationAttributesGuardClauseTests.cs` | Guard clause tests (23 tests) |

### Documentation Updated

- `docs/en/guides/MUTATION_TESTING.md` - Added "Test Quality Patterns" section with usage examples and best practices

### Test Coverage

| Test Type | Status | Tests | Justification |
|-----------|--------|-------|---------------|
| Unit Tests | ✅ | 24 | Core functionality, all public APIs |
| Guard Clause | ✅ | 23 | Null/empty/whitespace validation |
| Property-Based | ⏭️ | N/A | Attributes are simple data holders |
| Integration | ⏭️ | N/A | Compile-time metadata only |
| Contract | ⏭️ | N/A | No interfaces to implement |
| Load/Benchmark | ⏭️ | N/A | Test-time only, not runtime |

### Design Decisions

1. **AllowMultiple=true**: Both attributes allow multiple instances per test method to document multiple mutation issues or kills.

2. **Inherited=false**: Attributes are not inherited to derived test classes, ensuring explicit documentation.

3. **Sealed classes**: Both attribute classes are sealed following Encina conventions.

4. **Validation**: Both constructors validate that required parameters are not null, empty, or whitespace using `ArgumentException.ThrowIfNullOrWhiteSpace`.

### Bug Fixes (Existing Code)

During implementation, addressed pre-existing issues in `Encina.Testing`:

1. **MockModuleApi.cs**: Fixed duplicate XML documentation and corrected `<see cref>` syntax error
2. **IntegrationEventCollector.cs**: Changed return type from `IReadOnlyList<string>` to `ReadOnlyCollection<string>` to fix CA1859
3. **ModuleArchitectureAnalyzerTests.cs**: Fixed ambiguous constructor call by using named parameter

---

## Issue #497 - ModuleArchitectureAnalyzerTests False Positive Dependency Fix

**Date**: 2026-01-02
**Milestone**: v0.11.0 - Testing Infrastructure
**Package**: Encina.Testing.Tests

### Overview

Fixed failing test `ShouldNotHaveDependency_NoDependency_Passes` in `ModuleArchitectureAnalyzerTests` which was reporting false positive module dependencies.

### Root Cause Analysis

The `ModuleArchitectureAnalyzer` uses namespace prefixes to detect dependencies between modules. The test modules (`OrdersModule`, `PaymentsModule`, `ShippingModule`) were all declared with `file` scope in the same namespace `Encina.Testing.Tests.Modules`, causing the analyzer to detect false dependencies between them.

The dependency detection algorithm in `CheckDependency()`:

1. Gets all types in source module's namespace
2. Checks if any type references types in target module's namespace
3. Since all test modules shared the same namespace, type references were incorrectly flagged as cross-module dependencies

### Solution

Moved test modules to distinct namespaces to simulate real modular architecture:

```csharp
// Before: All in same namespace
namespace Encina.Testing.Tests.Modules;
file sealed class OrdersModule : IModule { ... }
file sealed class PaymentsModule : IModule { ... }
file sealed class ShippingModule : IModule { ... }

// After: Separate namespaces
namespace Encina.Testing.Tests.Modules.TestModules.Orders
{
    internal sealed class OrdersModule : IModule { ... }
}
namespace Encina.Testing.Tests.Modules.TestModules.Payments
{
    internal sealed class PaymentsModule : IModule { ... }
}
namespace Encina.Testing.Tests.Modules.TestModules.Shipping
{
    internal sealed class ShippingModule : IModule { ... }
}
```

### Additional Fix

The test `Result_DiscoversModulesInAssembly` was also adjusted:

- **Before**: Verified exact module count match (expected exactly 3 modules)
- **After**: Verified module containment (expected modules exist among discovered modules)
- **Reason**: Assembly may contain additional test modules from other test files (e.g., `TestModule` from `ModuleTestFixtureTests.cs`)

### Files Modified

| File | Changes |
|------|---------|
| `tests/Encina.Testing.Tests/Modules/ModuleArchitectureAnalyzerTests.cs` | Moved test modules to distinct namespaces; adjusted discovery test |

### Test Results

| Test | Before | After |
|------|--------|-------|
| `ShouldNotHaveDependency_NoDependency_Passes` | ❌ Failing | ✅ Passing |
| `Result_DiscoversModulesInAssembly` | ❌ Failing | ✅ Passing |
| All ModuleArchitectureAnalyzerTests (14 total) | 12 passing | 14 passing |

### Design Insight

This fix reinforces the importance of proper namespace organization when using `ModuleArchitectureAnalyzer`:

- Each module should have its own distinct namespace prefix
- The analyzer uses namespace prefixes as module boundaries
- Test modules should mirror production module structure for accurate analysis

---

## Issue #173 - CI/CD Workflow Templates

**Date**: 2026-01-03
**Milestone**: v0.11.0 - Testing Infrastructure
**Location**: `.github/workflows/templates/`

### Overview

Created reusable GitHub Actions workflow templates to standardize CI/CD across projects using Encina. These templates provide best practices for .NET 10 testing, coverage, and package publishing.

### Components Implemented

#### encina-test.yml - Basic Test Workflow

Reusable workflow for unit testing with code coverage:

```yaml
jobs:
  test:
    uses: dlrivada/Encina/.github/workflows/templates/encina-test.yml@main
    with:
      solution: 'MyApp.slnx'
      coverage-threshold: '80'
```

**Features**:

- Cross-platform support (Windows, Linux, macOS)
- Configurable .NET SDK version (default: 10.0.x)
- NuGet package caching for faster builds
- Test filter expressions for selective testing
- Coverage threshold enforcement
- ReportGenerator integration for HTML reports
- Artifact upload for coverage and test results

**Inputs**:

- `solution` - Solution file path (default: `*.slnx`)
- `configuration` - Build configuration (default: `Release`)
- `dotnet-version` - SDK version (default: `10.0.x`)
- `runs-on` - Runner OS (default: `ubuntu-latest`)
- `coverage-threshold` - Minimum coverage % (default: `0`)
- `run-integration-tests` - Include integration tests (default: `false`)
- `test-filter` - Test filter expression
- `exclude-patterns` - Comma-separated exclude patterns (default: `LoadTests`)
- `upload-coverage` - Upload coverage artifact (default: `true`)
- `timeout-minutes` - Job timeout (default: `30`)

#### encina-matrix.yml - Matrix Testing Workflow

Matrix testing across multiple OS and database providers:

```yaml
jobs:
  matrix:
    uses: dlrivada/Encina/.github/workflows/templates/encina-matrix.yml@main
    with:
      test-os: '["ubuntu-latest", "windows-latest"]'
      test-databases: '["postgresql", "sqlserver", "sqlite"]'
```

**Features**:

- Multiple OS testing in parallel
- Docker service containers for databases:
  - PostgreSQL (postgres:16)
  - SQL Server (mssql/server:2022-latest)
  - MySQL (mysql:8)
  - Redis (redis:7-alpine)
  - MongoDB (mongo:7)
  - SQLite (in-memory)
- Automatic connection string environment variables
- Summary job aggregating all matrix results
- Smart exclusions (e.g., SQL Server not on macOS)

**Inputs**:

- `test-os` - JSON array of OS runners
- `test-databases` - JSON array of database providers
- `fail-fast` - Cancel all jobs on failure (default: `false`)
- `max-parallel` - Maximum parallel jobs (default: `4`)
- `test-filter` - Test filter expression
- `timeout-minutes` - Job timeout (default: `45`)

#### encina-full-ci.yml - Complete CI Pipeline

Comprehensive CI pipeline with all stages:

```yaml
jobs:
  ci:
    uses: dlrivada/Encina/.github/workflows/templates/encina-full-ci.yml@main
    with:
      coverage-threshold: '80'
      run-integration-tests: true
      run-mutation-tests: true
    secrets:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
```

**Pipeline Stages**:

1. **Build & Analyze**
   - Restore dependencies
   - Check code formatting (`dotnet format --verify-no-changes`)
   - Build with warnings as errors
   - Calculate version from tag or commit

2. **Unit Tests**
   - Run all unit tests with coverage
   - Generate coverage report
   - Enforce coverage threshold
   - Upload artifacts

3. **Integration Tests** (optional)
   - Docker service containers (PostgreSQL, SQL Server, Redis)
   - Run `*IntegrationTests*` projects
   - Connection strings via environment variables

4. **Architecture Tests** (optional)
   - Run `*ArchitectureTests*` projects
   - ArchUnitNET rule validation

5. **Mutation Tests** (optional)
   - Stryker.NET mutation testing
   - Mutation score threshold enforcement
   - HTML and JSON reports

6. **Pack NuGet**
   - Create NuGet packages
   - Version from build stage

7. **Publish NuGet** (on tag)
   - Push to configured NuGet source
   - Skip duplicates

8. **Summary**
   - Aggregate all job results
   - Status table with checkmarks

**Secrets**:

- `NUGET_API_KEY` - API key for NuGet publishing

### Documentation

Created comprehensive documentation at `docs/ci-cd-templates.md`:

- Quick start examples for each template
- Complete input/secret reference
- Supported databases with Docker images
- Pipeline stage diagrams
- Best practices and troubleshooting
- Integration with Encina.Testing packages

### Test Coverage

Created `tests/Encina.Workflows.Tests/` project:

| Test Type | Status | Tests | Justification |
|-----------|--------|-------|---------------|
| Unit Tests | ✅ | 49 | YAML validation, structure verification |
| Property-Based | ⏭️ | N/A | Static YAML files, no invariants |
| Guard Clause | ⏭️ | N/A | No runtime code, only YAML |
| Integration | ⏭️ | N/A | Would require GitHub Actions execution |
| Contract | ⏭️ | N/A | No interfaces, only workflow definitions |
| Load/Benchmark | ⏭️ | N/A | CI pipelines not performance-critical |

**Test Categories**:

- Template existence and validity
- YAML syntax validation
- Required sections (name, permissions, jobs)
- Reusable workflow structure (workflow_call)
- Expected inputs for each template
- Job structure (runs-on, steps)
- Required actions (checkout, setup-dotnet, cache)
- Template-specific features (services, secrets, multiple jobs)
- Documentation presence

### Files Created

| File | Purpose |
|------|---------|
| `.github/workflows/templates/encina-test.yml` | Basic test workflow |
| `.github/workflows/templates/encina-matrix.yml` | Matrix testing workflow |
| `.github/workflows/templates/encina-full-ci.yml` | Complete CI pipeline |
| `docs/ci-cd-templates.md` | Comprehensive documentation |
| `tests/Encina.Workflows.Tests/Encina.Workflows.Tests.csproj` | Test project |
| `tests/Encina.Workflows.Tests/WorkflowTemplateTests.cs` | 49 validation tests |

### Dependencies Added

- `YamlDotNet` (16.3.0) - YAML parsing for tests

### Design Decisions

1. **Reusable Workflows**: All templates use `workflow_call` trigger to be invoked from other repositories.

2. **Sensible Defaults**: Templates work out-of-the-box with minimal configuration but allow extensive customization.

3. **Cross-Platform**: All templates support Windows, Linux, and macOS runners where applicable.

4. **Version-Agnostic**: Default to `10.0.x` for .NET SDK but allow override.

5. **Service Container Exclusions**: Matrix template automatically excludes impossible combinations (e.g., SQL Server on macOS).

6. **Coverage Tools**: Use ReportGenerator for consistent HTML/JSON coverage reports.

7. **Parallel Execution**: Matrix jobs run in parallel with configurable max-parallel.

8. **Artifact Retention**: Use GitHub's default retention; build outputs kept 1 day.

---

## Week 1: January 3 (Testing Infrastructure - TUnit Support)

### January 3 - TUnit Framework Support (Issue #171)

#### New Package: Encina.Testing.TUnit

TUnit framework support for modern, source-generated testing with NativeAOT compatibility.

**Files Created**:

- `src/Encina.Testing.TUnit/Encina.Testing.TUnit.csproj` - Package definition with TUnit dependency
- `src/Encina.Testing.TUnit/EncinaTUnitFixture.cs` - TUnit-compatible test fixture
- `src/Encina.Testing.TUnit/TUnitEitherAssertions.cs` - Async-first Either assertions
- `src/Encina.Testing.TUnit/TUnitEitherCollectionAssertions.cs` - Collection assertions
- `src/Encina.Testing.TUnit/PublicAPI.Shipped.txt` - Empty (no shipped APIs yet)
- `src/Encina.Testing.TUnit/PublicAPI.Unshipped.txt` - All public APIs
- `tests/Encina.Testing.TUnit.Tests/Encina.Testing.TUnit.Tests.csproj` - Test project
- `tests/Encina.Testing.TUnit.Tests/EncinaTUnitFixtureTests.cs` - Fixture tests
- `tests/Encina.Testing.TUnit.Tests/TUnitEitherAssertionsTests.cs` - Assertion tests
- `tests/Encina.Testing.TUnit.Tests/TUnitEitherCollectionAssertionsTests.cs` - Collection tests

**EncinaTUnitFixture Implementation**:

- Implements TUnit's `IAsyncInitializer` for async test initialization
- Implements `IAsyncDisposable` for proper cleanup with `GC.SuppressFinalize`
- Fluent builder pattern:
  - `WithConfiguration(Action<EncinaConfiguration>)` - Custom Encina configuration
  - `WithServices(Action<IServiceCollection>)` - Register custom services
  - `WithHandlersFromAssemblyContaining<T>()` - Scan assembly for handlers
- Service resolution:
  - `CreateScope()` - Create service scope
  - `GetService<T>()`, `GetRequiredService<T>()` - Resolve services
- Properties: `Encina`, `ServiceProvider`

**TUnitEitherAssertions Implementation**:

- Async-first assertions following TUnit's `Assert.That().IsTrue().Because()` pattern
- Success assertions:
  - `ShouldBeSuccessAsync()` - Assert Right and return value
  - `ShouldBeSuccessAsync(expected)` - Assert with expected value
  - `ShouldBeSuccessAsync(Func<TRight, Task>)` - Assert with async validator
  - `AndReturnAsync()` - Alias for fluent chaining
- Error assertions:
  - `ShouldBeErrorAsync()` - Assert Left and return error
  - `ShouldBeErrorAsync(Func<TLeft, Task>)` - Assert with async validator
- EncinaError-specific assertions:
  - `ShouldBeErrorWithCodeAsync(code)` - Assert specific error code
  - `ShouldBeErrorContainingAsync(text)` - Assert message contains text
  - `ShouldBeValidationErrorAsync()` - Assert code starts with "encina.validation"
  - `ShouldBeAuthorizationErrorAsync()` - Assert code starts with "encina.authorization"
  - `ShouldBeNotFoundErrorAsync()` - Assert code starts with "encina.notfound"
  - `ShouldBeConflictErrorAsync()` - Assert code starts with "encina.conflict"
  - `ShouldBeInternalErrorAsync()` - Assert code starts with "encina.internal"
- Task extensions: All assertions work with `Task<Either<>>`

**TUnitEitherCollectionAssertions Implementation**:

- `ShouldAllBeSuccessAsync()` - Assert all items are Right, return values
- `ShouldAllBeErrorAsync()` - Assert all items are Left, return errors
- `ShouldContainSuccessAsync()` - Assert at least one Right
- `ShouldContainErrorAsync()` - Assert at least one Left
- `ShouldHaveSuccessCountAsync(count)` - Assert exact success count
- `ShouldHaveErrorCountAsync(count)` - Assert exact error count
- Helper methods: `GetSuccesses()`, `GetErrors()`

**NativeAOT Compatibility**:

- Package marked with `<IsAotCompatible>true</IsAotCompatible>`
- No reflection-based patterns in package code
- Zero IL warnings from Encina.Testing.TUnit code
- Compatible with TUnit's source-generated test discovery

**Tests Created**:

- `EncinaTUnitFixtureTests.cs` - 15 tests for fixture lifecycle
- `TUnitEitherAssertionsTests.cs` - 21 tests for Either assertions
- `TUnitEitherCollectionAssertionsTests.cs` - 20 tests for collection assertions
- Total: 56 tests, all passing

**Dependencies Added**:

- TUnit v1.8.1 added to `Directory.Packages.props`
- Package added to `Encina.slnx` solution file

**Design Decisions**:

1. Use TUnit's `IAsyncInitializer` instead of xUnit's `IAsyncLifetime` for lifecycle
2. Async-first assertions matching TUnit's async assertion model
3. `GC.SuppressFinalize` in `DisposeAsync()` per CA1816
4. Use `EncinaErrors.Create()` for error creation (not factory methods)
5. `TestingPlatformDotnetTestSupport=true` for .NET 10 test execution

---

## Week 1: January 3 (Testing Infrastructure - FsCheck Property-Based Testing)

### January 3 - FsCheck Property-Based Testing (Issue #435)

#### New Package: Encina.Testing.FsCheck

FsCheck property-based testing extensions for Encina framework, compatible with FsCheck 3.x.

**Files Created**:

- `src/Encina.Testing.FsCheck/Encina.Testing.FsCheck.csproj` - Package definition with FsCheck 3.3.2 and FsCheck.Xunit dependencies
- `src/Encina.Testing.FsCheck/EncinaArbitraries.cs` - Pre-built arbitraries for Encina types
- `src/Encina.Testing.FsCheck/EncinaProperties.cs` - Common property validators for invariants
- `src/Encina.Testing.FsCheck/GenExtensions.cs` - Generator extension methods
- `src/Encina.Testing.FsCheck/PropertyTestBase.cs` - Base class and attributes for xUnit integration
- `src/Encina.Testing.FsCheck/EncinaArbitraryProvider.cs` - FsCheck arbitrary provider
- `src/Encina.Testing.FsCheck/ArbitraryMessages.cs` - Concrete message implementations for testing
- `src/Encina.Testing.FsCheck/PublicAPI.Shipped.txt` - Empty (no shipped APIs yet)
- `src/Encina.Testing.FsCheck/PublicAPI.Unshipped.txt` - All public APIs
- `src/Encina.Testing.FsCheck/README.md` - Comprehensive documentation
- `tests/Encina.Testing.FsCheck.Tests/Encina.Testing.FsCheck.Tests.csproj` - Test project
- `tests/Encina.Testing.FsCheck.Tests/EncinaArbitrariesTests.cs` - Arbitrary tests
- `tests/Encina.Testing.FsCheck.Tests/EncinaPropertiesTests.cs` - Property tests
- `tests/Encina.Testing.FsCheck.Tests/GenExtensionsTests.cs` - Generator tests
- `tests/Encina.Testing.FsCheck.Tests/PropertyTestBaseTests.cs` - Base class tests

**EncinaArbitraries Implementation**:

- Core types: `EncinaError()`, `EncinaErrorWithException()`, `RequestContext()`
- Either types: `EitherOf<T>()`, `SuccessEither<T>()`, `FailureEither<T>()`
- Messaging types: `OutboxMessage()`, `PendingOutboxMessage()`, `FailedOutboxMessage()`
- `InboxMessage()`, `SagaState()`, `ScheduledMessage()`, `RecurringScheduledMessage()`
- Uses FsCheck 3.x `Gen.SelectMany` and `Gen.Select` static methods (not LINQ query syntax)
- Uses `ArbMap.Default.GeneratorFor<T>()` for default arbitraries

**EncinaProperties Implementation**:

- Either properties: `EitherIsExclusive()`, `MapPreservesRightState()`, `MapPreservesLeftError()`, `BindToFailureProducesLeft()`
- Error properties: `ErrorHasNonEmptyMessage()`, `ErrorFromStringPreservesMessage()`
- Context properties: `ContextHasCorrelationId()`, `WithMetadataIsImmutable()`, `WithUserIdCreatesNewContext()`
- Outbox: `OutboxProcessedStateIsConsistent()`, `OutboxDeadLetterIsConsistent()`, `OutboxHasRequiredFields()`
- Inbox: `InboxProcessedStateIsConsistent()`, `InboxHasRequiredFields()`
- Saga: `SagaStatusIsValid()`, `SagaHasRequiredFields()`, `SagaCompletedStateIsConsistent()`, `SagaCurrentStepIsNonNegative()`
- Scheduled: `ScheduledHasValidTiming()`, `RecurringHasCronExpression()`, `ScheduledHasRequiredFields()`
- Handler: `HandlerIsDeterministic()`, `AsyncHandlerIsDeterministic()`

**GenExtensions Implementation**:

- Either generators: `ToEither()`, `ToSuccess()`, `ToFailure<T>()`
- Nullable generators: `OrNull()`, `OrNullValue()`
- String generators: `NonEmptyString()`, `AlphaNumericString()`, `EmailAddress()`
- Data generators: `JsonObject()`, `UtcDateTime()`, `PastUtcDateTime()`, `FutureUtcDateTime()`
- Other: `CronExpression()`, `PositiveDecimal()`, `ListOf()`, `NonEmptyListOf()`

**xUnit Integration**:

- `PropertyTestBase` - Base class that auto-registers Encina arbitraries
- `EncinaArbitraryProvider` - Arbitrary provider for FsCheck type registration
- `[EncinaProperty]` - Standard property with 100 tests
- `[QuickProperty]` - Fast feedback with 20 tests
- `[ThoroughProperty]` - Comprehensive with 1000 tests
- `PropertyTestConfig` - Configuration constants

**Concrete Message Types**:

- `ArbitraryOutboxMessage` - Implements `IOutboxMessage`
- `ArbitraryInboxMessage` - Implements `IInboxMessage`
- `ArbitrarySagaState` - Implements `ISagaState`
- `ArbitraryScheduledMessage` - Implements `IScheduledMessage`

**FsCheck 3.x API Compatibility**:

- Uses `FsCheck.Fluent` namespace for C# API
- Uses `Gen.Select()` and `Gen.SelectMany()` static methods instead of LINQ query syntax
- Uses `Prop.ForAll()` to create properties (no `.ToProperty()` on bool)
- Uses `ArbMap.Default.GeneratorFor<T>()` instead of deprecated `Arb.Generate<T>()`
- Uses `Gen.Sample(gen, size, count)` parameter order

**Tests Created**:

- `EncinaArbitrariesTests.cs` - 22 tests for arbitrary generation
- `EncinaPropertiesTests.cs` - 22 tests for property validators
- `GenExtensionsTests.cs` - 18 tests for generator extensions
- `PropertyTestBaseTests.cs` - 13 tests for base class and attributes
- Total: 75 tests, all passing

**Dependencies Added**:

- FsCheck v3.3.2 added to `Directory.Packages.props`
- FsCheck.Xunit v3.3.2 added to `Directory.Packages.props`
- Package added to `Encina.slnx` solution file

**Design Decisions**:

1. Use FsCheck 3.x API exclusively (no backward compatibility with 2.x)
2. Static `Gen.Select`/`Gen.SelectMany` instead of LINQ query syntax for FsCheck 3.x
3. Properties handle whitespace-only `NonEmptyString` inputs gracefully
4. `EncinaArbitraryProvider` made `public` for use in test attributes
5. Concrete message types in separate file for clarity
6. README updated with FsCheck 3.x examples

**Test Types Justification**:

- Unit Tests: ✅ 75 tests covering all public APIs
- Property-Based Tests: ⏭️ Meta - package provides property testing, not tested with property testing
- Guard Clause Tests: ⏭️ Not applicable - uses standard `ArgumentNullException.ThrowIfNull`
- Integration Tests: ⏭️ Not applicable - pure in-memory generators
- Contract Tests: ⏭️ Not applicable - no interfaces to implement
- Load Tests: ⏭️ Not applicable - test utilities, not runtime code
- Benchmarks: ⏭️ Not applicable - test utilities, not runtime code

---

## Week 1: January 4 (Testing Infrastructure - PactNet CDC Testing)

### January 4 - Encina.Testing.Pact (Issue #436)

#### New Package: Encina.Testing.Pact

PactNet integration for Consumer-Driven Contract Testing (CDC) with Encina framework.

**Files Created**:

- `src/Encina.Testing.Pact/Encina.Testing.Pact.csproj` - Package definition with PactNet 5.0.1 dependency
- `src/Encina.Testing.Pact/EncinaPactConsumerBuilder.cs` - Fluent builder for consumer-side Pact expectations
- `src/Encina.Testing.Pact/EncinaPactProviderVerifier.cs` - Provider verification against Pact contracts
- `src/Encina.Testing.Pact/EncinaPactFixture.cs` - xUnit test fixture for simplified test setup
- `src/Encina.Testing.Pact/PactExtensions.cs` - Extension methods for working with Pact
- `src/Encina.Testing.Pact/XunitOutputAdapter.cs` - Adapter bridging xUnit ITestOutputHelper to PactNet IOutput
- `src/Encina.Testing.Pact/PublicAPI.Shipped.txt` - Empty (no shipped APIs yet)
- `src/Encina.Testing.Pact/PublicAPI.Unshipped.txt` - All public APIs (80 entries)
- `src/Encina.Testing.Pact/README.md` - Comprehensive documentation with usage examples
- `tests/Encina.Testing.Pact.Tests/Encina.Testing.Pact.Tests.csproj` - Test project
- `tests/Encina.Testing.Pact.Tests/TestTypes.cs` - Test types (commands, queries, notifications)
- `tests/Encina.Testing.Pact.Tests/EncinaPactConsumerBuilderTests.cs` - Consumer builder tests
- `tests/Encina.Testing.Pact.Tests/EncinaPactProviderVerifierTests.cs` - Provider verifier tests
- `tests/Encina.Testing.Pact.Tests/EncinaPactFixtureTests.cs` - Fixture tests
- `tests/Encina.Testing.Pact.Tests/PactExtensionsTests.cs` - Extension method tests
- `tests/Encina.Testing.Pact.Tests/GuardClauseTests.cs` - Guard clause tests for all public methods

**EncinaPactConsumerBuilder Implementation**:

- `WithCommandExpectation<TCommand, TResponse>()` - Define command request/response contracts
- `WithQueryExpectation<TQuery, TResponse>()` - Define query request/response contracts
- `WithNotificationExpectation<TNotification>()` - Define notification contracts
- `WithCommandFailureExpectation<TCommand, TResponse>()` - Define expected error responses for commands
- `WithQueryFailureExpectation<TQuery, TResponse>()` - Define expected error responses for queries
- `BuildAsync()` - Build the Pact and write to configured directory
- `GetMockServerUri()` - Get mock server URI for testing
- Automatic HTTP status code mapping from Encina error codes

**EncinaPactProviderVerifier Implementation**:

- `WithProviderName()` - Set the provider name for verification
- `WithProviderState(stateName, Action)` - Register synchronous provider state setup
- `WithProviderState(stateName, Func<Task>)` - Register async provider state setup
- `WithProviderState(stateName, Func<IDictionary<string,object>, Task>)` - State setup with parameters
- `VerifyAsync(pactFilePath)` - Verify a local Pact JSON file
- `VerifyFromBrokerAsync(brokerUrl, providerName)` - Verify from Pact Broker

**EncinaPactFixture Implementation**:

- Implements `IAsyncLifetime` and `IDisposable` for xUnit lifecycle management
- `CreateConsumer(consumerName, providerName)` - Create a consumer builder
- `CreateVerifier(providerName)` - Create a provider verifier
- `VerifyAsync(consumer, Action<Uri>)` - Verify with sync test action
- `VerifyAsync(consumer, Func<Uri, Task>)` - Verify with async test action
- `VerifyProviderAsync(providerName)` - Verify all Pact files for a provider
- `WithEncina(encina, serviceProvider)` - Configure with Encina instance
- `WithServices(configureServices)` - Configure with DI services

**PactExtensions Implementation**:

- `CreatePactHttpClient(Uri)` - Create HTTP client for mock server
- `SendCommandAsync<TCommand, TResponse>()` - Send command to mock server
- `SendQueryAsync<TQuery, TResponse>()` - Send query to mock server
- `PublishNotificationAsync<TNotification>()` - Publish notification to mock server
- `ReadAsEitherAsync<TResponse>()` - Deserialize response as Either result
- `ToPactResponse<TResponse>()` - Convert Either to Pact-compatible response

**Response Types**:

- `PactSuccessResponse<T>` - Success response wrapper with `IsSuccess` and `Data`
- `PactErrorResponse` - Error response with `IsSuccess`, `ErrorCode`, `ErrorMessage`
- `PactVerificationResult` - Verification result with `Success`, `Errors`, `InteractionResults`
- `InteractionVerificationResult` - Individual interaction result with `Description`, `Success`, `ErrorMessage`

**Error Code Mapping** (Automatic HTTP status code mapping):

- `encina.validation.*` → 400 Bad Request
- `encina.authorization.*` → 403 Forbidden
- `encina.authentication.*` → 401 Unauthorized
- `encina.notfound.*` → 404 Not Found
- `encina.conflict.*` → 409 Conflict
- `encina.timeout.*` → 408 Request Timeout
- `encina.ratelimit.*` → 429 Too Many Requests
- Other errors → 500 Internal Server Error

**Tests Created**:

- `EncinaPactConsumerBuilderTests.cs` - 17 unit tests
- `EncinaPactProviderVerifierTests.cs` - 24 unit tests
- `EncinaPactFixtureTests.cs` - 23 unit tests
- `PactExtensionsTests.cs` - 14 unit tests
- `GuardClauseTests.cs` - 40 guard clause tests
- Total: 118 tests, all passing

**Dependencies Added**:

- PactNet v5.0.1 added to `Directory.Packages.props`
- Package added to `Encina.slnx` solution file

**Design Decisions**:

1. Use PactNet 5.0.1 (latest stable) with V4 specification support
2. Custom `XunitOutputAdapter` instead of `PactNet.Output.Xunit` package (not needed in 5.x)
3. Fluent builder pattern for consumer expectations
4. Automatic error code to HTTP status code mapping
5. Support for both sync and async provider state handlers
6. RS0026 suppressed for constructors - Pre-1.0, no backward compatibility needed
7. Generic constraints (e.g., `where TCommand : ICommand<TResponse>`) for type safety

**Test Types Justification**:

- Unit Tests: ✅ 118 tests covering all public APIs
- Guard Clause Tests: ✅ 40 tests in `GuardClauseTests.cs`
- Property-Based Tests: ⏭️ Not applicable - CDC testing is contract-based, not property-based
- Integration Tests: ⏭️ Not implemented - would require real HTTP servers and Pact Broker
- Contract Tests: ⏭️ Meta - package provides contract testing, not tested with contracts
- Load Tests: ⏭️ Not applicable - test utilities, not runtime code
- Benchmarks: ⏭️ Not applicable - test utilities, not runtime code

---

## Week 1: January 5-6 (Dogfooding Initiative)

### January 5 - Dogfooding Initiative Setup (Issues #498-502)

#### Epic: Dogfooding Testing Infrastructure (#498)

Created comprehensive testing refactoring plan to use Encina.Testing infrastructure across all test projects.

**Child Issues Created**:

- #499 - Dogfood Phase 1: Core package tests (Encina) - **CLOSED**
- #500 - Dogfood Phase 2: DomainModeling package tests - **CLOSED**
- #501 - Dogfood Phase 3: Messaging package tests - **CLOSED**
- #502 - Dogfood Phase 4: Database provider tests (ADO, Dapper, EF Core)
- #503-#508 - Additional phases (Caching, Transports, Web, Resilience, Validation, Serverless)
- #509 - Investigation: Aspire Testing vs Testcontainers

**Goals**:

- 100% of tests use `Encina.Testing.*` packages
- 0 direct references to xUnit/NSubstitute/Testcontainers outside Testing packages
- Coverage ≥85% lines in all packages
- Tests serve as documentation and usage examples

### January 5-6 - Dogfood Phase 4: Database Provider Tests (#502)

#### Test Infrastructure Improvements

**FsCheck-Bogus Bridge** (Issue #502):

- Created `BogusArbitrary<T>` class bridging Bogus Faker with FsCheck generators
- Added `MessageDataGenerators` with pre-built generators for messaging entities:
  - `OutboxMessageDataGen()` - Generates OutboxMessageData instances
  - `InboxMessageDataGen()` - Generates InboxMessageData instances
  - `SagaStateDataGen()` - Generates SagaStateData instances
  - `ScheduledMessageDataGen()` - Generates ScheduledMessageData instances
- Each generator produces realistic test data using Bogus (not random garbage)

**TimeProvider Support for Dapper Stores**:

- Added `TimeProvider` injection to all Dapper store implementations
- Enables deterministic time control in tests using `FakeTimeProvider`
- Fixes SQLite datetime format incompatibility (ISO 8601 vs datetime('now'))

**Test Fixes Applied**:

| Provider | Test Type | Issue | Fix |
|----------|-----------|-------|-----|
| ADO.Sqlite | GuardTests | Missing using statement | Added `using Encina.Messaging;` |
| ADO.Sqlite | ContractTests | Wrong tag assertion | Removed incorrect "sqlite" tag expectation |
| ADO.* | GuardTests | Parameter name mismatch | Changed "next" to "nextStep" |
| Dapper.SqlServer | GuardTests | Parameter name mismatch | Changed "next" to "nextStep" |
| Dapper.Sqlite | GuardTests | Parameter name mismatch | Changed "next" to "nextStep" |
| EF Core | ContractTests | Invalid regex pattern | Changed `ShouldMatch("*Type*")` to `ShouldContain("Type")` |
| EF Core | PropertyTests | Missing tags | Added `DefaultTags` to `EntityFrameworkCoreHealthCheck` |
| EF Core | IntegrationTests | Nullable reference | Added null-forgiving operators |
| EF Core | IntegrationTests | Wrong method call | Changed `Count` to `Count()` |
| EF Core | IntegrationTests | Status enum mapping | Added `HasConversion<string>()` for SagaStatus |

**Test Results After Fixes**:

| Provider | Tests | PropertyTests | ContractTests | GuardTests | IntegrationTests | Total |
|----------|-------|---------------|---------------|------------|------------------|-------|
| ADO.Sqlite | 5 ✅ | 93 ✅ | 52 ✅ | 19 ✅ | 40 ✅ | 209 |
| EF Core | 61 ✅ | 53 ✅ | 43 ✅ | 25 ✅ | 37 ✅ | 219 |

### January 6 - Solution Filter Reorganization

Updated all solution filters (`.slnf` files) to include all corresponding test projects.

**Solution Filters Updated**:

| File | Changes |
|------|---------|
| `Encina.Core.slnf` | Added DomainModeling and all its tests |
| `Encina.Messaging.slnf` | Added TestInfrastructure |
| `Encina.EventSourcing.slnf` | Added TestInfrastructure, Marten.IntegrationTests |
| `Encina.Observability.slnf` | Added Messaging, TestInfrastructure |
| `Encina.Validation.slnf` | Added GuardClauses.Tests, reorganized |
| `Encina.Web.slnf` | Added SignalR, gRPC and tests |
| `Encina.Scheduling.slnf` | Reorganized TestInfrastructure |
| `Encina.Testing.slnf` | Added FsCheck, Verify, Testcontainers, Architecture, Aspire (32 projects) |
| `Encina.Database.slnf` | Full expansion - all 85 database provider test projects |
| `Encina.Caching.slnf` | Added TestInfrastructure, Redis.Tests |
| `Encina.Resilience.slnf` | Added TestInfrastructure |

**New Solution Filters Created**:

| File | Purpose |
|------|---------|
| `Encina.Transports.slnf` | RabbitMQ, Kafka, AzureServiceBus, AmazonSQS, NATS, MQTT |
| `Encina.Serverless.slnf` | AwsLambda, AzureFunctions |
| `Encina.DistributedLock.slnf` | DistributedLock, Redis, SqlServer |
| `Encina.Cli.slnf` | CLI tool |
| `Encina.Workflows.slnf` | Workflows |

**Files Modified**:

- `src/Encina.EntityFrameworkCore/Health/EntityFrameworkCoreHealthCheck.cs` - Added DefaultTags
- `tests/Encina.EntityFrameworkCore.IntegrationTests/TestEFDbContext.cs` - Added SagaStatus string conversion
- `tests/Encina.TestInfrastructure/Schemas/SqlServerSchema.cs` - Fixed schema definitions
- `tests/Encina.TestInfrastructure/PropertyTests/MessageDataGenerators.cs` - New FsCheck-Bogus bridge
- Multiple `*GuardTests.cs` files - Fixed parameter name assertions
- Multiple `*ContractTests.cs` files - Fixed regex assertions
- All `.slnf` files - Updated with complete test project lists

---

## Week 2: January 8 (Dogfooding Phase 7 - Web Integration)

### January 8 - Dogfood Phase 7: Web Integration Tests (#505)

#### Overview

Completed Phase 7 of the dogfooding initiative, focusing on web integration packages: AspNetCore, Refit, gRPC, and SignalR. All packages achieved ≥85% coverage target.

#### Coverage Results

| Package | Coverage | Tests | Target |
|---------|----------|-------|--------|
| Encina.AspNetCore | 89.3% | 101 | ≥85% ✅ |
| Encina.Refit | 92.1% | 46 | ≥85% ✅ |
| Encina.SignalR | 94.0% | 111 | ≥85% ✅ |
| Encina.gRPC | 97.7% | 78 | ≥85% ✅ |
| **Total** | **92.1%** | **336** | ≥85% ✅ |

#### Bug Fix: #520 - GrpcEncinaService Reflection Bug

During testing, discovered and fixed a critical reflection bug in `GrpcEncinaService`:

##### Problem 1: SendAsync searching for wrong method signature

```csharp
// BEFORE: Searching for methods with 2 generic arguments
var sendMethod = typeof(IEncina)
    .GetMethods()
    .First(m => m.Name == "Send" && m.GetGenericArguments().Length == 2);

// AFTER: IEncina.Send<TResponse> only has 1 generic argument
var sendMethod = typeof(IEncina)
    .GetMethods()
    .First(m => m.Name == "Send" && m.GetGenericArguments().Length == 1);
```

##### Problem 2: MakeGenericMethod with wrong parameters

```csharp
// BEFORE: Passing both request type and response type
var genericMethod = sendMethod.MakeGenericMethod(type, responseType);

// AFTER: Only pass response type
var genericMethod = sendMethod.MakeGenericMethod(responseType);
```

##### Problem 3: Either<> covariance issue with dynamic

```csharp
// BEFORE: Either<EncinaError, TResponse> can't assign to Either<EncinaError, object>
Either<EncinaError, object> result = await task;

// AFTER: Use explicit IsRight/IsLeft checks
dynamic result = await task;
if ((bool)result.IsRight)
{
    object? responseValue = null;
    result.IfRight((Action<object>)(r => responseValue = r));
    // ...
}
```

##### Problem 4: PublishAsync ignoring Either result

```csharp
// BEFORE: Ignoring the actual result
var task = (ValueTask)genericMethod.Invoke(_encina, [notification, cancellationToken])!;
await task;
return Right<EncinaError, Unit>(Unit.Default);

// AFTER: Propagate the actual result
var task = (dynamic)genericMethod.Invoke(_encina, [notification, cancellationToken])!;
Either<EncinaError, Unit> result = await task;
return result;
```

#### Files Created

**Encina.AspNetCore Tests**:

- `tests/Encina.AspNetCore.Tests/Health/EncinaHealthCheckAdapterTests.cs`
- `tests/Encina.AspNetCore.Tests/Health/HealthCheckBuilderExtensionsTests.cs`
- `tests/Encina.AspNetCore.Tests/TESTING-PATTERNS.md`

**Encina.Refit Tests**:

- `tests/Encina.Refit.Tests/RefitMockingExamplesTests.cs`

**Encina.SignalR Tests**:

- `tests/Encina.SignalR.Tests/SignalROptionsTests.cs`
- `tests/Encina.SignalR.Tests/BroadcastToSignalRAttributeTests.cs`
- `tests/Encina.SignalR.Tests/SignalRNotificationBroadcasterTests.cs`
- `tests/Encina.SignalR.Tests/SignalRBroadcastHandlerTests.cs`
- `tests/Encina.SignalR.Tests/EncinaHubTests.cs`
- `tests/Encina.SignalR.Tests/ServiceCollectionExtensionsTests.cs`
- `tests/Encina.SignalR.Tests/Integration/EncinaHubIntegrationTests.cs`
- `tests/Encina.SignalR.Tests/Integration/SignalRBroadcasterPropertyTests.cs`
- `tests/Encina.SignalR.Tests/Integration/SignalRNotificationBroadcasterIntegrationTests.cs`

**Encina.gRPC Tests**:

- `tests/Encina.gRPC.Tests/EncinaGrpcOptionsTests.cs`
- `tests/Encina.gRPC.Tests/GrpcEncinaServiceTests.cs`
- `tests/Encina.gRPC.Tests/ServiceCollectionExtensionsTests.cs`
- `tests/Encina.gRPC.Tests/Integration/GrpcEncinaServiceIntegrationTests.cs`
- `tests/Encina.gRPC.Tests/Integration/GrpcEncinaServicePropertyTests.cs`

#### Files Modified

- `src/Encina.gRPC/GrpcMediatorService.cs` - Bug #520 fix
- `src/Encina.gRPC/Log.cs` - Added `[ExcludeFromCodeCoverage]`
- `src/Encina.SignalR/Log.cs` - Added `[ExcludeFromCodeCoverage]`
- `tests/Encina.AspNetCore.Tests/EncinaContextMiddlewareTests.cs` - Enhanced tests
- `tests/Encina.Refit.Tests/RestApiRequestHandlerTests.cs` - Enhanced tests
- `tests/Encina.Refit.Tests/ServiceCollectionExtensionsTests.cs` - Enhanced tests
- `tests/Encina.Refit.IntegrationTests/RefitClientIntegrationTests.cs` - WireMock migration
- `tests/Encina.Refit.IntegrationTests/RestApiRequestHandlerIntegrationTests.cs` - WireMock migration

#### Commits

- `9c5fc76` - fix(gRPC): fix reflection bug in GrpcEncinaService (#520)
- `228ae64` - test(web): add comprehensive tests for web integration packages (#505)

#### Design Decisions

1. **Log.cs exclusion**: Generated `LoggerMessage` code excluded from coverage with `[ExcludeFromCodeCoverage]`
2. **EncinaHubTests reflection**: Used reflection-based property access instead of dynamic casting due to RuntimeBinderException
3. **WireMock migration**: Refit integration tests migrated from real HTTP calls to WireMock fixtures
4. **Integration test Skip removal**: 3 gRPC integration tests were skipped due to bug #520, now enabled

---

### January 8 - Dogfood Phase 8: Resilience & Observability Tests (#506)

#### Overview

Completed Phase 8 of the dogfooding initiative, focusing on resilience and observability packages: Encina.Polly and Encina.OpenTelemetry. Both packages already met the ≥85% coverage target.

#### Coverage Results

| Package | Coverage | Tests | Target |
|---------|----------|-------|--------|
| Encina.Polly | 89.3% | 214 | ≥85% ✅ |
| Encina.OpenTelemetry | 92.0% | 71 | ≥85% ✅ |

#### Test Fixes Applied

##### Encina.Polly.Tests

**BackoffTypeTests.cs** - .NET 10 breaking change

```csharp
// BEFORE: Count is now a method in .NET 10 for Span<T>
values.Count.ShouldBe(3);

// AFTER: Use Length property
values.Length.ShouldBe(3);
```

**BulkheadManagerTests.cs** - ValueTask handling

```csharp
// BEFORE: Func<Task> doesn't work with ValueTask
Func<Task> action = () => manager.TryAcquireAsync("test", config);
await Should.ThrowAsync<ObjectDisposedException>(action);

// AFTER: Use async lambda with await
var exception = await Should.ThrowAsync<ObjectDisposedException>(
    async () => await manager.TryAcquireAsync("test", config));
```

##### Encina.Polly.GuardTests

**AdaptiveRateLimiterGuardsTests.cs** - Missing async/await

```csharp
// BEFORE: Using await without async modifier
public void AcquireAsync_NullKey_ThrowsArgumentNullException()
{
    var ex = await Should.ThrowAsync<ArgumentNullException>(...);
}

// AFTER: Added async Task
public async Task AcquireAsync_NullKey_ThrowsArgumentNullException()
{
    var ex = await Should.ThrowAsync<ArgumentNullException>(
        async () => await rateLimiter.AcquireAsync(...));
}
```

**RateLimitingPipelineBehaviorGuardsTests.cs** - Wrong namespace

```csharp
// BEFORE: System.Threading.RateLimiting (BCL type)
using System.Threading.RateLimiting;

// AFTER: Encina.Polly (project-defined type)
using Encina.Polly;
```

##### Encina.OpenTelemetry.Tests

**ServiceCollectionExtensionsTests.cs** - Incorrect test assumption

```csharp
// BEFORE: Test expected options to be registered in DI
var registeredOptions = serviceProvider.GetService<EncinaOpenTelemetryOptions>();
registeredOptions.ShouldNotBeNull(); // FAILS

// AFTER: Test only verifies fluent API works
// WithEncina uses options internally, doesn't register them as service
result.ShouldNotBeNull();
result.ShouldBeSameAs(builder);
```

#### Test Projects Summary

| Project | Tests | Status |
|---------|-------|--------|
| Encina.Polly.Tests | 129 | ✅ |
| Encina.Polly.PropertyTests | 31 | ✅ |
| Encina.Polly.GuardTests | 17 | ✅ |
| Encina.Polly.ContractTests | 37 | ✅ |
| Encina.OpenTelemetry.Tests | 57 | ✅ |
| Encina.OpenTelemetry.PropertyTests | 8 | ✅ |
| Encina.OpenTelemetry.IntegrationTests | 6 | ✅ |

#### Files Modified

- `tests/Encina.Polly.Tests/BackoffTypeTests.cs` - Fixed Count→Length
- `tests/Encina.Polly.Tests/BulkheadManagerTests.cs` - Fixed ValueTask handling
- `tests/Encina.Polly.GuardTests/AdaptiveRateLimiterGuardsTests.cs` - Added async/await
- `tests/Encina.Polly.GuardTests/BulkheadManagerGuardsTests.cs` - Fixed ValueTask handling
- `tests/Encina.Polly.GuardTests/RateLimitingPipelineBehaviorGuardsTests.cs` - Fixed namespace
- `tests/Encina.OpenTelemetry.Tests/ServiceCollectionExtensionsTests.cs` - Fixed test assumption

---

### January 9 - Dogfooding Phase 9: Validation Provider Tests (Issue #507)

Comprehensive property-based testing for all validation providers using `Encina.Testing.FsCheck`.

#### Coverage Results (all ≥85% target met)

| Package | Line Coverage | Branch Coverage | Tests |
|---------|---------------|-----------------|-------|
| Encina.FluentValidation | 96.7% | 90.5% | 20 |
| Encina.DataAnnotations | 100% | 90% | 20 |
| Encina.MiniValidator | 100% | 100% | 17 |
| Cross-Provider (PropertyTests) | N/A | N/A | 13 |

**Total**: 70 property-based tests

#### Test Categories Implemented

1. **Null Input Invariants**: ArgumentNullException for null request/context
2. **Validation Idempotency**: Same request → same result across multiple calls
3. **Error Aggregation**: Multiple failures captured with all error details
4. **PropertyName Inclusion**: Field-level errors include property names
5. **ValidationResult Invariants**: IsValid/IsInvalid mutually exclusive
6. **ServiceCollection Extensions**: DI registration tests for all providers
7. **Context Metadata Propagation**: UserId, TenantId propagation to validation context
8. **Cross-Provider Consistency**: All providers behave identically for same inputs

#### Files Created

- `tests/Encina.FluentValidation.PropertyTests/ValidationInvariantProperties.cs`
- `tests/Encina.DataAnnotations.PropertyTests/ValidationInvariantProperties.cs`
- `tests/Encina.MiniValidator.PropertyTests/ValidationInvariantProperties.cs`
- `tests/Encina.PropertyTests/ValidationProviderProperties.cs`

#### Key Test Patterns

**ValidateSync Helper**: Wrapper for property tests that don't support async:

```csharp
private static ValidationResult ValidateSync<TRequest>(
    IValidationProvider provider,
    TRequest request,
    IRequestContext context)
    where TRequest : notnull
{
    return provider.ValidateAsync(request, context, CancellationToken.None)
        .AsTask()
        .GetAwaiter()
        .GetResult();
}
```

**Cross-Provider Testing**: Single test validates behavior across all providers:

```csharp
private IEnumerable<IValidationProvider> AllProviders()
{
    yield return CreateFluentValidationProvider();
    yield return CreateDataAnnotationsProvider();
    yield return CreateMiniValidationProvider();
}

[EncinaProperty]
public Property AllProviders_ValidRequest_ReturnsSuccess()
{
    return Prop.ForAll(validNameGen, validEmailGen, validAgeGen, (name, email, age) =>
    {
        foreach (var provider in AllProviders())
        {
            var result = ValidateSync(provider, request, context);
            if (!result.IsValid) return false;
        }
        return true;
    });
}
```

---

## Issue #508 - Dogfood Phase 10: Serverless & Scheduling Tests

**Date**: 2026-01-09
**Milestone**: v0.11.0 - Testing Infrastructure
**Packages**: Encina.AwsLambda.Tests, Encina.AzureFunctions.Tests, Encina.Hangfire.Tests, Encina.Quartz.Tests

### Overview

Refactored all serverless and scheduling test packages to use `Encina.Testing.*` infrastructure (dogfooding). This phase focused on applying EitherAssertions, Bogus fakers, and FakeLogger patterns across 6 test projects.

### Key Changes

**Hangfire Tests - FakeLogger Migration**:

- Replaced `Substitute.For<ILogger<T>>()` with `FakeLogger<T>` from Microsoft.Extensions.Diagnostics.Testing
- Enabled 7 previously skipped tests (Issue #6: LoggerMessage delegates incompatible with NSubstitute)
- Pattern matches Quartz tests which already used FakeLogger

**EitherAssertions Applied**:

- `ShouldBeSuccess()` replacing `result.IsRight.ShouldBeTrue()`
- `ShouldBeError()` replacing `result.IsLeft.ShouldBeTrue()`
- `ShouldBeErrorWithCode()` for detailed error validation

**Bogus Fakers Created**:

| Package | Fakers |
|---------|--------|
| Encina.AwsLambda.Tests | SqsMessageFaker, LambdaContextFaker, ApiGatewayRequestFaker |
| Encina.AzureFunctions.Tests | TestItemFaker |
| Encina.Hangfire.Tests | TestRequestFaker, TestResponseFaker, TestNotificationFaker |
| Encina.Quartz.Tests | TestRequestFaker, TestResponseFaker, TestNotificationFaker |

### Files Modified

| File | Changes |
|------|---------|
| `tests/Encina.AwsLambda.Tests/*.cs` | EitherAssertions applied |
| `tests/Encina.AzureFunctions.Tests/Durable/*.cs` | EitherAssertions + Bogus fakers |
| `tests/Encina.Hangfire.Tests/*.cs` | FakeLogger + EitherAssertions |
| `tests/Encina.Hangfire.Tests/Fakers/*.cs` | Bogus fakers (NEW) |
| `tests/Encina.Quartz.Tests/*.cs` | EitherAssertions + Bogus fakers |
| `tests/Encina.Quartz.Tests/Fakers/*.cs` | Bogus fakers (UPDATED) |

### Files Created

| File | Purpose |
|------|---------|
| `tests/Encina.Hangfire.Tests/Fakers/TestRequestFaker.cs` | Request data faker |
| `tests/Encina.Hangfire.Tests/Fakers/TestResponseFaker.cs` | Response data faker |
| `tests/Encina.Hangfire.Tests/Fakers/TestNotificationFaker.cs` | Notification data faker |

### Test Results

| Package | Tests | Skipped | Status |
|---------|-------|---------|--------|
| Encina.AwsLambda.Tests | 97 | 0 | ✅ PASS |
| Encina.AzureFunctions.Tests | 124 | 0 | ✅ PASS |
| Encina.Hangfire.Tests | 29 | 0 | ✅ PASS |
| Encina.Hangfire.IntegrationTests | 10 | 0 | ✅ PASS |
| Encina.Quartz.Tests | 36 | 0 | ✅ PASS |
| Encina.Quartz.IntegrationTests | 9 | 0 | ✅ PASS |
| **Total** | **305** | **0** | **PASS** |

### Coverage Results

| Package | Line Coverage | Target | Status |
|---------|--------------|--------|--------|
| Encina.AwsLambda | 86.71% | ≥85% | ✅ PASS |
| Encina.AzureFunctions | 35.40% | ≥85% | ⚠️ Below (infrastructure code) |
| Encina.Hangfire | 78.67% | ≥85% | ⚠️ Below (middleware untested) |
| Encina.Quartz | 76.68% | ≥85% | ⚠️ Below (scheduler untested) |

**Note**: Lower coverage in AzureFunctions, Hangfire, and Quartz is due to infrastructure code (middleware, health checks, scheduler integration) that requires complex mocking or real runtime environments. The test refactoring task focused on improving test quality, not adding new test coverage.

### Build Quality

- All 6 test projects build with **zero warnings**
- Code style guidelines followed for all Bogus faker classes

---

---

## Week 3: January 19 (Milestone Completion)

### January 19 - Milestone v0.11.0 Completed

**Summary**: Closed EPIC #498 and milestone v0.11.0 with all objectives achieved.

#### SonarCloud Quality Gate

Final SonarCloud analysis results:

| Metric | Value | Target | Status |
|--------|-------|--------|--------|
| Line Coverage | 92.3% | ≥85% | ✅ PASS |
| Reliability | A | A | ✅ PASS |
| Security | A | A | ✅ PASS |
| Maintainability | A | A | ✅ PASS |
| Issues | 0 | 0 | ✅ PASS |

**SonarCloud Configuration**:

- Added 38 issue exclusion rules for intentional design patterns
- Expanded coverage exclusions to ~50 packages/paths for integration-only code
- Moved GitHub Actions permissions from workflow to job level (S8264 rule)

#### Milestone Statistics

| Item | Count |
|------|-------|
| Total Issues Closed | 34 |
| New Packages Delivered | 10 |
| Dogfooding Phases Completed | 10 |
| Total Tests | 6,500+ |

#### Documentation Updated

- `CHANGELOG.md` - Added v0.11.0 release section
- `ROADMAP.md` - Marked v0.11.0 as completed, updated quality metrics
- `docs/history/2026-01.md` - Added milestone completion entry

#### PRs Merged

- PR #532: Bump actions/download-artifact from 6 to 7
- PR #533: Bump the nuget-minor group with 4 updates

---

## Week 4: January 20 (Repository Testing)

### January 20 - MongoDB Repository Internal Methods Coverage

**Issue Reference**: #519 (Database packages coverage)

**Problem**: `MongoDbRepositoryOptions<TEntity, TId>` had internal methods (`GetEffectiveCollectionName()` and `Validate()`) that couldn't be tested from the unit test project.

**Solution**:

1. Added `InternalsVisibleTo` attributes to `Encina.MongoDB.csproj`:
   - `Encina.UnitTests` - for unit testing
   - `Encina.IntegrationTests` - for integration testing

2. Created 8 new unit tests in `MongoDbRepositoryOptionsTests.cs`:
   - `GetEffectiveCollectionName_WithCustomCollectionName_ReturnsCustomName`
   - `GetEffectiveCollectionName_WithNullCollectionName_ReturnsDefaultName`
   - `GetEffectiveCollectionName_WithEmptyCollectionName_ReturnsDefaultName`
   - `GetEffectiveCollectionName_WithWhitespaceCollectionName_ReturnsDefaultName`
   - `GetEffectiveCollectionName_DefaultNaming_ConvertsToLowercase`
   - `Validate_WithIdPropertyConfigured_DoesNotThrow`
   - `Validate_WithoutIdProperty_ThrowsInvalidOperationException`
   - `Validate_WithNullIdProperty_ThrowsWithEntityTypeName`

**Files Modified**:

- `src/Encina.MongoDB/Encina.MongoDB.csproj` - Added InternalsVisibleTo
- `tests/Encina.UnitTests/MongoDB/Repository/MongoDbRepositoryOptionsTests.cs` - Added 8 tests

**Test Results**: 13 tests pass (5 original + 8 new)

---

---

## Week 4: January 20 (Specification Pattern Enhancement)

### January 20 - Specification Pattern Enhancement (#280)

**Milestone**: v0.12.0 - Database & Repository

#### Overview

Enhanced the Specification Pattern implementation across all data access providers (EF Core, Dapper, ADO.SqlServer, MongoDB) with comprehensive `QuerySpecification<T>` support for multi-column ordering, offset-based pagination, and keyset (cursor-based) pagination.

#### QuerySpecification<T> Features

The `QuerySpecification<T>` class in `Encina.DomainModeling` provides:

| Feature | Method | Description |
|---------|--------|-------------|
| Primary Ordering | `ApplyOrderBy()` / `ApplyOrderByDescending()` | First column in ORDER BY |
| Secondary Ordering | `ApplyThenBy()` / `ApplyThenByDescending()` | Additional columns in ORDER BY |
| Offset Pagination | `ApplyPaging(skip, take)` | Traditional OFFSET/FETCH pagination |
| Keyset Pagination | `ApplyKeysetPagination(keySelector, lastKey, pageSize)` | O(1) cursor-based pagination |

#### Provider Implementations

##### Encina.EntityFrameworkCore - SpecificationEvaluator

Enhanced `SpecificationEvaluator<TEntity>` to support `IQuerySpecification<T>`:

```csharp
// ThenBy/ThenByDescending support
foreach (var (selector, isDescending) in specification.ThenByExpressions)
{
    orderedQuery = isDescending
        ? orderedQuery.ThenByDescending(selector)
        : orderedQuery.ThenBy(selector);
}

// Keyset pagination
if (specification.KeysetKeySelector is not null && specification.KeysetLastKey is not null)
{
    var keysetFilter = BuildKeysetFilter(specification);
    query = query.Where(keysetFilter);
}
```

##### Encina.Dapper.SqlServer - SpecificationSqlBuilder

Enhanced `SpecificationSqlBuilder<TEntity>` with new methods:

- `BuildWhereClause(QuerySpecification<TEntity>)` - Method overload for QuerySpecification
- `BuildOrderByClause(IQuerySpecification<TEntity>)` - Generates ORDER BY with ASC/DESC
- `BuildPaginationClause(IQuerySpecification<TEntity>)` - Generates OFFSET/FETCH or keyset FETCH
- `BuildSelectStatement(tableName, QuerySpecification<TEntity>)` - Complete SELECT statement

Generated SQL example:

```sql
SELECT [Id], [Name], [Total], [IsActive], [CreatedAtUtc]
FROM Orders
WHERE [IsActive] = 1 AND [Id] > @p0
ORDER BY [Name] ASC, [CreatedAtUtc] DESC
OFFSET 0 ROWS FETCH NEXT 10 ROWS ONLY
```

##### Encina.ADO.SqlServer - SpecificationSqlBuilder

Same implementation pattern as Dapper, but using `Action<IDbCommand>` for parameter binding:

```csharp
public (string Sql, Action<IDbCommand> AddParameters) BuildSelectStatement(
    string tableName,
    QuerySpecification<TEntity> specification)
```

##### Encina.MongoDB - SpecificationFilterBuilder

Enhanced `SpecificationFilterBuilder<TEntity>` with:

- `BuildSortDefinition(IQuerySpecification<TEntity>)` - Returns `SortDefinition<TEntity>`
- `BuildKeysetFilter(IQuerySpecification<TEntity>)` - Returns keyset `FilterDefinition<TEntity>`

```csharp
var sortDefinition = builder.BuildSortDefinition(spec);
// Result: { "Name": 1, "CreatedAtUtc": -1 }

var keysetFilter = builder.BuildKeysetFilter(spec);
// Result: { "Id": { "$gt": lastId } }
```

#### Test Coverage

Created comprehensive unit tests for QuerySpecification features:

| Test File | Tests | Location |
|-----------|-------|----------|
| `SpecificationEvaluatorTests.cs` | 22 | `tests/Encina.UnitTests/EntityFrameworkCore/Repository/` |
| `QuerySpecificationSqlBuilderTests.cs` | 22 | `tests/Encina.UnitTests/Dapper/SqlServer/Repository/` |
| `QuerySpecificationSqlBuilderTests.cs` | 22 | `tests/Encina.UnitTests/ADO/SqlServer/Repository/` |
| `SpecificationFilterBuilderTests.cs` | 22 | `tests/Encina.UnitTests/MongoDB/Repository/` |

**Total**: 88 new tests

#### Test Categories

1. **BuildOrderByClause Tests**
   - `WithOrderBy_GeneratesAscendingOrder`
   - `WithOrderByDescending_GeneratesDescendingOrder`
   - `WithThenBy_GeneratesMultiColumnOrder`
   - `WithThenByDescending_GeneratesMultiColumnOrder`
   - `WithMultipleThenBy_GeneratesComplexOrder`
   - `WithNoOrdering_ReturnsEmptyString`
   - `NullSpecification_ThrowsArgumentNullException`

2. **BuildPaginationClause Tests**
   - `WithSkipAndTake_GeneratesOffsetFetch`
   - `WithSkipOnly_GeneratesOffsetFetchMaxValue`
   - `WithTakeOnly_GeneratesOffsetZeroFetch`
   - `WithNoPaging_ReturnsEmptyString`
   - `NullSpecification_ThrowsArgumentNullException`

3. **Keyset Pagination Tests**
   - `WithKeysetPagination_GeneratesKeysetFilter`
   - `WithKeysetPagination_GeneratesFetchOnly`
   - `WithKeysetPaginationNoLastKey_DoesNotAddKeysetFilter`

4. **BuildSelectStatement Tests**
   - `WithQuerySpecification_IncludesAllClauses`
   - `WithKeysetPagination_IncludesOffsetZero`
   - `WithQuerySpecification_NoOrdering_NoOrderByClause`

#### Files Created

| File | Purpose |
|------|---------|
| `tests/Encina.UnitTests/Dapper/SqlServer/Repository/QuerySpecificationSqlBuilderTests.cs` | Dapper QuerySpec tests |
| `tests/Encina.UnitTests/ADO/SqlServer/Repository/QuerySpecificationSqlBuilderTests.cs` | ADO.NET QuerySpec tests |

#### Files Modified

| File | Changes |
|------|---------|
| `src/Encina.ADO.SqlServer/Repository/SpecificationSqlBuilder.cs` | Added QuerySpecification support |
| `src/Encina.ADO.SqlServer/PublicAPI.Unshipped.txt` | Added new public API entries |
| `tests/Encina.UnitTests/EntityFrameworkCore/Repository/SpecificationEvaluatorTests.cs` | Added ThenBy and keyset tests |
| `tests/Encina.UnitTests/MongoDB/Repository/SpecificationFilterBuilderTests.cs` | Added SortDefinition and keyset tests |

#### PublicAPI Changes (ADO.SqlServer)

New public API entries added to `PublicAPI.Unshipped.txt`:

```
Encina.ADO.SqlServer.Repository.SpecificationSqlBuilder<TEntity>.BuildOrderByClause(Encina.DomainModeling.IQuerySpecification<TEntity>! specification) -> string!
Encina.ADO.SqlServer.Repository.SpecificationSqlBuilder<TEntity>.BuildPaginationClause(Encina.DomainModeling.IQuerySpecification<TEntity>! specification) -> string!
Encina.ADO.SqlServer.Repository.SpecificationSqlBuilder<TEntity>.BuildSelectStatement(string! tableName, Encina.DomainModeling.QuerySpecification<TEntity>! specification) -> (string! Sql, System.Action<System.Data.IDbCommand!>! AddParameters)
Encina.ADO.SqlServer.Repository.SpecificationSqlBuilder<TEntity>.BuildWhereClause(Encina.DomainModeling.QuerySpecification<TEntity>! specification) -> (string! WhereClause, System.Action<System.Data.IDbCommand!>! AddParameters)
```

#### Design Decisions

1. **Concrete class overloads**: Used `QuerySpecification<TEntity>` instead of `IQuerySpecification<TEntity>` for public API to avoid method overload ambiguity when calling with concrete QuerySpecification instances.

2. **Keyset pagination with OFFSET 0**: SQL Server requires OFFSET clause when using FETCH, so keyset pagination generates `OFFSET 0 ROWS FETCH NEXT N ROWS ONLY` instead of just `FETCH NEXT`.

3. **ApplyPaging(skip, take)**: The API only supports combined skip/take via `ApplyPaging()`. For skip-only, use `ApplyPaging(skip, int.MaxValue)`. For take-only, use `ApplyPaging(0, take)`.

4. **MongoDB SortDefinition**: Uses Builders<TEntity>.Sort.Ascending/Descending with Combine for multi-column sorting.

---

## Week 4: January 21 (Unit of Work Pattern)

### January 21 - Unit of Work Pattern Implementation (Issue #281)

Implemented the Unit of Work pattern (`IUnitOfWork`) across all data access providers for coordinating transactional operations across multiple repositories.

#### Phase 1: Core Interface (Encina.DomainModeling)

**New Files Created**:

- `src/Encina.DomainModeling/IUnitOfWork.cs` - Core interface
- `src/Encina.DomainModeling/UnitOfWorkErrors.cs` - Error definitions

**IUnitOfWork Interface**:

```csharp
public interface IUnitOfWork : IAsyncDisposable
{
    bool HasActiveTransaction { get; }
    IFunctionalRepository<TEntity, TId> Repository<TEntity, TId>()
        where TEntity : class where TId : notnull;
    Task<Either<EncinaError, int>> SaveChangesAsync(CancellationToken ct = default);
    Task<Either<EncinaError, Unit>> BeginTransactionAsync(CancellationToken ct = default);
    Task<Either<EncinaError, Unit>> CommitAsync(CancellationToken ct = default);
    Task RollbackAsync(CancellationToken ct = default);
}
```

**Error Codes**:

- `UnitOfWork.TransactionAlreadyActive` - Transaction already in progress
- `UnitOfWork.NoActiveTransaction` - No transaction to commit/rollback
- `UnitOfWork.TransactionStartFailed` - Failed to begin transaction
- `UnitOfWork.CommitFailed` - Failed to commit transaction
- `UnitOfWork.SaveChangesFailed` - Failed to save changes

#### Phase 2: EF Core Implementation

**New Files**:

- `src/Encina.EntityFrameworkCore/UnitOfWork/UnitOfWorkEF.cs` - Main implementation
- `src/Encina.EntityFrameworkCore/UnitOfWork/UnitOfWorkRepositoryEF.cs` - Repository wrapper

**Features**:

- Uses EF Core's `IDbContextTransaction` for transaction management
- Change tracking via `DbContext.SaveChangesAsync()`
- Concurrency conflict detection with detailed error messages
- Repository caching via `ConcurrentDictionary`

**Registration**:

```csharp
services.AddEncinaUnitOfWork<MyDbContext>();
```

#### Phase 3: Dapper/ADO.NET Implementation

**New Files**:

- `src/Encina.Dapper.SqlServer/UnitOfWork/UnitOfWorkDapper.cs`
- `src/Encina.Dapper.SqlServer/UnitOfWork/UnitOfWorkRepositoryDapper.cs`
- `src/Encina.ADO.SqlServer/UnitOfWork/UnitOfWorkADO.cs`
- `src/Encina.ADO.SqlServer/UnitOfWork/UnitOfWorkRepositoryADO.cs`

**Features**:

- Uses ADO.NET `IDbTransaction` for transaction management
- Passes transaction to all repository operations
- Connection state management (opens if closed)
- Requires `IEntityMapping<TEntity, TId>` for repository creation

#### Phase 4: MongoDB Implementation

**New Files**:

- `src/Encina.MongoDB/UnitOfWork/UnitOfWorkMongoDB.cs`
- `src/Encina.MongoDB/UnitOfWork/UnitOfWorkRepositoryMongoDB.cs`

**Features**:

- Uses MongoDB client sessions (`IClientSessionHandle`) for transactions
- Passes session to all collection operations
- **Requires replica set deployment** - Standalone MongoDB does not support transactions
- Operations work without transaction (session is optional)

**Registration**:

```csharp
// Register repository with options for UnitOfWork
services.AddEncinaRepository<Order, Guid>(options =>
{
    options.CollectionName = "orders";
    options.IdProperty = o => o.Id;
});

// Register UnitOfWork
services.AddEncinaUnitOfWork();
```

#### Test Coverage

**Unit Tests** (128 tests):

| Provider | Test Class | Tests |
|----------|-----------|-------|
| Core | `FunctionalRepositoryTests` | 10 |
| EF Core | `UnitOfWorkEFTests` | 24 |
| EF Core | `ServiceCollectionExtensionsUoWTests` | 4 |
| Dapper | `UnitOfWorkDapperTests` | 24 |
| Dapper | `ServiceCollectionExtensionsUoWTests` | 4 |
| ADO.NET | `UnitOfWorkADOTests` | 24 |
| ADO.NET | `ServiceCollectionExtensionsUoWTests` | 4 |
| MongoDB | `UnitOfWorkMongoDBTests` | 24 |
| MongoDB | `ServiceCollectionExtensionsUoWTests` | 4 |

**Integration Tests** (60 tests):

| Provider | Test Class | Tests |
|----------|-----------|-------|
| EF Core | `UnitOfWorkEFIntegrationTests` | 15 |
| Dapper | `UnitOfWorkDapperIntegrationTests` | 15 |
| ADO.NET | `UnitOfWorkADOIntegrationTests` | 15 |
| MongoDB | `UnitOfWorkMongoDBIntegrationTests` | 15 |

**Test Scenarios**:

1. Transaction commit with multiple entities
2. Transaction rollback verification
3. Auto-rollback on dispose
4. Repository caching (same entity type returns same instance)
5. Transaction state management (HasActiveTransaction)
6. Error handling (already active, no active, start failed, commit failed)
7. Complex workflows with multiple operations
8. Transaction isolation (uncommitted changes not visible externally)

#### Files Modified

| File | Changes |
|------|---------|
| `src/Encina.DomainModeling/Encina.DomainModeling.csproj` | Package reference |
| `src/Encina.DomainModeling/PublicAPI.Unshipped.txt` | New public APIs |
| `src/Encina.EntityFrameworkCore/ServiceCollectionExtensions.cs` | AddEncinaUnitOfWork |
| `src/Encina.EntityFrameworkCore/PublicAPI.Unshipped.txt` | New public APIs |
| `src/Encina.Dapper.SqlServer/ServiceCollectionExtensions.cs` | AddEncinaUnitOfWork |
| `src/Encina.Dapper.SqlServer/PublicAPI.Unshipped.txt` | New public APIs |
| `src/Encina.ADO.SqlServer/ServiceCollectionExtensions.cs` | AddEncinaUnitOfWork |
| `src/Encina.MongoDB/ServiceCollectionExtensions.cs` | AddEncinaUnitOfWork, repository options |
| `src/Encina.MongoDB/GlobalSuppressions.cs` | CA1031 suppression for UoW |

#### Design Decisions

1. **Railway Oriented Programming**: All operations return `Either<EncinaError, T>` instead of throwing exceptions.

2. **Repository Caching**: Repositories are cached by entity type to ensure same instance is returned.

3. **Auto-Rollback**: Uncommitted transactions are automatically rolled back on dispose.

4. **MongoDB Replica Set**: Documented requirement - transactions only work with replica set deployment.

5. **Scoped Lifetime**: UnitOfWork is registered as Scoped to match typical request lifetime.

6. **Repository Resolution**: Repositories are created on-demand from service provider to support lazy loading.

---

## Issue #282 - Multi-Tenancy Database Support

> **Completed**: January 21, 2026
>
> Implemented comprehensive multi-tenant database support across all data access providers.

### Overview

Issue #282 delivers multi-tenancy support with three isolation strategies (SharedSchema, SchemaPerTenant, DatabasePerTenant) that work consistently across EF Core, Dapper, ADO.NET, and MongoDB providers.

### Implementation Phases

#### Phase 1-3: Core Tenancy Infrastructure (Previously Completed)

Core tenancy abstractions in `Encina.Tenancy` and ASP.NET Core integration in `Encina.Tenancy.AspNetCore` were already in place:

- `TenantInfo` record with isolation strategy
- `ITenantProvider` and `ITenantStore` interfaces
- `InMemoryTenantStore` for development/testing
- Four tenant resolvers (Header, Claim, Route, Subdomain)
- `TenantResolverChain` for priority-based resolution
- `TenantResolutionMiddleware` for ASP.NET Core

#### Phase 4: Dapper Integration

**New Files** (`src/Encina.Dapper.SqlServer/Tenancy/`):

| File | Purpose |
|------|---------|
| `DapperTenancyOptions.cs` | Configuration options for Dapper tenancy |
| `ITenantEntityMapping.cs` | Entity-to-table mapping interface |
| `TenantEntityMappingBuilder.cs` | Fluent mapping builder |
| `TenantAwareSpecificationSqlBuilder.cs` | SQL builder with tenant filtering |
| `TenantAwareFunctionalRepositoryDapper.cs` | Repository with auto tenant filtering |
| `TenancyServiceCollectionExtensions.cs` | DI registration extensions |

**Tests** (`tests/Encina.UnitTests/Dapper/SqlServer/Tenancy/`):

| Test File | Tests |
|-----------|-------|
| `DapperTenancyOptionsTests.cs` | 8 tests |
| `TenantEntityMappingBuilderTests.cs` | 16 tests |
| `TenantAwareSpecificationSqlBuilderTests.cs` | 14 tests |
| `TenancyServiceCollectionExtensionsTests.cs` | 8 tests |

#### Phase 5: ADO.NET Integration

**New Files** (`src/Encina.ADO.SqlServer/Tenancy/`):

| File | Purpose |
|------|---------|
| `ADOTenancyOptions.cs` | Configuration options for ADO.NET tenancy |
| `ITenantEntityMapping.cs` | Entity-to-table mapping interface |
| `TenantEntityMappingBuilder.cs` | Fluent mapping builder |
| `TenantAwareSpecificationSqlBuilder.cs` | SQL builder with tenant filtering |
| `TenantAwareFunctionalRepositoryADO.cs` | Repository with auto tenant filtering |
| `TenancyServiceCollectionExtensions.cs` | DI registration extensions |

**Tests** (`tests/Encina.UnitTests/ADO/SqlServer/Tenancy/`):

| Test File | Tests |
|-----------|-------|
| `ADOTenancyOptionsTests.cs` | 8 tests |
| `TenantEntityMappingBuilderTests.cs` | 16 tests |
| `TenantAwareSpecificationSqlBuilderTests.cs` | 14 tests |
| `TenancyServiceCollectionExtensionsTests.cs` | 8 tests |

#### Phase 6: MongoDB Integration

**New Files** (`src/Encina.MongoDB/Tenancy/`):

| File | Purpose |
|------|---------|
| `MongoDbTenancyOptions.cs` | Configuration with database-per-tenant pattern |
| `ITenantEntityMapping.cs` | Entity-to-collection mapping interface |
| `TenantEntityMappingBuilder.cs` | Fluent mapping builder with `HasTenantId()` |
| `TenantAwareSpecificationFilterBuilder.cs` | Filter builder using `Builders<T>.Filter.And()` |
| `TenantAwareFunctionalRepositoryMongoDB.cs` | Repository with auto tenant filtering |
| `IMongoCollectionFactory.cs` | Interface for tenant-aware collection routing |
| `TenantAwareMongoCollectionFactory.cs` | Database-per-tenant routing implementation |
| `TenancyServiceCollectionExtensions.cs` | `AddEncinaMongoDBWithTenancy()` extension |

**Tests** (`tests/Encina.UnitTests/MongoDB/Tenancy/`):

| Test File | Tests |
|-----------|-------|
| `MongoDbTenancyOptionsTests.cs` | 16 tests |
| `TenantEntityMappingBuilderTests.cs` | 14 tests |
| `TenantAwareSpecificationFilterBuilderTests.cs` | 14 tests |
| `TenantAwareMongoCollectionFactoryTests.cs` | 13 tests |
| `TenancyServiceCollectionExtensionsTests.cs` | 11 tests |

#### Phase 7: Testing and Documentation

**Test Summary**:

| Component | Tests |
|-----------|-------|
| Core Tenancy (`Encina.Tenancy`) | ~100 tests |
| ASP.NET Core (`Encina.Tenancy.AspNetCore`) | ~80 tests |
| Dapper/ADO.NET Tenancy | ~80 tests |
| MongoDB Tenancy | 72 tests |
| **Total** | **376 tests** |

**Documentation**:

- `docs/features/multi-tenancy.md` (849 lines)
  - Overview of multi-tenancy concepts
  - Three isolation strategies with pros/cons
  - Mermaid decision flowchart
  - Architecture diagrams (class and sequence)
  - Configuration examples for all providers
  - Tenant resolution setup (Header, Claim, Route, Subdomain)
  - Custom resolver and store examples
  - Migration guide for existing tables
  - FAQ section

### Key Features

1. **Auto Query Filtering**: All queries automatically include tenant filter
2. **Auto Tenant Assignment**: New entities automatically get current tenant ID
3. **Cross-Tenant Validation**: Updates/deletes verify entity belongs to current tenant
4. **Database-per-Tenant (MongoDB)**: `DatabaseNamePattern` supports `{baseName}_{tenantId}`
5. **Consistent API**: Same pattern across EF Core, Dapper, ADO.NET, MongoDB

### Configuration Examples

```csharp
// Dapper with tenancy
services.AddEncinaDapperSqlServerWithTenancy(connectionString, tenancy => {
    tenancy.AutoFilterTenantQueries = true;
    tenancy.AutoAssignTenantId = true;
    tenancy.TenantColumnName = "TenantId";
});

// MongoDB with database-per-tenant
services.AddEncinaMongoDBWithTenancy(config => {
    config.ConnectionString = "mongodb://localhost:27017";
    config.DatabaseName = "MultiTenantApp";
}, tenancy => {
    tenancy.EnableDatabasePerTenant = true;
    tenancy.DatabaseNamePattern = "{baseName}_{tenantId}";
});

// ASP.NET Core tenant resolution
services.AddEncinaTenancyAspNetCore(options => {
    options.HeaderResolver.Enabled = true;
    options.HeaderResolver.HeaderName = "X-Tenant-Id";
    options.SubdomainResolver.Enabled = true;
    options.SubdomainResolver.BaseDomain = "example.com";
});
app.UseEncinaTenantResolution();
```

### Files Changed Summary

| Category | Files |
|----------|-------|
| Dapper tenancy source | 6 files |
| Dapper tenancy tests | 4 files |
| ADO.NET tenancy source | 6 files |
| ADO.NET tenancy tests | 4 files |
| MongoDB tenancy source | 8 files |
| MongoDB tenancy tests | 5 files |
| Documentation | 1 file |
| **Total** | **34 files** |

---

## Week 4: January 21 (Module Isolation)

### January 21 - Module Isolation by Database Permissions (Issue #534)

**Implementation**: Complete module isolation feature for modular monolith architectures.

This feature enforces bounded context boundaries at the database level, preventing modules from directly accessing each other's data through schema-based isolation.

#### Core Abstractions (`Encina`)

**ModuleIsolationOptions & ModuleSchemaOptions**:

- `ModuleIsolationOptions` - Global isolation configuration
  - `Strategy` - DevelopmentValidationOnly, SchemaWithPermissions, or ConnectionPerModule
  - `SharedSchemas` - Schemas accessible by all modules (read-only)
  - `ModuleSchemas` - Per-module schema configurations
  - `GeneratePermissionScripts` - Enable SQL script generation
  - `PermissionScriptsOutputPath` - Output directory for scripts
- `ModuleSchemaOptions` - Per-module configuration
  - `ModuleName` - Module identifier
  - `SchemaName` - Database schema owned by module
  - `DatabaseUser` - Optional database user for permissions strategy
  - `AdditionalAllowedSchemas` - Extra schemas for read access
- `ModuleSchemaOptionsBuilder` - Fluent builder for ModuleSchemaOptions

**ModuleIsolationStrategy Enum**:

- `DevelopmentValidationOnly` (0) - Runtime SQL validation without DB users
- `SchemaWithPermissions` (1) - Real database users with limited permissions
- `ConnectionPerModule` (2) - Separate connection strings per module

**IModuleSchemaRegistry Interface**:

- `GetAllowedSchemas(moduleName)` - Get all schemas a module can access
- `GetModuleOptions(moduleName)` - Get module's schema configuration
- `CanAccessSchema(moduleName, schemaName)` - Check if access is allowed
- `ValidateSqlAccess(moduleName, sql)` - Validate SQL against allowed schemas
- `GetSharedSchemas()` - Get globally shared schemas
- `IsModuleRegistered(moduleName)` - Check if module is registered
- `GetRegisteredModules()` - Get all registered module names

**SqlSchemaExtractor Static Class**:

- Uses `[GeneratedRegex]` for schema extraction with 1000ms timeout
- Three regex patterns:
  - `SchemaTablePatternRegex` - FROM, JOIN, INTO, UPDATE, MERGE statements
  - `DeleteFromPatternRegex` - DELETE FROM statements
  - `GenericSchemaTablePatternRegex` - General schema.table patterns
- Methods:
  - `ExtractSchemas(sql)` - Returns IReadOnlySet<string> of schemas
  - `ValidateSchemaAccess(sql, allowedSchemas)` - Returns validation tuple
  - `ExtractTableReferences(sql)` - Returns List<(Schema, Table)>
- Handles bracketed `[schema].[table]` and quoted `"schema"."table"` identifiers
- `DefaultSchema` constant = "dbo"
- Reserved keyword filtering (sys, information_schema)

**IModulePermissionScriptGenerator Interface**:

- `ProviderName` - Database provider identifier
- `GenerateSchemaCreationScript(options)` - CREATE SCHEMA statements
- `GenerateUserCreationScript(options)` - CREATE USER/LOGIN statements
- `GenerateGrantPermissionsScript(options)` - GRANT statements
- `GenerateRevokePermissionsScript(options)` - REVOKE statements (cleanup)
- `GenerateAllScripts(options)` - All scripts in execution order
- `GenerateModulePermissionsScript(moduleOptions, sharedSchemas)` - Per-module script

**PermissionScript Record Struct**:

- `Name` - Script filename (e.g., "001_create_schemas.sql")
- `Description` - Human-readable description
- `Content` - SQL script content
- `Order` - Execution order (0-10+)
- Factory methods: `ForSchemaCreation`, `ForUserCreation`, `ForGrantPermissions`, `ForRevokePermissions`, `ForModule`

#### SQL Server Implementation

**SqlServerPermissionScriptGenerator**:

- `ProviderName` = "SqlServer"
- Generates idempotent scripts with IF NOT EXISTS checks
- Proper escaping of special characters in identifiers
- Uses `[bracketed]` identifiers for SQL Server
- Generates GRANT SELECT, INSERT, UPDATE, DELETE per schema
- Handles shared schemas with SELECT-only grants

#### PostgreSQL Implementation

**PostgreSqlPermissionScriptGenerator**:

- `ProviderName` = "PostgreSql"
- Creates roles with LOGIN instead of users
- Uses `CREATE SCHEMA IF NOT EXISTS` syntax
- Includes `ALTER DEFAULT PRIVILEGES` for future objects
- Grants on SEQUENCES for identity columns
- Uses `"double-quoted"` identifiers for PostgreSQL

#### EF Core Implementation (`Encina.EntityFrameworkCore`)

- DbContext interceptor for SQL validation
- Integration with ModuleExecutionContext for ambient module context
- Schema validation during query execution

#### Dapper Implementation (`Encina.Dapper.SqlServer`)

- Command interceptor for SQL validation
- `AddEncinaDapperSqlServerWithModuleIsolation()` extension method
- Integrates with existing tenancy infrastructure

#### ADO.NET Implementation (`Encina.ADO.SqlServer`)

- DbCommand interceptor for SQL validation
- `AddEncinaADOSqlServerWithModuleIsolation()` extension method

#### MongoDB Implementation (`Encina.MongoDB`)

- `MongoDbModuleIsolationOptions` - MongoDB-specific options
- `IModuleAwareMongoCollectionFactory` - Collection factory with module context
- Collection prefix isolation (e.g., `orders_Orders`, `payments_Payments`)
- `ModuleExecutionContext` - AsyncLocal for ambient module tracking
- Logging with EventIds 60-63 for module operations

#### Testing

**Test Files Created**:

| Test Class | Tests | Description |
|------------|-------|-------------|
| `SqlSchemaExtractorTests` | 28 | Schema extraction from SQL |
| `ModuleSchemaRegistryTests` | 22 | Registry operations and validation |
| `SqlServerPermissionScriptGeneratorTests` | 32 | SQL Server script generation (snapshot) |
| `PostgreSqlPermissionScriptGeneratorTests` | 32 | PostgreSQL script generation (snapshot) |
| `PermissionScriptTests` | 14 | PermissionScript record struct |
| `ModuleExecutionContextTests` | 20 | AsyncLocal behavior |
| `MongoDbModuleIsolationTests` | 24 | MongoDB-specific isolation |

**Snapshot Testing**:

- Uses Verify.Xunit for script content verification
- 16 `.verified.txt` files for SQL Server scripts
- 16 `.verified.txt` files for PostgreSQL scripts

**Key Test Fixes**:

- `AdditionalAllowedSchemas` uses collection initializer syntax: `AdditionalAllowedSchemas = ["audit"]`
- SqlSchemaExtractor regex matches alias.column patterns (o.Id, p.Amount)
- Tests updated to include alias patterns in assertions

#### Documentation

- `docs/features/module-isolation.md` (560+ lines)
  - Overview and architecture diagrams
  - Isolation strategy comparison table
  - Mermaid decision flowchart
  - Configuration examples for all providers
  - Shared schema patterns
  - Permission script generation guide
  - Inter-module communication with Outbox/Inbox
  - Combined multi-tenancy example
  - FAQ section

#### Files Changed Summary

| Category | Count |
|----------|-------|
| Core isolation source | 8 files |
| Core isolation tests | 7 files |
| EF Core integration | 2 files |
| Dapper integration | 2 files |
| ADO.NET integration | 2 files |
| MongoDB integration | 4 files |
| Snapshot verified files | 32 files |
| Documentation | 1 file |
| **Total** | **58 files** |

---

## Week 4: January 23 (Multi-Tenancy Support)

### January 23 - Multi-Tenancy Support (#282)

**Issue**: [#282 - Multi-Tenancy Database Support](https://github.com/dlrivada/Encina/issues/282)
**Milestone**: v0.12.0 - Database & Repository

#### Overview

Implemented Multi-Tenancy support across all 8 remaining database providers (ADO.SQLite, ADO.PostgreSQL, ADO.MySQL, ADO.Oracle, Dapper.SQLite, Dapper.PostgreSQL, Dapper.MySQL, Dapper.Oracle), completing the tenancy infrastructure across the entire Encina data access layer.

#### Providers Implemented

| Provider | Package | Components |
|----------|---------|------------|
| ADO.SQLite | `Encina.ADO.Sqlite` | `TenantAwareFunctionalRepositoryADO`, `TenantEntityMappingBuilder`, `TenantConnectionFactory`, `ADOTenancyOptions` |
| ADO.PostgreSQL | `Encina.ADO.PostgreSQL` | `TenantAwareFunctionalRepositoryADO`, `TenantEntityMappingBuilder`, `TenantConnectionFactory`, `ADOTenancyOptions` |
| ADO.MySQL | `Encina.ADO.MySQL` | `TenantAwareFunctionalRepositoryADO`, `TenantEntityMappingBuilder`, `TenantConnectionFactory`, `ADOTenancyOptions` |
| ADO.Oracle | `Encina.ADO.Oracle` | `TenantAwareFunctionalRepositoryADO`, `TenantEntityMappingBuilder`, `TenantConnectionFactory`, `ADOTenancyOptions` |
| Dapper.SQLite | `Encina.Dapper.Sqlite` | `TenantAwareFunctionalRepositoryDapper`, `TenantEntityMappingBuilder`, `TenantConnectionFactory`, `DapperTenancyOptions` |
| Dapper.PostgreSQL | `Encina.Dapper.PostgreSQL` | `TenantAwareFunctionalRepositoryDapper`, `TenantEntityMappingBuilder`, `TenantConnectionFactory`, `DapperTenancyOptions` |
| Dapper.MySQL | `Encina.Dapper.MySQL` | `TenantAwareFunctionalRepositoryDapper`, `TenantEntityMappingBuilder`, `TenantConnectionFactory`, `DapperTenancyOptions` |
| Dapper.Oracle | `Encina.Dapper.Oracle` | `TenantAwareFunctionalRepositoryDapper`, `TenantEntityMappingBuilder`, `TenantConnectionFactory`, `DapperTenancyOptions` |

#### Database-Specific SQL Dialects

| Database | Identifier Quoting | Pagination | Parameters | Duplicate Key Error |
|----------|-------------------|------------|------------|---------------------|
| SQLite | `"column"` | LIMIT/OFFSET | `@p0` | "UNIQUE constraint failed" |
| PostgreSQL | `"column"` | LIMIT/OFFSET | `@p0` | "duplicate key" |
| MySQL | `` `column` `` | LIMIT/OFFSET | `@p0` | "Duplicate entry" |
| Oracle | `"COLUMN"` | OFFSET/FETCH | `:p0` | "ORA-00001" |

#### Tenancy Options Configuration

**ADOTenancyOptions / DapperTenancyOptions**:

- `AutoFilterTenantQueries` (default: true) - Automatically adds WHERE TenantId = @TenantId to all queries
- `AutoAssignTenantId` (default: true) - Automatically sets TenantId on insert operations
- `ValidateTenantOnModify` (default: true) - Validates entity belongs to current tenant on update/delete
- `ThrowOnMissingTenantContext` (default: true) - Throws when ITenantContext has no current tenant
- `TenantColumnName` (default: "TenantId") - Column name for tenant identifier

#### Key Components

**TenantEntityMappingBuilder<TEntity, TId>**:

```csharp
var mapping = new TenantEntityMappingBuilder<Order, Guid>()
    .ToTable("Orders")
    .HasId(o => o.Id)
    .HasTenantId(o => o.TenantId)  // Auto-excludes from updates
    .MapProperty(o => o.CustomerId)
    .MapProperty(o => o.Total)
    .Build();
```

**TenantAwareFunctionalRepository Features**:

- `GetByIdAsync()` - Filters by tenant automatically
- `GetAllAsync()` - Filters by tenant automatically
- `AddAsync()` - Auto-assigns TenantId from context
- `UpdateAsync()` - Validates tenant ownership
- `DeleteAsync()` - Validates tenant ownership
- `ExistsAsync()` - Checks existence within tenant scope

**TenantConnectionFactory**:

- Database-per-tenant routing
- Connection string resolution from ITenantContext
- Configurable via `ITenantDatabaseResolver`

#### Files Created

**ADO Providers (per provider)**:

- `src/Encina.ADO.{Provider}/Tenancy/ADOTenancyOptions.cs`
- `src/Encina.ADO.{Provider}/Tenancy/ITenantEntityMapping.cs`
- `src/Encina.ADO.{Provider}/Tenancy/TenantEntityMappingBuilder.cs`
- `src/Encina.ADO.{Provider}/Tenancy/ITenantConnectionFactory.cs`
- `src/Encina.ADO.{Provider}/Tenancy/TenantConnectionFactory.cs`
- `src/Encina.ADO.{Provider}/Tenancy/TenantAwareSpecificationSqlBuilder.cs`
- `src/Encina.ADO.{Provider}/Tenancy/TenantAwareFunctionalRepositoryADO.cs`
- `src/Encina.ADO.{Provider}/Tenancy/TenancyServiceCollectionExtensions.cs`

**Dapper Providers (per provider)**:

- `src/Encina.Dapper.{Provider}/Tenancy/DapperTenancyOptions.cs`
- `src/Encina.Dapper.{Provider}/Tenancy/ITenantEntityMapping.cs`
- `src/Encina.Dapper.{Provider}/Tenancy/TenantEntityMappingBuilder.cs`
- `src/Encina.Dapper.{Provider}/Tenancy/ITenantConnectionFactory.cs`
- `src/Encina.Dapper.{Provider}/Tenancy/TenantConnectionFactory.cs`
- `src/Encina.Dapper.{Provider}/Tenancy/TenantAwareSpecificationSqlBuilder.cs`
- `src/Encina.Dapper.{Provider}/Tenancy/TenantAwareFunctionalRepositoryDapper.cs`
- `src/Encina.Dapper.{Provider}/Tenancy/TenancyServiceCollectionExtensions.cs`

#### Test Files Created

| Test Class | Tests | Location |
|------------|-------|----------|
| `ADOTenancyOptionsTests` (SQLite) | 6 | `tests/Encina.UnitTests/ADO/Sqlite/Tenancy/` |
| `TenantEntityMappingBuilderTests` (SQLite) | 8 | `tests/Encina.UnitTests/ADO/Sqlite/Tenancy/` |
| `ADOTenancyOptionsTests` (PostgreSQL) | 6 | `tests/Encina.UnitTests/ADO/PostgreSQL/Tenancy/` |
| `TenantEntityMappingBuilderTests` (PostgreSQL) | 8 | `tests/Encina.UnitTests/ADO/PostgreSQL/Tenancy/` |
| `ADOTenancyOptionsTests` (MySQL) | 6 | `tests/Encina.UnitTests/ADO/MySQL/Tenancy/` |
| `TenantEntityMappingBuilderTests` (MySQL) | 8 | `tests/Encina.UnitTests/ADO/MySQL/Tenancy/` |
| `ADOTenancyOptionsTests` (Oracle) | 6 | `tests/Encina.UnitTests/ADO/Oracle/Tenancy/` |
| `TenantEntityMappingBuilderTests` (Oracle) | 8 | `tests/Encina.UnitTests/ADO/Oracle/Tenancy/` |
| `DapperTenancyOptionsTests` (SQLite) | 6 | `tests/Encina.UnitTests/Dapper/Sqlite/Tenancy/` |
| `TenantEntityMappingBuilderTests` (SQLite) | 8 | `tests/Encina.UnitTests/Dapper/Sqlite/Tenancy/` |
| `DapperTenancyOptionsTests` (PostgreSQL) | 6 | `tests/Encina.UnitTests/Dapper/PostgreSQL/Tenancy/` |
| `TenantEntityMappingBuilderTests` (PostgreSQL) | 8 | `tests/Encina.UnitTests/Dapper/PostgreSQL/Tenancy/` |
| `DapperTenancyOptionsTests` (MySQL) | 6 | `tests/Encina.UnitTests/Dapper/MySQL/Tenancy/` |
| `TenantEntityMappingBuilderTests` (MySQL) | 8 | `tests/Encina.UnitTests/Dapper/MySQL/Tenancy/` |
| `DapperTenancyOptionsTests` (Oracle) | 6 | `tests/Encina.UnitTests/Dapper/Oracle/Tenancy/` |
| `TenantEntityMappingBuilderTests` (Oracle) | 8 | `tests/Encina.UnitTests/Dapper/Oracle/Tenancy/` |

**Total Tests**: 485 tests passing

#### Design Decisions

1. **TenantId auto-exclusion from updates**: `HasTenantId()` automatically adds the property to `UpdateExcludedProperties` to prevent accidental tenant reassignment.

2. **Cross-tenant validation**: Update and delete operations validate that the entity belongs to the current tenant before proceeding.

3. **ITenantEntity interface**: All tenant-aware entities must implement `ITenantEntity` from `Encina.Tenancy` package.

4. **Connection factory abstraction**: `ITenantConnectionFactory` enables database-per-tenant strategies without coupling to specific connection resolution logic.

5. **Provider-specific SQL**: Each provider uses appropriate SQL dialect (identifier quoting, pagination syntax, parameter prefixes).

#### Files Modified

- `src/Encina.ADO.Sqlite/Encina.ADO.Sqlite.csproj` - Added Encina.Tenancy reference
- `src/Encina.ADO.PostgreSQL/Encina.ADO.PostgreSQL.csproj` - Added Encina.Tenancy reference
- `src/Encina.ADO.MySQL/Encina.ADO.MySQL.csproj` - Added Encina.Tenancy reference
- `src/Encina.ADO.Oracle/Encina.ADO.Oracle.csproj` - Added Encina.Tenancy reference
- `src/Encina.Dapper.Sqlite/Encina.Dapper.Sqlite.csproj` - Added Encina.Tenancy reference
- `src/Encina.Dapper.PostgreSQL/Encina.Dapper.PostgreSQL.csproj` - Added Encina.Tenancy reference
- `src/Encina.Dapper.MySQL/Encina.Dapper.MySQL.csproj` - Added Encina.Tenancy reference
- `src/Encina.Dapper.Oracle/Encina.Dapper.Oracle.csproj` - Added Encina.Tenancy reference
- `CHANGELOG.md` - Added Multi-Tenancy section for #282
- `ROADMAP.md` - Marked #282 as completed

---

### January 26 - Integration Tests Implementation (#537)

**Issue**: [#537 - Implement real IntegrationTests with Docker/Testcontainers for Database features](https://github.com/dlrivada/Encina/issues/537)

Implemented comprehensive integration tests across all database providers using real databases via Docker/Testcontainers, replacing 23 justification `.md` files with actual test implementations.

#### Summary

| Phase | Provider | Tests Added | Status |
|-------|----------|-------------|--------|
| Phase 2 | ADO.NET (4 providers) | 164 tests | Completed |
| Phase 3 | Dapper (4 providers) | 164 tests | Completed |
| Phase 4 | EF Core (4 providers) | 136 tests | Completed |
| Phase 5 | MongoDB | 15 tests | Completed |
| Phase 6 | Cleanup | 23 .md files removed | Completed |

**Total Tests Added**: ~479 integration tests across all providers

#### Test Categories Implemented

1. **Repository Tests**: CRUD operations with real database transactions
2. **Multi-Tenancy Tests**: Tenant isolation, auto-assignment, cross-tenant access prevention
3. **Module Isolation Tests**: Schema/prefix isolation, development mode enforcement
4. **Read/Write Separation Tests**: Connection routing, replica selection, routing scopes

#### Provider Coverage

| Feature | SQLite | SQL Server | PostgreSQL | MySQL | MongoDB |
|---------|--------|------------|------------|-------|---------|
| Repository | ✅ | ✅ | ✅ | ✅ | ✅ |
| Tenancy | ✅ | ✅ | ✅ | ✅ | ✅ |
| Module Isolation | ✅ | ✅ | ✅ | ⏸️* | N/A |
| Read/Write Separation | ✅ | ✅ | ✅ | ⏸️* | N/A |

*MySQL EF Core tests are skipped until Pomelo.EntityFrameworkCore.MySql v10.0.0 is released

#### Files Created

**ADO.NET Integration Tests**:

- `tests/Encina.IntegrationTests/ADO/{Provider}/Repository/` - 4 providers
- `tests/Encina.IntegrationTests/ADO/{Provider}/Tenancy/` - 4 providers
- `tests/Encina.IntegrationTests/ADO/{Provider}/ModuleIsolation/` - 4 providers
- `tests/Encina.IntegrationTests/ADO/{Provider}/ReadWriteSeparation/` - 4 providers

**Dapper Integration Tests**:

- `tests/Encina.IntegrationTests/Dapper/{Provider}/Repository/` - 4 providers
- `tests/Encina.IntegrationTests/Dapper/{Provider}/Tenancy/` - 4 providers
- `tests/Encina.IntegrationTests/Dapper/{Provider}/ModuleIsolation/` - 4 providers
- `tests/Encina.IntegrationTests/Dapper/{Provider}/ReadWriteSeparation/` - 4 providers

**EF Core Integration Tests**:

- `tests/Encina.IntegrationTests/Infrastructure/EntityFrameworkCore/{Provider}/Tenancy/` - 4 providers
- `tests/Encina.IntegrationTests/Infrastructure/EntityFrameworkCore/{Provider}/ModuleIsolation/` - 4 providers
- `tests/Encina.IntegrationTests/Infrastructure/EntityFrameworkCore/{Provider}/ReadWriteSeparation/` - 4 providers
- `tests/Encina.IntegrationTests/Infrastructure/EntityFrameworkCore/Tenancy/TenantTestDbContext.cs`

**MongoDB Integration Tests**:

- `tests/Encina.IntegrationTests/Infrastructure/MongoDB/Tenancy/TenantAwareRepositoryMongoDBIntegrationTests.cs`

**Test Infrastructure Updates**:

- `tests/Encina.TestInfrastructure/Fixtures/EntityFrameworkCore/IEFCoreFixture.cs` - Added `IsAvailable` property
- `tests/Encina.TestInfrastructure/Fixtures/EntityFrameworkCore/EFCore{Provider}Fixture.cs` - Implemented `IsAvailable`

#### Files Deleted

23 justification `.md` files removed (replaced by real tests):

- `tests/Encina.IntegrationTests/ADO/{Provider}/Repository.md` - 4 files
- `tests/Encina.IntegrationTests/ADO/{Provider}/Tenancy.md` - 4 files
- `tests/Encina.IntegrationTests/Dapper/{Provider}/Repository.md` - 4 files
- `tests/Encina.IntegrationTests/Dapper/{Provider}/Tenancy.md` - 4 files
- `tests/Encina.IntegrationTests/Infrastructure/EntityFrameworkCore/Repository.md`
- `tests/Encina.IntegrationTests/Infrastructure/EntityFrameworkCore/Tenancy.md`
- `tests/Encina.IntegrationTests/Infrastructure/MongoDB/Repository.md`
- `tests/Encina.IntegrationTests/Database/ModuleIsolation.md`
- `tests/Encina.IntegrationTests/Database/ReadWriteSeparation.md`
- `tests/Encina.IntegrationTests/Database/Specification.md`
- `tests/Encina.IntegrationTests/Database/UnitOfWork.md`

#### Key Implementation Details

1. **Testcontainers Integration**: All tests use Docker containers for real database instances
2. **Provider-specific SQL**: Tests verify provider-specific SQL syntax (parameter styles, schema support)
3. **BSON Serialization**: MongoDB tests use `[BsonGuidRepresentation(GuidRepresentation.Standard)]` for GUID handling
4. **Shared In-Memory SQLite**: EF Core SQLite tests use `Mode=Memory;Cache=Shared` for connection pooling

---

### January 27 - Database Load Testing Infrastructure (#538)

**Issue**: [#538 - Implement LoadTests for concurrent database features](https://github.com/dlrivada/Encina/issues/538)

Implemented comprehensive NBomber load testing infrastructure for database features, enabling performance validation under concurrent load conditions.

#### Phase 1: Infrastructure and Project Setup

**Dependencies Added** (`tests/Encina.NBomber/Encina.NBomber.csproj`):

- Testcontainers packages for all database providers
- Database client libraries (SqlClient, Npgsql, MySqlConnector, MongoDB.Driver)
- EF Core provider packages
- Project references to TestInfrastructure

**Provider Abstraction Layer**:

- `IDatabaseProviderFactory` - Common interface for all providers
- `DatabaseProviderFactoryBase` - Base implementation with initialization lifecycle
- `DatabaseProviderRegistry` - Maps provider names to factory types
- Provider implementations for all 13 providers

**CLI Options Extended**:

- `--provider` argument for selecting database providers
- `--feature` argument for selecting feature scenarios (UoW, Tenancy, ReadWrite, All)

#### Phase 2: Feature Load Test Implementation

**Unit of Work Scenarios** (`UnitOfWorkScenarioFactory.cs`):

| Scenario | Rate | Duration | Description |
|----------|------|----------|-------------|
| `uow-concurrent-transactions` | 100/sec | 1 min | Multiple transactions simultaneously |
| `uow-rollback-under-load` | 50/sec | 1 min | Rollbacks under concurrency |
| `uow-connection-pool-pressure` | 200/sec | 2 min | Pool exhaustion behavior |

**Multi-Tenancy Scenarios** (`TenancyScenarioFactory.cs`):

| Scenario | Rate | Duration | Description |
|----------|------|----------|-------------|
| `tenancy-isolation` | 50 concurrent | 2 min | Tenant data isolation (100 tenants) |
| `tenancy-context-switching` | 100/sec | 1 min | Rapid context switches |

**Read/Write Separation Scenarios** (`ReadWriteSeparationScenarioFactory.cs`):

| Scenario | Rate | Duration | Description |
|----------|------|----------|-------------|
| `readwrite-replica-distribution` | 150/sec | 1 min | Distribution across replicas |
| `readwrite-roundrobin-validation` | 100/sec | 1 min | Round-robin validation |
| `readwrite-leastconnections-validation` | 75/sec | 1 min | Least-connections algorithm |

#### Phase 3: CI/CD and Configuration

**Profile Configurations** (`tests/Encina.LoadTests/profiles/`):

- `nbomber.database-uow.json` - UoW profile with 45s warmup
- `nbomber.database-tenancy.json` - Tenancy profile with 100 tenants
- `nbomber.database-readwrite.json` - Read/Write profile with 3 replicas

**Threshold Configuration** (`ci/nbomber-database-thresholds.json`):

- Global: 500+ ops/sec, <50ms mean, <200ms P95, <1% error rate
- Feature-specific thresholds (UoW: 75ms, Tenancy: 40ms, ReadWrite: 30ms)
- Provider-specific thresholds (SQLite fastest, SQL Server moderate)
- Scenario-specific requirements (tenancy-isolation: 100% success)

**CI/CD Workflow** (`.github/workflows/load-tests.yml`):

- New `run-database-load-tests` job
- Service containers: SQL Server, PostgreSQL, MySQL, MongoDB
- Matrix strategy for multiple providers
- Runs on schedule (Saturday 2 AM) or manual dispatch

#### Phase 4: Documentation and Cleanup

**Files Deleted**:

- `tests/Encina.LoadTests/UnitOfWork.md` - Replaced by real load tests
- `tests/Encina.LoadTests/Tenancy.md` - Replaced by real load tests
- `tests/Encina.LoadTests/ReadWriteSeparation.md` - Replaced by real load tests

**Documentation Created**:

- `docs/testing/load-test-baselines.md` - Performance baseline documentation
- `tests/Encina.NBomber/README.md` - Execution instructions

**Related Issue**: [#538](https://github.com/dlrivada/Encina/issues/538)

---

### January 28 - EntityFrameworkCore BenchmarkDotNet Tests (#564)

**Issue**: [#564 - Implement BenchmarkTests for Encina.EntityFrameworkCore data access](https://github.com/dlrivada/Encina/issues/564)

Implemented comprehensive BenchmarkDotNet micro-benchmarks for all Encina.EntityFrameworkCore data access components, measuring hot path performance and abstraction overhead.

#### Phase 1: Infrastructure and Shared Components

**Files Created**:

- `tests/Encina.BenchmarkTests/Encina.Benchmarks/EntityFrameworkCore/Infrastructure/BenchmarkEntity.cs` - Test entity implementing `IEntity<Guid>`
- `tests/Encina.BenchmarkTests/Encina.Benchmarks/EntityFrameworkCore/Infrastructure/EntityFrameworkBenchmarkDbContext.cs` - DbContext with InMemory/SQLite factory methods
- `tests/Encina.BenchmarkTests/Encina.Benchmarks/EntityFrameworkCore/Infrastructure/TestData.cs` - Factory methods for test data generation

**Package References Added** (`Encina.Benchmarks.csproj`):

- `Microsoft.EntityFrameworkCore.InMemory` for pure CPU benchmarks
- `Encina.DomainModeling` project reference

#### Phase 2: Hot Path Benchmarks

**Files Created**:

- `tests/Encina.BenchmarkTests/Encina.Benchmarks/EntityFrameworkCore/TransactionBehaviorBenchmarks.cs` - 10 benchmarks for TransactionPipelineBehavior
- `tests/Encina.BenchmarkTests/Encina.Benchmarks/EntityFrameworkCore/SpecificationEvaluatorBenchmarks.cs` - 14 benchmarks for SpecificationEvaluator

**Key Benchmarks**:

| Category | Benchmark | Target |
|----------|-----------|--------|
| Transaction | Non-transactional passthrough | <1μs |
| Transaction | Interface detection | <100ns |
| Transaction | Attribute detection | <1μs |
| Specification | Simple predicate | <100ns |
| Specification | Complex predicates (2,5,10) | Parameterized |
| Specification | Keyset pagination | 1-5μs |
| Specification | Full specification | <10μs |

#### Phase 3: Repository Pattern Benchmarks

**Files Created**:

- `tests/Encina.BenchmarkTests/Encina.Benchmarks/EntityFrameworkCore/FunctionalRepositoryBenchmarks.cs` - 11 benchmarks for CRUD operations
- `tests/Encina.BenchmarkTests/Encina.Benchmarks/EntityFrameworkCore/UnitOfWorkBenchmarks.cs` - 12 benchmarks for UoW coordination
- `tests/Encina.BenchmarkTests/Encina.Benchmarks/EntityFrameworkCore/UnitOfWorkRepositoryBenchmarks.cs` - 12 benchmarks for tracking patterns

**Key Benchmarks**:

| Category | Benchmark | Parameters |
|----------|-----------|------------|
| Repository | GetByIdAsync (cache hit/miss) | - |
| Repository | AddRangeAsync batch | [10, 100, 1000] |
| Repository | DeleteRangeAsync bulk | [10, 100, 1000] |
| UoW | Repository cache hit/miss | - |
| UoW | SaveChangesAsync | [1, 10, 100] tracked |
| UoW Repository | Deferred vs immediate | [1, 10, 100, 1000] |

#### Phase 4: Bulk Operations and Provider Detection

**Files Created**:

- `tests/Encina.BenchmarkTests/Encina.Benchmarks/EntityFrameworkCore/BulkOperationsBenchmarks.cs` - 14 benchmarks for bulk operations

**Key Benchmarks**:

| Category | Benchmark | Parameters |
|----------|-----------|------------|
| Factory | BulkOperationsEF.Create<T>() | - |
| Connection | GetDbConnection retrieval | - |
| Provider | Connection type pattern matching | - |
| Bulk Insert | SQLite bulk insert | [100, 1000] |
| Comparison | Cached vs uncached | [100, 1000] |
| Baseline | AddRangeAsync + SaveChanges | [100, 1000] |

#### Phase 5: Documentation and Integration

**Files Created**:

- `tests/Encina.BenchmarkTests/Encina.Benchmarks/EntityFrameworkCore/README.md` - Comprehensive benchmark documentation

**Documentation Updated**:

- `docs/INVENTORY.md` - Added Section 14: BenchmarkDotNet Micro-Benchmarks
- `docs/testing/benchmarks/benchmark-results.md` - Section 11 with ACTUAL results
- `docs/history/2026-01.md` - This entry
- `CHANGELOG.md` - Added EntityFrameworkCore benchmarks entry

#### Critical Fix: BenchmarkSwitcher for Command-Line Filtering

**Problem Identified**: The `--filter` command-line argument was being ignored because `Program.cs` used individual `BenchmarkRunner.Run<T>()` calls instead of `BenchmarkSwitcher`.

**Solution Applied** (`MediatorBenchmarks.cs`):

Changed from:
```csharp
public static void Main(string[] _)
{
    var config = DefaultConfig.Instance...
    BenchmarkRunner.Run<EncinaBenchmarks>(config);
    BenchmarkRunner.Run<DelegateInvocationBenchmarks>(config);
    // ... 15+ more Run<T>() calls
}
```

To:
```csharp
public static void Main(string[] args)
{
    var config = DefaultConfig.Instance...
    BenchmarkSwitcher
        .FromAssembly(typeof(Program).Assembly)
        .Run(args, config);
}
```

This enables proper `--filter` support across all benchmark classes.

#### Actual Benchmark Results

**Key Performance Findings**:

| Category | Finding |
|----------|---------|
| Transaction detection | Interface check is ~0 ns (JIT optimized) |
| Specification pattern | ~10% overhead vs direct LINQ |
| Repository overhead | ~5% over direct DbSet |
| AsNoTracking queries | 50% faster than tracked |
| Repository caching | 53% faster on cache hit |
| BulkInsert (100 entities) | 5.6x faster than AddRange |

**Summary**:

| Metric | Value |
|--------|-------|
| Total Benchmarks | 70 |
| Benchmark Classes | 6 |
| Infrastructure Files | 3 |
| Documentation Files | 2 |
| Results Documented | ✅ |

**Running Benchmarks**:

```bash
cd tests/Encina.BenchmarkTests/Encina.Benchmarks

# List all benchmarks
dotnet run -c Release -- --list flat --filter "*EntityFrameworkCore*"

# Run with short job
dotnet run -c Release -- --filter "*EntityFrameworkCore*" --job short
```

**Related Issue**: [#564](https://github.com/dlrivada/Encina/issues/564)

---

Last Updated: 2026-01-28
