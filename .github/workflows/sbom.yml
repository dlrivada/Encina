name: SBOM

on:
    push:
        tags: ["v*"]
    workflow_dispatch:

permissions:
    contents: write
    id-token: write

jobs:
    generate:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET SDK
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 10.0.x

            - name: Restore dependencies
              run: dotnet restore Encina.slnx

            - name: Generate SBOM
              run: dotnet publish src/Encina/Encina.csproj --configuration Release --output artifacts/package

            - name: Create output directory
              run: mkdir -p artifacts/sbom

            - name: Create SBOM with Syft
              uses: anchore/sbom-action@e8d2a6937ecead383dfe75190d104edd1f9c5751 # v0.16.0
              with:
                  path: artifacts/package
                  format: spdx-json
                  output-file: artifacts/sbom/sbom.spdx.json

            - name: Upload SBOM artifact
              uses: actions/upload-artifact@v6
              with:
                  name: sbom
                  path: artifacts/sbom/sbom.spdx.json
