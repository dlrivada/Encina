name: SBOM

on:
    push:
        tags: ["v*"]
    workflow_dispatch:

permissions:
    contents: write
    id-token: write

jobs:
    generate:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup .NET SDK
              uses: actions/setup-dotnet@v5
              with:
                  dotnet-version: 10.0.x

            - name: Restore dependencies
              run: dotnet restore Encina.slnx

            - name: Generate SBOM
              run: dotnet publish src/Encina/Encina.csproj --configuration Release --output artifacts/package

            - name: Create output directory
              run: mkdir -p artifacts/sbom

            - name: Create SBOM with Syft
              uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0.21.1
              with:
                  path: artifacts/package
                  format: spdx-json
                  output-file: artifacts/sbom/sbom.spdx.json

            - name: Upload SBOM artifact
              uses: actions/upload-artifact@v6
              with:
                  name: sbom
                  path: artifacts/sbom/sbom.spdx.json
