name: .NET Quality Gate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      runBenchmarks:
        description: "Run benchmarks as part of the quality gate"
        required: false
        default: "false"

permissions:
  contents: read

jobs:
  quality:
    runs-on: windows-latest
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      DOTNET_NOLOGO: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore
        run: dotnet restore Encina.slnx

      - name: Enforce formatting
        run: dotnet format Encina.slnx --verify-no-changes

      - name: Build with analyzers
        run: dotnet build Encina.slnx --configuration Release --no-restore -warnaserror

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Test with coverage
        # Exclude tests that require special infrastructure or are non-deterministic:
        # - LoadTests: Require NBomber load testing infrastructure
        # - IntegrationTests: Require Docker containers or external services
        # - ContractTests: Skipped tests pending investigation (Issue #7)
        # - PropertyTests: Skipped tests pending investigation (Issue #7)
        run: dotnet test Encina.slnx --configuration Release --no-build --collect "XPlat Code Coverage" --results-directory artifacts/test-results --verbosity normal --filter "FullyQualifiedName!~LoadTests&FullyQualifiedName!~IntegrationTests&FullyQualifiedName!~ContractTests&FullyQualifiedName!~PropertyTests"

      - name: Generate coverage report
        run: dotnet tool run reportgenerator -reports:"artifacts/test-results/**/coverage.cobertura.xml" -targetdir:"artifacts/coverage" -reporttypes:"Html;HtmlSummary;TextSummary;JsonSummary"

      - name: Enforce coverage threshold
        shell: pwsh
        env:
          COVERAGE_THRESHOLD: ${{ env.COVERAGE_THRESHOLD != '' && env.COVERAGE_THRESHOLD || '90.0' }}
        run: |
          $threshold = [double]$env:COVERAGE_THRESHOLD
          $summaryFile = Get-ChildItem -Path "artifacts/coverage" -Filter "summary*.json" -File | Select-Object -First 1
          if (-not $summaryFile) { Write-Error "Coverage summary JSON not found"; exit 1 }
          $summary = Get-Content $summaryFile.FullName | ConvertFrom-Json
          $line = [double]$summary.coverage.line
          if ($line -lt $threshold) { Write-Error "Line coverage $line% is below threshold $threshold%"; exit 1 }
          Write-Host "Line coverage $line% meets threshold $threshold%."

      - name: Publish coverage summary
        run: |
          {
            echo '```';
            cat artifacts/coverage/Summary.txt;
            echo '```';
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: artifacts/coverage

      - name: Run benchmarks (optional)
        if: ${{ github.event.inputs.runBenchmarks == 'true' }}
        id: run-benchmarks
        run: dotnet run --file scripts/run-benchmarks.cs

      - name: Check benchmark guardrails (optional)
        if: ${{ github.event.inputs.runBenchmarks == 'true' && steps.run-benchmarks.outputs.benchmark-dir != '' }}
        run: dotnet run --file scripts/check-benchmarks.cs -- --directory "${{ steps.run-benchmarks.outputs.benchmark-dir }}"

      - name: Upload benchmark artifacts (optional)
        if: ${{ github.event.inputs.runBenchmarks == 'true' && steps.run-benchmarks.outputs.benchmark-dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-report
          path: ${{ steps.run-benchmarks.outputs.benchmark-dir }}
