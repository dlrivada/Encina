name: Mutation Tests

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Fridays at 3:00 AM UTC
    - cron: "0 3 * * 5"

permissions:
  contents: read

jobs:
  run-mutation-tests:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      DOTNET_NOLOGO: true
      DOTNET_SDK_VERSION: '10.0.x'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_SDK_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: |
            ~/.nuget/packages
            %USERPROFILE%\.nuget\packages
          key: ${{ runner.os }}-nuget-${{ env.DOTNET_SDK_VERSION }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-${{ env.DOTNET_SDK_VERSION }}
            ${{ runner.os }}-nuget

      - name: Cache dotnet tools
        uses: actions/cache@v5
        with:
          path: |
            ~/.dotnet/tools
            %USERPROFILE%\.dotnet\tools
          key: ${{ runner.os }}-dotnet-tools-${{ env.DOTNET_SDK_VERSION }}
          restore-keys: |
            ${{ runner.os }}-dotnet-tools-${{ env.DOTNET_SDK_VERSION }}
            ${{ runner.os }}-dotnet-tools

      - name: Restore
        run: dotnet restore Encina.slnx

      - name: Build
        run: dotnet build Encina.slnx --configuration Release --no-restore

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Run mutation tests
        run: dotnet run --file scripts/run-stryker.cs

      - name: Summarize mutation results
        run: |
          output=$(dotnet run --file scripts/update-mutation-summary.cs)
          echo "$output"
          {
            echo '### Mutation Summary';
            echo '```';
            echo "$output";
            echo '```';
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Locate mutation report
        id: stryker-report
        run: |
          # Stryker creates reports directly in artifacts/mutation/reports/
          # or in artifacts/mutation/{timestamp}/reports/
          if [ -f "artifacts/mutation/reports/mutation-report.json" ]; then
            echo "reports-dir=artifacts/mutation/reports" >> "$GITHUB_OUTPUT"
            echo "summary-file=artifacts/mutation/reports/mutation-report.txt" >> "$GITHUB_OUTPUT"
          else
            # Look for timestamped subdirectory
            latest=$(ls -d artifacts/mutation/*/ 2>/dev/null | grep -v reports | sort | tail -n 1)
            if [ -n "$latest" ] && [ -f "${latest}reports/mutation-report.json" ]; then
              echo "reports-dir=${latest}reports" >> "$GITHUB_OUTPUT"
              echo "summary-file=${latest}reports/mutation-report.txt" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Publish Stryker text summary
        if: steps.stryker-report.outputs.summary-file != ''
        run: |
          summary_file="${{ steps.stryker-report.outputs.summary-file }}"
          if [ -f "$summary_file" ]; then
            {
              echo '### Mutation Report (Stryker Text)';
              echo '```';
              cat "$summary_file";
              echo '```';
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Warning: Summary file not found at $summary_file"
          fi

      - name: Upload mutation report artifact
        if: steps.stryker-report.outputs.reports-dir != ''
        uses: actions/upload-artifact@v6
        with:
          name: mutation-report
          path: ${{ steps.stryker-report.outputs.reports-dir }}
