name: SonarCloud Analysis

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  sonarcloud:
    name: SonarCloud Code Quality
    runs-on: ubuntu-latest

    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      DOTNET_NOLOGO: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis relevance

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Restore dependencies
        run: dotnet restore Encina.slnx

      - name: SonarCloud Scan
        uses: highbyte/sonarscan-dotnet@252f699a9c4e005bf3902d44a1c6c0aea43c678e # v2.5.0
        with:
          sonarProjectKey: dlrivada_Encina
          sonarProjectName: Encina
          sonarOrganization: dlrivada
          dotnetBuildArguments: Encina.slnx --configuration Release
          # Exclude tests that require special infrastructure:
          # - LoadTests: Stress testing, not suitable for CI
          # - IntegrationTests: Require Docker/Testcontainers
          dotnetTestArguments: Encina.slnx --configuration Release --no-build --collect "XPlat Code Coverage" --results-directory artifacts/test-results --filter "FullyQualifiedName!~LoadTests&FullyQualifiedName!~IntegrationTests" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
          # XPlat Code Coverage generates coverage.opencover.xml in a GUID subdirectory
          # Note: sonar.sources and sonar.tests are NOT supported by Scanner for .NET (auto-computed)
          # CPD exclusions for intentional duplication (Issue #12):
          # - SQL scripts: dialect-specific DDL (TOP vs LIMIT, GETUTCDATE vs NOW, etc.)
          # - Store implementations: SQL dialect differences
          # - Entities, Factories, Behaviors: Provider-specific implementations with similar patterns
          # - Log.cs: High-perf logging (will be consolidated in future refactoring)
          # - ServiceCollectionExtensions: DI registration with provider-specific types
          # Security Hotspot S2077 (SQL Injection) suppression for store files:
          # All store files use SqlIdentifierValidator.ValidateTableName() which validates table names
          # against a safe regex pattern, preventing SQL injection. Only parameterized queries are used
          # for data values. See: src/Encina.Messaging/SqlIdentifierValidator.cs
          # S1523 (RCE) suppression for SQL scripts:
          # These are static DDL scripts executed manually by DBAs. No dynamic code injection.
          # EXECUTE IMMEDIATE in Oracle scripts uses only literal strings.
          sonarBeginArguments: >-
            /d:sonar.cs.opencover.reportsPaths="artifacts/test-results/**/coverage.opencover.xml"
            /d:sonar.cpd.exclusions="src/Encina.Dapper.*/**/*.cs,src/Encina.Dapper.*/Scripts/*.sql,src/Encina.ADO.*/**/*.cs,src/Encina.ADO.*/Scripts/*.sql"
            /d:sonar.issue.ignore.multicriteria=e1,e2,e3
            /d:sonar.issue.ignore.multicriteria.e1.ruleKey=csharpsquid:S2077
            /d:sonar.issue.ignore.multicriteria.e1.resourceKey=src/Encina.Dapper.*/**/*Store*.cs
            /d:sonar.issue.ignore.multicriteria.e2.ruleKey=csharpsquid:S2077
            /d:sonar.issue.ignore.multicriteria.e2.resourceKey=src/Encina.ADO.*/**/*Store*.cs
            /d:sonar.issue.ignore.multicriteria.e3.ruleKey=plsql:S1523
            /d:sonar.issue.ignore.multicriteria.e3.resourceKey=src/**/Scripts/*.sql
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
