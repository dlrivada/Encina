-- PostgreSQL Permission Script for Module: Orders
-- Generated by Encina Module Isolation

-- Create schema: orders
CREATE SCHEMA IF NOT EXISTS "orders";
DO $$ BEGIN RAISE NOTICE 'Ensured schema exists: orders'; END $$;

-- Create role for module: Orders
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'orders_user') THEN
        CREATE ROLE "orders_user" WITH LOGIN PASSWORD '{{Orders_Password}}';
        RAISE NOTICE 'Created role: orders_user';
    ELSE
        RAISE NOTICE 'Role already exists: orders_user';
    END IF;
END $$;

-- Grant permissions for module: Orders

-- Full access to module schema: orders
GRANT USAGE ON SCHEMA "orders" TO "orders_user";
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA "orders" TO "orders_user";
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA "orders" TO "orders_user";
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA "orders" TO "orders_user";

-- Set default privileges for future tables in orders
ALTER DEFAULT PRIVILEGES IN SCHEMA "orders" GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO "orders_user";
ALTER DEFAULT PRIVILEGES IN SCHEMA "orders" GRANT EXECUTE ON FUNCTIONS TO "orders_user";
ALTER DEFAULT PRIVILEGES IN SCHEMA "orders" GRANT USAGE, SELECT ON SEQUENCES TO "orders_user";
DO $$ BEGIN RAISE NOTICE 'Granted full access on schema orders to orders_user'; END $$;

-- Read-only access to shared schema: lookup
GRANT USAGE ON SCHEMA "lookup" TO "orders_user";
GRANT SELECT ON ALL TABLES IN SCHEMA "lookup" TO "orders_user";
ALTER DEFAULT PRIVILEGES IN SCHEMA "lookup" GRANT SELECT ON TABLES TO "orders_user";
DO $$ BEGIN RAISE NOTICE 'Granted SELECT on schema lookup to orders_user'; END $$;
-- Read-only access to shared schema: shared
GRANT USAGE ON SCHEMA "shared" TO "orders_user";
GRANT SELECT ON ALL TABLES IN SCHEMA "shared" TO "orders_user";
ALTER DEFAULT PRIVILEGES IN SCHEMA "shared" GRANT SELECT ON TABLES TO "orders_user";
DO $$ BEGIN RAISE NOTICE 'Granted SELECT on schema shared to orders_user'; END $$;

-- Read-only access to additional schema: audit
GRANT USAGE ON SCHEMA "audit" TO "orders_user";
GRANT SELECT ON ALL TABLES IN SCHEMA "audit" TO "orders_user";
ALTER DEFAULT PRIVILEGES IN SCHEMA "audit" GRANT SELECT ON TABLES TO "orders_user";
DO $$ BEGIN RAISE NOTICE 'Granted SELECT on schema audit to orders_user'; END $$;

DO $$ BEGIN RAISE NOTICE 'Module Orders permissions configured successfully.'; END $$;
